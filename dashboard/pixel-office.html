<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ Pixel Office | Mission Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-card: #0f3460;
            --panel-border: #e94560;
            --panel-shadow: #533483;
            --text-light: #f5e6c8;
            --text-secondary: #a0a0a0;
            --accent-cyan: #00d4ff;
            --accent-green: #51cf66;
            --accent-yellow: #fcc419;
            --accent-pink: #ff6b9d;
            --accent-orange: #f97316;
            --accent-purple: #a855f7;
            --accent-red: #ef4444;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; image-rendering: pixelated; }
        
        body {
            font-family: 'VT323', monospace;
            background: var(--bg-primary);
            color: var(--text-light);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .header {
            background: var(--bg-secondary);
            border-bottom: 4px solid var(--panel-border);
            padding: 0 1rem;
            min-height: 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .brand { display: flex; align-items: center; gap: 0.75rem; }
        
        .logo {
            width: 40px; height: 40px;
            background: var(--panel-border);
            border: 3px solid var(--text-light);
            border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.25rem;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(233, 69, 96, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(233, 69, 96, 0); }
        }
        
        .brand-text h1 {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.7rem;
            color: var(--text-light);
        }
        
        .brand-text span {
            font-size: 0.8rem;
            color: var(--accent-cyan);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px;
        }
        
        .office-wrapper {
            position: relative;
            background: var(--bg-card);
            border: 4px solid var(--panel-border);
            border-radius: 8px;
            overflow: hidden;
        }
        
        #officeCanvas {
            width: 100%;
            height: 600px;
            background: linear-gradient(135deg, #2d3436 0%, #1a1a2e 100%);
            cursor: grab;
            display: block;
        }
        
        #officeCanvas:active { cursor: grabbing; }
        
        .controls {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            z-index: 10;
        }
        
        .btn {
            padding: 8px 14px;
            background: var(--bg-secondary);
            border: 3px solid var(--panel-border);
            border-radius: 6px;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.5rem;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.1s;
        }
        
        .btn:hover { 
            transform: translateY(-2px);
            box-shadow: 0 4px 0 var(--panel-shadow);
        }
        
        .btn-primary { background: var(--accent-green); border-color: var(--accent-green); color: #000; }
        .btn-warning { background: var(--accent-yellow); border-color: var(--accent-yellow); color: #000; }
        .btn-danger { background: var(--accent-red); border-color: var(--accent-red); color: #fff; }
        
        .stats-bar {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            padding: 10px 15px;
            border-radius: 8px;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.5rem;
            z-index: 10;
            border: 2px solid var(--panel-border);
        }
        
        .stats-bar div { margin-bottom: 4px; }
        .stats-bar span { color: var(--accent-cyan); }
        
        .info-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .panel {
            background: var(--bg-card);
            border: 4px solid var(--panel-border);
            border-radius: 8px;
            padding: 15px;
        }
        
        .panel-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.6rem;
            color: var(--accent-cyan);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--panel-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .agent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .agent-mini {
            background: var(--bg-secondary);
            border: 2px solid var(--panel-border);
            border-radius: 6px;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .agent-mini:hover {
            transform: scale(1.05);
            border-color: var(--accent-cyan);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }
        
        .agent-mini.selected {
            border-color: var(--accent-green);
            background: rgba(81, 207, 102, 0.2);
        }
        
        .agent-mini-canvas {
            width: 32px;
            height: 32px;
            margin: 0 auto;
            image-rendering: pixelated;
        }
        
        .agent-mini-name { 
            font-size: 0.6rem; 
            margin-top: 4px;
            font-family: 'Press Start 2P', cursive;
        }
        
        .agent-mini-role {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }
        
        .agent-mini-status {
            font-size: 0.5rem;
            padding: 2px 4px;
            border-radius: 3px;
            margin-top: 4px;
            display: inline-block;
        }
        
        .status-idle { background: #666; }
        .status-working { background: var(--accent-green); color: #000; }
        .status-walking { background: var(--accent-yellow); color: #000; }
        .status-meeting { background: var(--accent-purple); color: #fff; }
        .status-alert { background: var(--accent-red); color: #fff; }
        .status-sleep { background: #4a5568; }
        .status-celebrate { background: var(--accent-pink); color: #000; }
        
        .activity-list { 
            max-height: 200px; 
            overflow-y: auto; 
            font-size: 0.9rem; 
        }
        
        .activity-item {
            padding: 8px;
            margin-bottom: 5px;
            background: var(--bg-secondary);
            border-left: 3px solid var(--accent-cyan);
            border-radius: 0 4px 4px 0;
            font-size: 0.8rem;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .activity-time { 
            font-size: 0.6rem; 
            color: var(--text-secondary);
            font-family: 'Press Start 2P', cursive;
        }
        
        /* Agent Detail Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-overlay.active { display: flex; }
        
        .agent-modal {
            background: var(--bg-card);
            border: 4px solid var(--panel-border);
            border-radius: 12px;
            padding: 20px;
            max-width: 400px;
            width: 90%;
            animation: modalPop 0.3s ease-out;
        }
        
        @keyframes modalPop {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--panel-border);
        }
        
        .modal-avatar {
            width: 64px;
            height: 64px;
            border: 3px solid var(--panel-border);
            border-radius: 8px;
            background: var(--bg-secondary);
        }
        
        .modal-title h2 {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.9rem;
            color: var(--accent-cyan);
            margin-bottom: 5px;
        }
        
        .modal-title span {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .modal-body {
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        .modal-stat {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .modal-stat:last-child { border-bottom: none; }
        
        .modal-stat-label { color: var(--text-secondary); }
        .modal-stat-value { color: var(--accent-cyan); }
        
        .modal-close {
            margin-top: 15px;
            width: 100%;
        }
        
        /* Tooltip */
        .agent-tooltip {
            position: absolute;
            background: rgba(0,0,0,0.9);
            border: 2px solid var(--accent-cyan);
            border-radius: 8px;
            padding: 12px;
            pointer-events: none;
            z-index: 1000;
            display: none;
            min-width: 180px;
        }
        
        .tooltip-name {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.6rem;
            color: var(--accent-cyan);
            margin-bottom: 6px;
        }
        
        .tooltip-task {
            font-size: 0.8rem;
            color: var(--text-light);
        }
        
        .tooltip-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.6rem;
            margin-top: 6px;
            font-family: 'Press Start 2P', cursive;
        }
        
        /* Legend */
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.7rem;
        }
        
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        @media (max-width: 768px) {
            #officeCanvas { height: 400px; }
            .info-panel { grid-template-columns: 1fr; }
            .controls { position: relative; padding: 10px; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="brand">
            <div class="logo">üéÆ</div>
            <div class="brand-text">
                <h1>PIXEL OFFICE</h1>
                <span>22 Agents ‚Ä¢ 7 Animations ‚Ä¢ Live Status</span>
            </div>
        </div>
    </header>
    
    <div class="container">
        <div class="office-wrapper">
            <div class="controls">
                <button class="btn btn-primary" onclick="startSimulation()">‚ñ∂ START</button>
                <button class="btn" onclick="resetCamera()">üîÑ RESET</button>
                <button class="btn" onclick="toggleDebug()">üêõ DEBUG</button>
                <button class="btn btn-warning" onclick="triggerAlert()">üö® ALERT</button>
                <button class="btn btn-danger" onclick="triggerCelebrate()">üéâ PARTY</button>
            </div>
            
            <div class="stats-bar">
                <div>FPS: <span id="fpsCounter">60</span></div>
                <div>AGENTS: <span id="agentCounter">22</span></div>
                <div>STATUS: <span id="statusIndicator">ONLINE</span></div>
            </div>
            
            <canvas id="officeCanvas"></canvas>
            
            <div class="agent-tooltip" id="tooltip">
                <div class="tooltip-name" id="tooltipName">Agent Name</div>
                <div class="tooltip-task" id="tooltipTask">Current Task</div>
                <span class="tooltip-status" id="tooltipStatus">Idle</span>
            </div>
        </div>
        
        <div class="info-panel">
            <div class="panel">
                <div class="panel-title">
                    üë• AGENT ROSTER
                    <span style="font-size:0.5rem;color:var(--text-secondary)">Click for details</span>
                </div>
                <div class="agent-grid" id="agentGrid"></div>
            </div>
            
            <div class="panel">
                <div class="panel-title">üì° LIVE ACTIVITY</div>
                <div class="activity-list" id="activityLog"></div>
            </div>
            
            <div class="panel">
                <div class="panel-title">‚ÑπÔ∏è CONTROLS & LEGEND</div>
                <div style="font-size:0.85rem;line-height:1.6;margin-bottom:10px">
                    <p>üñ±Ô∏è <strong>Drag</strong> to pan camera</p>
                    <p>üîç <strong>Scroll</strong> to zoom</p>
                    <p>üëÜ <strong>Hover</strong> agents for info</p>
                    <p>üéÆ <strong>Click</strong> agents to select</p>
                </div>
                <div class="legend">
                    <div class="legend-item"><span class="legend-dot" style="background:#666"></span> Idle</div>
                    <div class="legend-item"><span class="legend-dot" style="background:var(--accent-green)"></span> Working</div>
                    <div class="legend-item"><span class="legend-dot" style="background:var(--accent-yellow)"></span> Walking</div>
                    <div class="legend-item"><span class="legend-dot" style="background:var(--accent-purple)"></span> Meeting</div>
                    <div class="legend-item"><span class="legend-dot" style="background:var(--accent-red)"></span> Alert</div>
                    <div class="legend-item"><span class="legend-dot" style="background:#4a5568"></span> Sleep</div>
                    <div class="legend-item"><span class="legend-dot" style="background:var(--accent-pink)"></span> Celebrate</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Agent Detail Modal -->
    <div class="modal-overlay" id="agentModal">
        <div class="agent-modal">
            <div class="modal-header">
                <canvas class="modal-avatar" id="modalAvatar" width="64" height="64"></canvas>
                <div class="modal-title">
                    <h2 id="modalName">Agent Name</h2>
                    <span id="modalRole">Role</span>
                </div>
            </div>
            <div class="modal-body">
                <div class="modal-stat">
                    <span class="modal-stat-label">Status:</span>
                    <span class="modal-stat-value" id="modalStatus">Idle</span>
                </div>
                <div class="modal-stat">
                    <span class="modal-stat-label">Current Task:</span>
                    <span class="modal-stat-value" id="modalTask">None</span>
                </div>
                <div class="modal-stat">
                    <span class="modal-stat-label">Animation:</span>
                    <span class="modal-stat-value" id="modalAnimation">idle</span>
                </div>
                <div class="modal-stat">
                    <span class="modal-stat-label">Location:</span>
                    <span class="modal-stat-value" id="modalLocation">0, 0</span>
                </div>
                <div class="modal-stat">
                    <span class="modal-stat-label">Tasks Completed:</span>
                    <span class="modal-stat-value" id="modalTasksCompleted">0</span>
                </div>
            </div>
            <button class="btn btn-primary modal-close" onclick="closeModal()">CLOSE</button>
        </div>
    </div>

    <script>
        // ============================================
        // AGENT DATA - All 22 agents with tasks
        // ============================================
        const AGENTS_DATA = [
            { id: 'ericf', name: 'EricF', role: 'Commander', color: '#ffd700', x: -8, y: -6, task: 'Strategic Planning' },
            { id: 'nexus', name: 'Nexus', role: 'Orchestrator', color: '#00d4ff', x: 4, y: -6, task: 'System Coordination' },
            { id: 'codemaster', name: 'CodeMaster', role: 'Backend Lead', color: '#22c55e', x: -7, y: 2, task: 'API Architecture' },
            { id: 'code-1', name: 'Code-1', role: 'Backend', color: '#22c55e', x: -4, y: 2, task: 'Database Optimization' },
            { id: 'code-2', name: 'Code-2', role: 'Backend', color: '#22c55e', x: -7, y: 4.5, task: 'Microservices' },
            { id: 'code-3', name: 'Code-3', role: 'Backend', color: '#22c55e', x: -4, y: 4.5, task: 'Security Patches' },
            { id: 'forge', name: 'Forge', role: 'UI Lead', color: '#f97316', x: 3, y: -3, task: 'Component Library' },
            { id: 'forge-2', name: 'Forge-2', role: 'UI', color: '#f97316', x: 6, y: -3, task: 'Responsive Design' },
            { id: 'forge-3', name: 'Forge-3', role: 'UI', color: '#f97316', x: 3, y: -0.5, task: 'Animation System' },
            { id: 'pixel', name: 'Pixel', role: 'Designer', color: '#a855f7', x: 6, y: -0.5, task: 'Sprite Creation' },
            { id: 'glasses', name: 'Glasses', role: 'Researcher', color: '#3b82f6', x: 3, y: 2, task: 'Market Analysis' },
            { id: 'quill', name: 'Quill', role: 'Writer', color: '#ec4899', x: 6, y: 2, task: 'Documentation' },
            { id: 'gary', name: 'Gary', role: 'Marketing', color: '#f59e0b', x: -2, y: 6, task: 'Campaign Strategy' },
            { id: 'larry', name: 'Larry', role: 'Social', color: '#06b6d4', x: 1, y: 6, task: 'Community Management' },
            { id: 'buzz', name: 'Buzz', role: 'Social', color: '#fbbf24', x: 4, y: 6, task: 'Trend Analysis' },
            { id: 'sentry', name: 'Sentry', role: 'DevOps', color: '#ef4444', x: -5, y: 7, task: 'CI/CD Pipeline' },
            { id: 'audit', name: 'Audit', role: 'QA', color: '#8b5cf6', x: -2, y: 7, task: 'Code Review' },
            { id: 'cipher', name: 'Cipher', role: 'Security', color: '#6366f1', x: 1, y: 7, task: 'Threat Detection' },
            { id: 'dealflow', name: 'DealFlow', role: 'Lead Gen', color: '#10b981', x: 4, y: 7, task: 'Partnership Outreach' },
            { id: 'coldcall', name: 'ColdCall', role: 'Outreach', color: '#f97316', x: -6, y: 6, task: 'Cold Emails' },
            { id: 'scout', name: 'Scout', role: 'Intel', color: '#00d4ff', x: 7, y: 4, task: 'Competitor Research' },
            { id: 'pie', name: 'PIE', role: 'Intelligence', color: '#8b5cf6', x: 7, y: 6, task: 'Data Analytics' },
        ];

        // Tasks for animation
        const TASKS = [
            'Coding', 'Reviewing', 'Testing', 'Deploying',
            'Designing', 'Researching', 'Writing', 'Analyzing',
            'Meeting', 'Debugging', 'Optimizing', 'Planning'
        ];

        // ============================================
        // SPRITE LOADER - Loads 8-frame animations
        // ============================================
        class SpriteLoader {
            constructor(basePath = '../pixel-office/assets/sprites/') {
                this.basePath = basePath;
                this.sprites = new Map();
                this.metadata = null;
                this.loaded = false;
                this.furniture = new Map();
            }

            async load() {
                try {
                    const response = await fetch(`${this.basePath}sprite_metadata.json`);
                    this.metadata = await response.json();
                } catch (error) {
                    console.error('Failed to load metadata:', error);
                    // Use default metadata
                    this.metadata = {
                        sprite_size: 16,
                        frames_per_animation: 8,
                        animations: { idle: 0, walk_down: 1, walk_up: 2, walk_left: 3, walk_right: 4, typing: 5, talking: 6 },
                        agents: {}
                    };
                    AGENTS_DATA.forEach((agent, i) => {
                        this.metadata.agents[agent.id] = { name: agent.name, row: i };
                    });
                }

                // Load all agent sprites
                const loadPromises = AGENTS_DATA.map(agent => this.loadAgentSprite(agent.id));
                await Promise.all(loadPromises);
                
                // Load furniture sprites
                await this.loadFurniture();
                
                this.loaded = true;
            }

            loadAgentSprite(agentId) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        const agentMeta = this.metadata.agents[agentId];
                        this.sprites.set(agentId, {
                            image: img,
                            row: agentMeta ? agentMeta.row : 0
                        });
                        resolve();
                    };
                    img.onerror = () => {
                        // Create fallback colored square
                        const canvas = document.createElement('canvas');
                        canvas.width = 128; // 8 frames * 16px
                        canvas.height = 16;
                        const ctx = canvas.getContext('2d');
                        const agent = AGENTS_DATA.find(a => a.id === agentId);
                        ctx.fillStyle = agent ? agent.color : '#888';
                        ctx.fillRect(0, 0, 128, 16);
                        // Draw simple face
                        ctx.fillStyle = '#000';
                        for (let i = 0; i < 8; i++) {
                            ctx.fillRect(i * 16 + 4, 4, 2, 2);
                            ctx.fillRect(i * 16 + 10, 4, 2, 2);
                            ctx.fillRect(i * 16 + 5, 10, 6, 2);
                        }
                        const fallbackImg = new Image();
                        fallbackImg.src = canvas.toDataURL();
                        fallbackImg.onload = () => {
                            this.sprites.set(agentId, { image: fallbackImg, row: 0 });
                            resolve();
                        };
                    };
                    img.crossOrigin = 'anonymous';
                    img.src = `${this.basePath}${agentId}_sheet.png`;
                });
            }

            async loadFurniture() {
                const furnitureFiles = [
                    'furniture_desk', 'furniture_chair', 'furniture_computer',
                    'furniture_commander_desk', 'furniture_nexus', 'furniture_plant'
                ];
                
                for (const name of furnitureFiles) {
                    await new Promise((resolve) => {
                        const img = new Image();
                        img.onload = () => {
                            this.furniture.set(name, img);
                            resolve();
                        };
                        img.onerror = () => resolve();
                        img.crossOrigin = 'anonymous';
                        img.src = `${this.basePath}${name}.png`;
                    });
                }
            }

            getSprite(agentId, animation, frame) {
                const sprite = this.sprites.get(agentId);
                if (!sprite) return null;

                const animIndex = this.metadata.animations[animation] || 0;
                const framesPerAnim = this.metadata.frames_per_animation || 8;
                const spriteSize = this.metadata.sprite_size || 16;
                
                const x = (animIndex * framesPerAnim + (Math.floor(frame) % framesPerAnim)) * spriteSize;
                const y = sprite.row * spriteSize;

                return {
                    image: sprite.image,
                    sx: x,
                    sy: y,
                    sw: spriteSize,
                    sh: spriteSize
                };
            }

            getFurniture(name) {
                return this.furniture.get(name);
            }
        }

        // ============================================
        // AGENT CLASS - Individual animated agent
        // ============================================
        class Agent {
            constructor(data) {
                this.id = data.id;
                this.name = data.name;
                this.role = data.role;
                this.color = data.color;
                this.baseX = data.x;
                this.baseY = data.y;
                this.x = data.x;
                this.y = data.y;
                this.targetX = data.x;
                this.targetY = data.y;
                this.baseTask = data.task;
                this.currentTask = data.task;
                
                // Animation state
                this.animation = 'idle';
                this.frame = 0;
                this.frameTimer = 0;
                this.frameDuration = 120 + Math.random() * 60;
                
                // Movement
                this.speed = 1.5 + Math.random() * 1;
                this.direction = 'down';
                this.activity = 'idle';
                this.walkTimer = 0;
                this.idleTimer = 0;
                
                // Visual
                this.scale = 2;
                this.selected = false;
                this.hover = false;
                
                // Task progress
                this.progress = 0;
                this.tasksCompleted = 0;
                
                // Special states
                this.alertMode = false;
                this.sleepMode = false;
                this.celebrateMode = false;
                this.meetingMode = false;
            }

            update(dt) {
                // Animation frame advancement
                this.frameTimer += dt;
                if (this.frameTimer >= this.frameDuration) {
                    this.frameTimer = 0;
                    this.frame = (this.frame + 1) % 8;
                }

                // Handle special states
                if (this.sleepMode) {
                    this.animation = 'idle';
                    return;
                }
                
                if (this.celebrateMode) {
                    this.animation = 'talking';
                    return;
                }
                
                if (this.alertMode) {
                    this.animation = 'typing';
                    return;
                }

                // Activity state machine
                if (this.activity === 'idle') {
                    this.idleTimer += dt;
                    this.animation = 'idle';
                    
                    if (this.idleTimer > 3000 + Math.random() * 5000) {
                        this.startWalking();
                    }
                } else if (this.activity === 'walking') {
                    this.updateWalking(dt);
                } else if (this.activity === 'working') {
                    this.animation = this.meetingMode ? 'talking' : 'typing';
                    this.progress = (this.progress + dt * 0.0001) % 1;
                } else if (this.activity === 'meeting') {
                    this.animation = 'talking';
                }
            }

            startWalking() {
                const angle = Math.random() * Math.PI * 2;
                const distance = 2 + Math.random() * 4;
                this.targetX = this.baseX + Math.cos(angle) * distance;
                this.targetY = this.baseY + Math.sin(angle) * distance;
                
                this.targetX = Math.max(-10, Math.min(10, this.targetX));
                this.targetY = Math.max(-8, Math.min(8, this.targetY));
                
                this.activity = 'walking';
                
                const dx = this.targetX - this.x;
                const dy = this.targetY - this.y;
                if (Math.abs(dx) > Math.abs(dy)) {
                    this.direction = dx > 0 ? 'right' : 'left';
                } else {
                    this.direction = dy > 0 ? 'down' : 'up';
                }
            }

            updateWalking(dt) {
                const dx = this.targetX - this.x;
                const dy = this.targetY - this.y;
                const dist = Math.sqrt(dx * dx + dy * dy);

                if (dist < 0.2) {
                    this.x = this.targetX;
                    this.y = this.targetY;
                    this.activity = 'working';
                    this.currentTask = TASKS[Math.floor(Math.random() * TASKS.length)];
                    this.walkTimer = 0;
                    this.tasksCompleted++;
                } else {
                    const moveDist = this.speed * dt * 0.003;
                    this.x += (dx / dist) * moveDist;
                    this.y += (dy / dist) * moveDist;
                    this.animation = `walk_${this.direction}`;
                }
            }

            getScreenPos(isoMath, camera, canvas) {
                const pos = isoMath.toScreen(this.x, this.y, 0);
                return {
                    x: (pos.x - camera.x) * camera.zoom,
                    y: (pos.y - camera.y) * camera.zoom
                };
            }

            render(ctx, spriteLoader, isoMath, camera, canvas) {
                const screenPos = this.getScreenPos(isoMath, camera, canvas);
                const size = 32 * camera.zoom;
                
                // Draw shadow
                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.beginPath();
                ctx.ellipse(screenPos.x, screenPos.y + size * 0.3, size * 0.4, size * 0.15, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // Get sprite
                const sprite = spriteLoader.getSprite(this.id, this.animation, this.frame);
                if (sprite) {
                    ctx.drawImage(
                        sprite.image,
                        sprite.sx, sprite.sy, sprite.sw, sprite.sh,
                        screenPos.x - size / 2, screenPos.y - size, size, size
                    );
                }
                
                // Status indicator
                if (this.alertMode) {
                    ctx.fillStyle = 'rgba(239, 68, 68, 0.8)';
                    ctx.beginPath();
                    ctx.arc(screenPos.x + size/3, screenPos.y - size, 6 * camera.zoom, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                // Selection highlight
                if (this.selected || this.hover) {
                    ctx.strokeStyle = this.selected ? '#00d4ff' : '#fff';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(screenPos.x - size/2 - 2, screenPos.y - size - 2, size + 4, size + 4);
                }
                
                // Name label
                if (this.hover || this.selected) {
                    ctx.font = `${10 * camera.zoom}px 'Press Start 2P', monospace`;
                    ctx.fillStyle = '#fff';
                    ctx.textAlign = 'center';
                    ctx.fillText(this.name, screenPos.x, screenPos.y - size - 8);
                }
            }

            containsPoint(mx, my, isoMath, camera, canvas) {
                const pos = this.getScreenPos(isoMath, camera, canvas);
                const size = 32 * camera.zoom;
                return mx >= pos.x - size/2 && mx <= pos.x + size/2 &&
                       my >= pos.y - size && my <= pos.y;
            }

            getStatus() {
                if (this.sleepMode) return 'sleep';
                if (this.celebrateMode) return 'celebrate';
                if (this.alertMode) return 'alert';
                if (this.meetingMode) return 'meeting';
                return this.activity;
            }

            triggerAlert() {
                this.alertMode = true;
                this.activity = 'working';
                setTimeout(() => { this.alertMode = false; }, 5000);
            }

            triggerCelebrate() {
                this.celebrateMode = true;
                setTimeout(() => { this.celebrateMode = false; }, 5000);
            }

            toggleSleep() {
                this.sleepMode = !this.sleepMode;
            }

            startMeeting() {
                this.meetingMode = true;
                this.activity = 'meeting';
            }

            endMeeting() {
                this.meetingMode = false;
                this.activity = 'idle';
            }
        }

        // ============================================
        // FURNITURE CLASS - Office environment objects
        // ============================================
        class Furniture {
            constructor(type, x, y, z = 0) {
                this.type = type;
                this.x = x;
                this.y = y;
                this.z = z;
            }

            render(ctx, spriteLoader, isoMath, camera, canvas) {
                const pos = isoMath.toScreen(this.x, this.y, this.z);
                const screenX = (pos.x - camera.x) * camera.zoom;
                const screenY = (pos.y - camera.y) * camera.zoom;
                const size = 32 * camera.zoom;

                const img = spriteLoader.getFurniture(this.type);
                if (img) {
                    ctx.drawImage(img, screenX - size/2, screenY - size, size, size);
                } else {
                    // Fallback rendering
                    ctx.fillStyle = '#8b7355';
                    ctx.fillRect(screenX - size/2, screenY - size/2, size, size/2);
                }
            }
        }

        // ============================================
        // MAIN RENDERER
        // ============================================
        class OfficeRenderer {
            constructor(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.agents = new Map();
                this.furniture = [];
                this.camera = { x: 0, y: 0, zoom: 1 };
                this.running = false;
                this.debug = false;
                this.hoveredAgent = null;
                this.selectedAgent = null;
                
                this.isoMath = {
                    toScreen: (x, y, z) => ({
                        x: (x - y) * 32 + this.canvas.width / 2,
                        y: (x + y) * 16 - z * 16 + this.canvas.height / 3
                    })
                };
                
                this.setupCanvas();
                this.setupInteractions();
                this.setupFurniture();
            }

            setupFurniture() {
                // Commander desk area
                this.furniture.push(new Furniture('furniture_commander_desk', -8, -6));
                this.furniture.push(new Furniture('furniture_chair', -7, -6));
                
                // Nexus station
                this.furniture.push(new Furniture('furniture_nexus', 4, -6));
                
                // Backend team desks
                this.furniture.push(new Furniture('furniture_desk', -7, 2));
                this.furniture.push(new Furniture('furniture_computer', -7, 2, 0.5));
                this.furniture.push(new Furniture('furniture_desk', -4, 2));
                this.furniture.push(new Furniture('furniture_desk', -7, 4.5));
                this.furniture.push(new Furniture('furniture_desk', -4, 4.5));
                
                // UI/Design area
                this.furniture.push(new Furniture('furniture_desk', 3, -3));
                this.furniture.push(new Furniture('furniture_desk', 6, -3));
                this.furniture.push(new Furniture('furniture_desk', 3, -0.5));
                this.furniture.push(new Furniture('furniture_desk', 6, -0.5));
                
                // Meeting table
                this.furniture.push(new Furniture('furniture_desk', 0, 0));
                
                // Plants for decoration
                this.furniture.push(new Furniture('furniture_plant', -10, -8));
                this.furniture.push(new Furniture('furniture_plant', 8, -8));
                this.furniture.push(new Furniture('furniture_plant', -10, 8));
                this.furniture.push(new Furniture('furniture_plant', 8, 8));
            }

            setupCanvas() {
                const resize = () => {
                    const container = this.canvas.parentElement;
                    this.canvas.width = container.clientWidth;
                    this.canvas.height = window.innerWidth < 768 ? 400 : 600;
                };
                resize();
                window.addEventListener('resize', resize);
            }

            setupInteractions() {
                let isDragging = false;
                let dragStartX, dragStartY;
                
                this.canvas.addEventListener('mousedown', (e) => {
                    const rect = this.canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    // Check if clicked on agent (reverse order for proper z-index)
                    let clickedAgent = null;
                    const sortedAgents = Array.from(this.agents.values())
                        .sort((a, b) => (b.y + b.x) - (a.y + a.x));
                    
                    for (const agent of sortedAgents) {
                        if (agent.containsPoint(x, y, this.isoMath, this.camera, this.canvas)) {
                            clickedAgent = agent;
                            break;
                        }
                    }
                    
                    if (clickedAgent) {
                        this.agents.forEach(a => a.selected = false);
                        clickedAgent.selected = true;
                        this.selectedAgent = clickedAgent;
                        addActivity(clickedAgent.name, clickedAgent.currentTask);
                        showAgentModal(clickedAgent);
                    } else {
                        isDragging = true;
                        dragStartX = e.clientX;
                        dragStartY = e.clientY;
                    }
                });
                
                this.canvas.addEventListener('mousemove', (e) => {
                    const rect = this.canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    // Update hover state
                    let newHovered = null;
                    const sortedAgents = Array.from(this.agents.values())
                        .sort((a, b) => (b.y + b.x) - (a.y + a.x));
                    
                    for (const agent of sortedAgents) {
                        if (agent.containsPoint(x, y, this.isoMath, this.camera, this.canvas)) {
                            newHovered = agent;
                            break;
                        }
                    }
                    
                    if (newHovered !== this.hoveredAgent) {
                        if (this.hoveredAgent) this.hoveredAgent.hover = false;
                        this.hoveredAgent = newHovered;
                        if (newHovered) newHovered.hover = true;
                        this.updateTooltip(e.clientX, e.clientY);
                    }
                    
                    if (this.hoveredAgent) {
                        this.updateTooltip(e.clientX, e.clientY);
                    }
                    
                    if (isDragging) {
                        const dx = e.clientX - dragStartX;
                        const dy = e.clientY - dragStartY;
                        this.camera.x += dx / this.camera.zoom;
                        this.camera.y += dy / this.camera.zoom;
                        dragStartX = e.clientX;
                        dragStartY = e.clientY;
                    }
                });
                
                this.canvas.addEventListener('mouseup', () => {
                    isDragging = false;
                });
                
                this.canvas.addEventListener('mouseleave', () => {
                    if (this.hoveredAgent) this.hoveredAgent.hover = false;
                    this.hoveredAgent = null;
                    document.getElementById('tooltip').style.display = 'none';
                });
                
                this.canvas.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    const factor = e.deltaY > 0 ? 0.9 : 1.1;
                    const newZoom = Math.max(0.5, Math.min(3, this.camera.zoom * factor));
                    this.camera.zoom = newZoom;
                });
            }

            updateTooltip(clientX, clientY) {
                const tooltip = document.getElementById('tooltip');
                if (this.hoveredAgent) {
                    tooltip.style.display = 'block';
                    tooltip.style.left = (clientX + 15) + 'px';
                    tooltip.style.top = (clientY + 15) + 'px';
                    document.getElementById('tooltipName').textContent = this.hoveredAgent.name;
                    document.getElementById('tooltipTask').textContent = this.hoveredAgent.currentTask;
                    const statusEl = document.getElementById('tooltipStatus');
                    statusEl.textContent = this.hoveredAgent.getStatus();
                    statusEl.className = 'tooltip-status status-' + this.hoveredAgent.getStatus();
                } else {
                    tooltip.style.display = 'none';
                }
            }

            addAgent(agentData) {
                const agent = new Agent(agentData);
                this.agents.set(agentData.id, agent);
                return agent;
            }

            start() {
                if (this.running) return;
                this.running = true;
                this.lastTime = performance.now();
                this.loop();
            }

            loop() {
                if (!this.running) return;
                
                const now = performance.now();
                const dt = now - this.lastTime;
                this.lastTime = now;
                
                this.update(dt);
                this.render();
                
                requestAnimationFrame(() => this.loop());
            }

            update(dt) {
                for (const agent of this.agents.values()) {
                    agent.update(dt);
                }
            }

            render() {
                const ctx = this.ctx;
                const canvas = this.canvas;
                
                // Clear
                ctx.fillStyle = '#1a1a2e';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw floor grid
                this.drawFloor();
                
                // Draw furniture
                for (const furniture of this.furniture) {
                    furniture.render(ctx, spriteLoader, this.isoMath, this.camera, canvas);
                }
                
                // Sort agents by depth (y + x)
                const sortedAgents = Array.from(this.agents.values())
                    .sort((a, b) => (a.y + a.x) - (b.y + b.x));
                
                // Draw agents
                for (const agent of sortedAgents) {
                    agent.render(ctx, spriteLoader, this.isoMath, this.camera, canvas);
                }
                
                // Debug info
                if (this.debug) {
                    ctx.fillStyle = '#0f0';
                    ctx.font = '12px monospace';
                    ctx.fillText(`Camera: ${this.camera.x.toFixed(1)}, ${this.camera.y.toFixed(1)}, zoom: ${this.camera.zoom.toFixed(2)}`, 10, 20);
                    ctx.fillText(`Agents: ${this.agents.size}`, 10, 40);
                    ctx.fillText(`Hovered: ${this.hoveredAgent ? this.hoveredAgent.name : 'none'}`, 10, 60);
                }
            }

            drawFloor() {
                const ctx = this.ctx;
                const size = 12;
                
                for (let x = -size; x <= size; x++) {
                    for (let y = -size; y <= size; y++) {
                        const pos = this.isoMath.toScreen(x, y, 0);
                        const camX = (pos.x - this.camera.x) * this.camera.zoom;
                        const camY = (pos.y - this.camera.y) * this.camera.zoom;
                        
                        const tileW = 32 * this.camera.zoom;
                        const tileH = 16 * this.camera.zoom;
                        
                        // Checkerboard pattern with office floor colors
                        const isOffice = (x >= -10 && x <= 10 && y >= -8 && y <= 8);
                        if (isOffice) {
                            ctx.fillStyle = (x + y) % 2 === 0 ? '#3d4a5c' : '#354252';
                        } else {
                            ctx.fillStyle = (x + y) % 2 === 0 ? '#2d3436' : '#252b2c';
                        }
                        
                        ctx.beginPath();
                        ctx.moveTo(camX, camY);
                        ctx.lineTo(camX + tileW, camY + tileH);
                        ctx.lineTo(camX, camY + tileH * 2);
                        ctx.lineTo(camX - tileW, camY + tileH);
                        ctx.closePath();
                        ctx.fill();
                    }
                }
            }

            triggerAlertAll() {
                for (const agent of this.agents.values()) {
                    agent.triggerAlert();
                }
            }

            triggerCelebrateAll() {
                for (const agent of this.agents.values()) {
                    agent.triggerCelebrate();
                }
            }

            startMeeting() {
                // Move all agents to center for meeting
                for (const agent of this.agents.values()) {
                    agent.startMeeting();
                    agent.targetX = (Math.random() - 0.5) * 4;
                    agent.targetY = (Math.random() - 0.5) * 4;
                    agent.activity = 'walking';
                }
            }
        }

        // ============================================
        // GLOBAL STATE
        // ============================================
        let spriteLoader, renderer;
        let frameCount = 0, lastFpsTime = performance.now();

        // ============================================
        // INITIALIZATION
        // ============================================
        async function init() {
            const canvas = document.getElementById('officeCanvas');
            
            // Initialize sprite loader
            spriteLoader = new SpriteLoader('./assets/sprites/');
            await spriteLoader.load();
            
            // Create renderer
            renderer = new OfficeRenderer(canvas);
            
            // Add all agents
            AGENTS_DATA.forEach(data => {
                renderer.addAgent(data);
            });
            
            // Render agent grid
            renderAgentGrid();
            
            // Start
            renderer.start();
            startSimulation();
            
            // FPS counter
            setInterval(updateFps, 1000);
            
            addActivity('System', 'Pixel Office initialized with 22 agents');
            addActivity('System', '7 animation types: idle, walk, work, celebrate, sleep, alert, meeting');
            
            // Fetch real-time agent status
            fetchAgentStatus();
        }

        async function fetchAgentStatus() {
            try {
                const response = await fetch('/api/agents');
                if (response.ok) {
                    const data = await response.json();
                    updateAgentStatus(data);
                }
            } catch (error) {
                console.log('API not available, using simulated data');
            }
            // Poll every 30 seconds
            setTimeout(fetchAgentStatus, 30000);
        }

        function updateAgentStatus(apiData) {
            if (!apiData || !apiData.agents) return;
            
            for (const agentData of apiData.agents) {
                const agent = renderer.agents.get(agentData.id);
                if (agent) {
                    if (agentData.status) agent.activity = agentData.status;
                    if (agentData.task) agent.currentTask = agentData.task;
                }
            }
            addActivity('System', 'Agent status updated from API');
        }

        function renderAgentGrid() {
            const grid = document.getElementById('agentGrid');
            AGENTS_DATA.forEach(agent => {
                const div = document.createElement('div');
                div.className = 'agent-mini';
                div.id = `mini-card-${agent.id}`;
                div.innerHTML = `
                    <canvas class="agent-mini-canvas" id="mini-${agent.id}" width="32" height="32"></canvas>
                    <div class="agent-mini-name">${agent.name}</div>
                    <div class="agent-mini-role">${agent.role}</div>
                    <span class="agent-mini-status status-idle" id="status-${agent.id}">IDLE</span>
                `;
                div.onclick = () => {
                    document.querySelectorAll('.agent-mini').forEach(el => el.classList.remove('selected'));
                    div.classList.add('selected');
                    renderer.agents.forEach(a => a.selected = false);
                    const agentObj = renderer.agents.get(agent.id);
                    if (agentObj) {
                        agentObj.selected = true;
                        renderer.selectedAgent = agentObj;
                        addActivity(agent.name, agentObj.currentTask);
                        showAgentModal(agentObj);
                    }
                };
                grid.appendChild(div);
                
                setTimeout(() => drawMiniPreview(agent.id), 100);
            });
        }

        function drawMiniPreview(agentId) {
            const canvas = document.getElementById(`mini-${agentId}`);
            if (!canvas || !spriteLoader.loaded) return;
            
            const ctx = canvas.getContext('2d');
            const sprite = spriteLoader.getSprite(agentId, 'idle', 0);
            if (sprite) {
                ctx.clearRect(0, 0, 32, 32);
                ctx.drawImage(sprite.image, sprite.sx, sprite.sy, 16, 16, 8, 8, 16, 16);
            }
        }

        function updateFps() {
            const now = performance.now();
            const fps = Math.round(frameCount * 1000 / (now - lastFpsTime));
            document.getElementById('fpsCounter').textContent = fps;
            frameCount = 0;
            lastFpsTime = now;
            
            // Update agent status indicators
            if (renderer) {
                for (const agent of renderer.agents.values()) {
                    const statusEl = document.getElementById(`status-${agent.id}`);
                    if (statusEl) {
                        const status = agent.getStatus();
                        statusEl.textContent = status.toUpperCase();
                        statusEl.className = `agent-mini-status status-${status}`;
                    }
                }
            }
        }

        function startSimulation() {
            setInterval(() => {
                if (!renderer) return;
                const agents = Array.from(renderer.agents.values());
                const randomAgent = agents[Math.floor(Math.random() * agents.length)];
                
                if (randomAgent.activity === 'idle' && Math.random() < 0.3) {
                    randomAgent.startWalking();
                }
            }, 2000);
        }

        function resetCamera() {
            if (renderer) {
                renderer.camera.x = 0;
                renderer.camera.y = 0;
                renderer.camera.zoom = 1;
            }
        }

        function toggleDebug() {
            if (renderer) {
                renderer.debug = !renderer.debug;
            }
        }

        function triggerAlert() {
            if (renderer) {
                renderer.triggerAlertAll();
                addActivity('System', 'üö® ALERT triggered for all agents!');
            }
        }

        function triggerCelebrate() {
            if (renderer) {
                renderer.triggerCelebrateAll();
                addActivity('System', 'üéâ Celebration mode activated!');
            }
        }

        function addActivity(agent, action) {
            const log = document.getElementById('activityLog');
            const time = new Date().toLocaleTimeString('en-US', { 
                hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
            
            const item = document.createElement('div');
            item.className = 'activity-item';
            item.innerHTML = `<span class="activity-time">${time}</span> <strong>${agent}</strong>: ${action}`;
            
            log.insertBefore(item, log.firstChild);
            while (log.children.length > 50) log.removeChild(log.lastChild);
        }

        // ============================================
        // MODAL FUNCTIONS
        // ============================================
        function showAgentModal(agent) {
            const modal = document.getElementById('agentModal');
            document.getElementById('modalName').textContent = agent.name;
            document.getElementById('modalRole').textContent = agent.role;
            document.getElementById('modalStatus').textContent = agent.getStatus().toUpperCase();
            document.getElementById('modalTask').textContent = agent.currentTask;
            document.getElementById('modalAnimation').textContent = agent.animation;
            document.getElementById('modalLocation').textContent = `${agent.x.toFixed(1)}, ${agent.y.toFixed(1)}`;
            document.getElementById('modalTasksCompleted').textContent = agent.tasksCompleted;
            
            // Draw avatar
            const avatarCanvas = document.getElementById('modalAvatar');
            const ctx = avatarCanvas.getContext('2d');
            ctx.clearRect(0, 0, 64, 64);
            
            const sprite = spriteLoader.getSprite(agent.id, agent.animation, agent.frame);
            if (sprite) {
                ctx.drawImage(sprite.image, sprite.sx, sprite.sy, 16, 16, 16, 16, 32, 32);
            }
            
            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('agentModal').classList.remove('active');
        }

        // Close modal on overlay click
        document.getElementById('agentModal').addEventListener('click', (e) => {
            if (e.target.id === 'agentModal') closeModal();
        });

        // Initialize on load
        window.addEventListener('load', init);
    </script>
</body>
</html>
