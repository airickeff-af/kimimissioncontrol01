<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pixel Office | Live Command Center</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }
        
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a2e;
            --accent-primary: #00d4ff;
            --accent-cyan: #00d4ff;
            --accent-green: #22c55e;
            --accent-yellow: #fbbf24;
            --accent-orange: #f97316;
            --accent-purple: #a855f7;
            --accent-pink: #ff2a6d;
            --accent-red: #ef4444;
            --text-primary: #eaeaea;
            --text-secondary: #888;
            --border: #2d2d44;
        }
        
        body {
            font-family: 'VT323', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow: hidden;
            touch-action: none;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 212, 255, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 212, 255, 0.02) 1px, transparent 1px);
            background-size: 32px 32px;
            pointer-events: none;
            z-index: 0;
        }
        
        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--accent-primary);
            padding: 0 1rem;
            height: 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }
        
        .brand {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .logo {
            width: 32px;
            height: 32px;
            background: var(--accent-primary);
            border: 2px solid var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }
        
        .brand-text h1 {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.55rem;
            line-height: 1.3;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            padding: 0.25rem 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
        }
        
        .connection-status.connected { border-color: var(--accent-green); color: var(--accent-green); }
        .connection-status.connecting { border-color: var(--accent-yellow); color: var(--accent-yellow); }
        .connection-status.error { border-color: var(--accent-pink); color: var(--accent-pink); }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        /* System Load Indicator */
        .system-load {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
        }
        
        .load-bar {
            width: 60px;
            height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .load-fill {
            height: 100%;
            transition: width 0.5s, background 0.5s;
        }
        
        .load-fill.low { background: var(--accent-green); }
        .load-fill.normal { background: var(--accent-yellow); }
        .load-fill.high { background: var(--accent-orange); }
        .load-fill.critical { background: var(--accent-red); animation: flash 1s infinite; }
        
        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Main Container */
        .main-container {
            position: fixed;
            top: 50px;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
        }
        
        .canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: linear-gradient(180deg, #0a0a0f 0%, #12121a 100%);
        }
        
        #officeCanvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            cursor: grab;
        }
        
        #officeCanvas:active { cursor: grabbing; }
        
        /* Controls */
        .controls-overlay {
            position: absolute;
            bottom: 15px;
            left: 15px;
            display: flex;
            gap: 8px;
            z-index: 100;
        }
        
        .control-btn {
            width: 40px;
            height: 40px;
            background: var(--bg-card);
            border: 2px solid var(--accent-cyan);
            color: var(--text-primary);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .control-btn:hover {
            background: var(--accent-cyan);
            color: var(--bg-primary);
        }
        
        /* Side Panel */
        .side-panel {
            width: 320px;
            background: var(--bg-secondary);
            border-left: 2px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 50;
            transition: transform 0.3s ease;
        }
        
        .panel-section {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
        }
        
        .panel-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.5rem;
            color: var(--accent-cyan);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .agent-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .agent-list-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            margin-bottom: 0.4rem;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 0.9rem;
        }
        
        .agent-list-item:hover {
            border-color: var(--accent-cyan);
        }
        
        .agent-list-item.active {
            border-color: var(--accent-green);
            background: rgba(34, 197, 94, 0.1);
        }
        
        .agent-list-avatar {
            width: 28px;
            height: 28px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            border: 1px solid var(--border);
            position: relative;
        }
        
        .agent-list-info { flex: 1; }
        .agent-list-name { font-weight: bold; font-size: 0.85rem; }
        .agent-list-role { font-size: 0.7rem; color: var(--text-secondary); }
        
        .agent-list-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .agent-list-status.active { background: var(--accent-green); box-shadow: 0 0 4px var(--accent-green); }
        .agent-list-status.idle { background: var(--accent-yellow); }
        .agent-list-status.busy { background: var(--accent-red); }
        .agent-list-status.offline { background: #666; }
        
        /* Activity intensity indicator */
        .activity-indicator {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid var(--bg-card);
            font-size: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .activity-indicator.typing { background: var(--accent-green); animation: blink 0.5s infinite; }
        .activity-indicator.walking { background: var(--accent-yellow); }
        .activity-indicator.idle { background: #666; }
        .activity-indicator.meeting { background: var(--accent-purple); animation: pulse 1s infinite; }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .activity-feed {
            max-height: 180px;
            overflow-y: auto;
        }
        
        .activity-item {
            display: flex;
            gap: 0.4rem;
            padding: 0.4rem;
            background: var(--bg-card);
            border-left: 2px solid var(--accent-cyan);
            margin-bottom: 0.4rem;
            font-size: 0.8rem;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .activity-agent { color: var(--accent-cyan); font-weight: bold; }
        .activity-time { font-size: 0.65rem; color: var(--text-secondary); margin-left: auto; }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.4rem;
        }
        
        .action-btn {
            padding: 0.5rem;
            background: var(--bg-card);
            border: 1px solid var(--accent-primary);
            color: var(--text-primary);
            font-family: 'VT323', monospace;
            font-size: 0.8rem;
            cursor: pointer;
        }
        
        .action-btn:hover { background: var(--accent-primary); }
        
        /* Agent Detail Popup */
        .agent-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-card);
            border: 2px solid var(--accent-cyan);
            padding: 1.5rem;
            z-index: 2000;
            min-width: 300px;
            max-width: 400px;
            display: none;
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.3);
        }
        
        .agent-popup.active { display: block; animation: popupIn 0.2s ease-out; }
        
        @keyframes popupIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        
        .popup-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }
        
        .popup-avatar {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            border: 2px solid var(--accent-cyan);
        }
        
        .popup-title h3 {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.7rem;
            margin-bottom: 0.25rem;
        }
        
        .popup-title .role {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .popup-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .stat-item {
            background: var(--bg-secondary);
            padding: 0.5rem;
            text-align: center;
            border-radius: 4px;
        }
        
        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--accent-cyan);
        }
        
        .stat-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }
        
        .popup-task {
            background: var(--bg-secondary);
            padding: 0.75rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        
        .popup-task-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }
        
        .popup-task-title {
            font-size: 0.9rem;
            color: var(--text-primary);
        }
        
        .popup-task-priority {
            display: inline-block;
            padding: 0.1rem 0.4rem;
            border-radius: 3px;
            font-size: 0.65rem;
            margin-top: 0.5rem;
        }
        
        .priority-P0 { background: var(--accent-red); color: white; }
        .priority-P1 { background: var(--accent-orange); color: white; }
        .priority-P2 { background: var(--accent-yellow); color: black; }
        .priority-P3 { background: var(--accent-green); color: white; }
        
        .popup-progress {
            margin-bottom: 1rem;
        }
        
        .progress-bar {
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.25rem;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-green));
            transition: width 0.3s;
        }
        
        .popup-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .popup-btn {
            flex: 1;
            padding: 0.5rem;
            background: var(--accent-cyan);
            border: none;
            color: var(--bg-primary);
            font-family: 'VT323', monospace;
            font-size: 0.85rem;
            cursor: pointer;
        }
        
        .popup-btn.secondary {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }
        
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1999;
            display: none;
        }
        
        .popup-overlay.active { display: block; }
        
        /* Tooltip */
        .tooltip {
            position: absolute;
            background: var(--bg-card);
            border: 2px solid var(--accent-cyan);
            padding: 0.5rem;
            pointer-events: none;
            z-index: 200;
            font-size: 0.8rem;
            max-width: 200px;
            display: none;
        }
        
        .tooltip-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.5rem;
            color: var(--accent-cyan);
        }
        
        .tooltip-task {
            color: var(--accent-yellow);
            margin-top: 0.25rem;
            font-size: 0.75rem;
        }
        
        .tooltip-priority {
            display: inline-block;
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
            font-size: 0.6rem;
            margin-top: 0.25rem;
        }
        
        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s;
        }
        
        .loading-screen.hidden { opacity: 0; pointer-events: none; }
        
        .loading-bar {
            width: 200px;
            height: 6px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            margin-top: 1rem;
        }
        
        .loading-progress {
            height: 100%;
            background: var(--accent-cyan);
            width: 0%;
            transition: width 0.2s;
        }
        
        /* Mobile */
        .mobile-toggle {
            display: none;
            position: absolute;
            top: 70px;
            right: 15px;
            width: 40px;
            height: 40px;
            background: var(--bg-card);
            border: 2px solid var(--accent-cyan);
            color: var(--text-primary);
            z-index: 100;
        }
        
        @media (max-width: 900px) {
            .side-panel {
                position: fixed;
                right: 0;
                top: 50px;
                bottom: 0;
                transform: translateX(100%);
                width: 280px;
            }
            .side-panel.open { transform: translateX(0); }
            .mobile-toggle { display: flex; align-items: center; justify-content: center; }
            .system-load { display: none; }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div style="font-size: 3rem;">üè¢</div>
        <div style="font-family: 'Press Start 2P'; font-size: 0.7rem; margin-top: 0.5rem;">LOADING PIXEL OFFICE...</div>
        <div class="loading-bar">
            <div class="loading-progress" id="loadingProgress"></div>
        </div>
        <div id="loadingStatus" style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-secondary);">Initializing...</div>
    </div>

    <!-- Agent Detail Popup -->
    <div class="popup-overlay" id="popupOverlay" onclick="closePopup()"></div>
    <div class="agent-popup" id="agentPopup">
        <div class="popup-header">
            <div class="popup-avatar" id="popupAvatar">ü§ñ</div>
            <div class="popup-title">
                <h3 id="popupName">Agent Name</h3>
                <div class="role" id="popupRole">Role</div>
            </div>
        </div>
        <div class="popup-stats">
            <div class="stat-item">
                <div class="stat-value" id="popupTokens">0</div>
                <div class="stat-label">Tokens Today</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="popupTasks">0</div>
                <div class="stat-label">Tasks Done</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="popupEfficiency">0%</div>
                <div class="stat-label">Efficiency</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="popupStatus">‚óè</div>
                <div class="stat-label">Status</div>
            </div>
        </div>
        <div class="popup-task">
            <div class="popup-task-label">CURRENT TASK</div>
            <div class="popup-task-title" id="popupTask">No active task</div>
            <span class="popup-task-priority" id="popupPriority"></span>
        </div>
        <div class="popup-progress">
            <div style="display: flex; justify-content: space-between; font-size: 0.75rem;">
                <span>Task Progress</span>
                <span id="popupProgressText">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="popupProgressBar" style="width: 0%"></div>
            </div>
        </div>
        <div class="popup-actions">
            <button class="popup-btn" onclick="viewAgentWork()">View Work</button>
            <button class="popup-btn secondary" onclick="closePopup()">Close</button>
        </div>
    </div>

    <header class="header">
        <div class="brand">
            <div class="logo">üè¢</div>
            <div class="brand-text">
                <h1>PIXEL OFFICE LIVE</h1>
            </div>
        </div>
        
        <div class="system-load" id="systemLoad">
            <span>SYSTEM LOAD</span>
            <div class="load-bar">
                <div class="load-fill" id="loadFill" style="width: 0%"></div>
            </div>
            <span id="loadText">0%</span>
        </div>
        
        <div class="connection-status" id="connectionStatus">
            <span class="status-dot"></span>
            <span id="connectionText">Connecting...</span>
        </div>
        
        <button class="control-btn" onclick="location.href='mission-control/dashboard/office.html'" title="Back to Dashboard">üè†</button>
    </header>

    <div class="main-container">
        <div class="canvas-container" id="canvasContainer">
            <canvas id="officeCanvas"></canvas>
            
            <div class="controls-overlay">
                <button class="control-btn" onclick="zoomIn()" title="Zoom In">+</button>
                <button class="control-btn" onclick="zoomOut()" title="Zoom Out">‚àí</button>
                <button class="control-btn" onclick="resetView()" title="Reset View">‚åÇ</button>
                <button class="control-btn" onclick="toggleStandup()" title="Standup">üì¢</button>
                <button class="control-btn" onclick="forceRefresh()" title="Refresh">üîÑ</button>
            </div>
            
            <button class="mobile-toggle" id="mobileToggle" onclick="togglePanel()">‚ò∞</button>
            
            <div class="tooltip" id="tooltip">
                <div class="tooltip-title" id="tooltipTitle"></div>
                <div id="tooltipRole"></div>
                <div class="tooltip-task" id="tooltipTask"></div>
                <span class="tooltip-priority" id="tooltipPriority"></span>
            </div>
        </div>

        <!-- Agent Hierarchy Table Panel -->
        <aside class="hierarchy-panel" id="hierarchyPanel">
            <div class="hierarchy-header">
                <span class="hierarchy-title">üë• AGENT HIERARCHY</span>
                <span class="hierarchy-count" id="hierarchyCount">0 agents</span>
            </div>
            <div class="hierarchy-content" id="hierarchyContent">
                <!-- Hierarchy content populated by JS -->
            </div>
        </aside>
        
        <aside class="side-panel" id="sidePanel">
            <div class="panel-section">
                <div class="panel-title">üë• AGENTS (<span id="agentCount">0</span>)</div>
                <div class="agent-list" id="agentList"></div>
            </div>
            
            <div class="panel-section" style="flex: 1; overflow: hidden;">
                <div class="panel-title">üì° LIVE ACTIVITY</div>
                <div class="activity-feed" id="activityFeed"></div>
            </div>
            
            <div class="panel-section">
                <div class="panel-title">‚ö° ACTIONS</div>
                <div class="quick-actions">
                    <button class="action-btn" onclick="callStandup()">üì¢ Standup</button>
                    <button class="action-btn" onclick="syncWithAPI()">üîÑ Sync</button>
                    <button class="action-btn" onclick="findAgent()">üîç Find</button>
                    <button class="action-btn" onclick="toggleParticles()">‚ú® FX</button>
                </div>
            </div>
        </aside>
    </div>

    <script>
        // ============================================
        // PIXEL OFFICE v3.0 - LIVE DATA INTEGRATION
        // ============================================
        
        const canvas = document.getElementById('officeCanvas');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('canvasContainer');
        
        ctx.imageSmoothingEnabled = false;
        
        // API Configuration
        const API_CONFIG = {
            baseUrl: '',
            endpoints: {
                pixelOfficeData: '/api/pixel-office-data',
                agents: '/api/agents',
                tasks: '/api/tasks',
                tokens: '/api/tokens-live'
            },
            refreshInterval: 30000, // 30 seconds
            retryInterval: 5000
        };
        
        // Game State
        const state = {
            zoom: 1,
            panX: 0,
            panY: 0,
            isDragging: false,
            lastMouseX: 0,
            lastMouseY: 0,
            soundEnabled: true,
            particlesEnabled: true,
            standupMode: false,
            lastTime: 0,
            hoveredAgent: null,
            selectedAgent: null,
            apiConnected: false,
            lastApiFetch: 0,
            systemLoad: { level: 'normal', percentage: 0 },
            liveData: null
        };
        
        // Isometric constants
        const TILE_WIDTH = 48;
        const TILE_HEIGHT = 24;
        const GRID_SIZE = 20;
        
        // Office data
        const office = {
            tiles: [],
            furniture: [],
            agents: [],
            particles: [],
            standupSeats: []
        };
        
        // Zone colors for environment reaction
        const ZONE_COLORS = {
            command: '#ffd700',
            nexus: '#00d4ff',
            backend: '#22c55e',
            frontend: '#f97316',
            design: '#a855f7',
            research: '#3b82f6',
            content: '#ec4899',
            marketing: '#f59e0b',
            devops: '#ef4444',
            qa: '#8b5cf6',
            security: '#6366f1',
            sales: '#10b981',
            intel: '#00d4ff',
            ai: '#8b5cf6',
            general: '#888'
        };
        
        // ============================================
        // API INTEGRATION - LIVE DATA
        // ============================================
        
        async function fetchFromAPI(endpoint) {
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}${endpoint}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (error) {
                console.warn(`API fetch failed for ${endpoint}:`, error.message);
                return null;
            }
        }
        
        async function syncWithAPI(force = false) {
            updateLoadingStatus('Syncing with live data...');
            updateConnectionStatus('connecting', 'Syncing...');
            
            const data = await fetchFromAPI(API_CONFIG.endpoints.pixelOfficeData + (force ? '?refresh=true' : ''));
            
            if (data && data.success) {
                state.liveData = data;
                updateAgentsFromLiveData(data.agents);
                updateSystemLoad(data.systemLoad);
                updateSummary(data.summary);
                addRecentActivity(data.recentActivity);
                
                state.apiConnected = true;
                state.lastApiFetch = Date.now();
                updateConnectionStatus('connected', 'Live');
                updateLoadingStatus('Live data connected!');
                
                // Add system activity
                if (!force) {
                    addActivity('system', 'Nexus', `Synced ${data.agents.length} agents`);
                }
            } else {
                state.apiConnected = false;
                updateConnectionStatus('error', 'Offline Mode');
                updateLoadingStatus('Using fallback data');
                
                // Use fallback data
                if (!office.agents.length) {
                    initFallbackAgents();
                }
            }
            
            renderAgentList();
        }
        
        function updateAgentsFromLiveData(agents) {
            if (!agents || !Array.isArray(agents)) return;
            
            agents.forEach(liveAgent => {
                let agent = office.agents.find(a => a.id === liveAgent.id);
                
                if (!agent) {
                    // Create new agent
                    agent = {
                        id: liveAgent.id,
                        name: liveAgent.name,
                        role: liveAgent.role,
                        emoji: liveAgent.emoji,
                        color: liveAgent.color,
                        pixelX: (liveAgent.position?.x || 10) * TILE_WIDTH,
                        pixelY: (liveAgent.position?.y || 10) * TILE_HEIGHT,
                        targetX: (liveAgent.position?.x || 10) * TILE_WIDTH,
                        targetY: (liveAgent.position?.y || 10) * TILE_HEIGHT,
                        direction: Math.floor(Math.random() * 4),
                        isMoving: false,
                        walkCycle: 0,
                        speechBubble: null,
                        speechTimer: 0,
                        activityTimer: Math.random() * 100
                    };
                    office.agents.push(agent);
                }
                
                // Update live data
                agent.status = liveAgent.status;
                agent.activity = liveAgent.activity;
                agent.activityType = liveAgent.activityType;
                agent.animation = liveAgent.animation;
                agent.intensity = liveAgent.intensity;
                agent.tasks = liveAgent.tasks;
                agent.tokens = liveAgent.tokens;
                agent.tokensToday = liveAgent.tokensToday;
                agent.efficiency = liveAgent.efficiency;
                agent.tasksCompleted = liveAgent.tasksCompleted;
                agent.currentTask = liveAgent.currentTask;
                agent.taskQueue = liveAgent.taskQueue;
                agent.lastActive = liveAgent.lastActive;
                agent.zone = liveAgent.position?.zone || 'general';
                
                // Update position if changed
                const targetX = (liveAgent.position?.x || 10) * TILE_WIDTH;
                const targetY = (liveAgent.position?.y || 10) * TILE_HEIGHT;
                
                if (Math.abs(agent.pixelX - targetX) > TILE_WIDTH || 
                    Math.abs(agent.pixelY - targetY) > TILE_HEIGHT) {
                    agent.targetX = targetX;
                    agent.targetY = targetY;
                    agent.isMoving = true;
                }
            });
            
            // Remove agents not in live data
            office.agents = office.agents.filter(agent => 
                agents.some(la => la.id === agent.id)
            );
        }
        
        function updateSystemLoad(systemLoad) {
            if (!systemLoad) return;
            
            state.systemLoad = systemLoad;
            
            const loadFill = document.getElementById('loadFill');
            const loadText = document.getElementById('loadText');
            
            loadFill.style.width = `${systemLoad.percentage}%`;
            loadFill.className = `load-fill ${systemLoad.level}`;
            loadText.textContent = `${systemLoad.percentage}%`;
        }
        
        function updateSummary(summary) {
            if (!summary) return;
            document.getElementById('agentCount').textContent = summary.totalAgents || 0;
        }
        
        function addRecentActivity(activities) {
            if (!activities || !Array.isArray(activities)) return;
            
            activities.slice(-5).forEach(activity => {
                if (activity.agent && activity.action) {
                    addActivity(activity.type || 'working', activity.agent, activity.action);
                }
            });
        }
        
        function updateConnectionStatus(status, text) {
            const statusEl = document.getElementById('connectionStatus');
            const textEl = document.getElementById('connectionText');
            
            statusEl.className = `connection-status ${status}`;
            textEl.textContent = text;
        }
        
        function forceRefresh() {
            syncWithAPI(true);
            addActivity('system', 'User', 'Manual refresh triggered');
        }
        
        // ============================================
        // FALLBACK AGENTS (when API is unavailable)
        // ============================================
        
        function initFallbackAgents() {
            const fallbackAgents = [
                { id: 'ericf', name: 'EricF', role: 'Commander', emoji: 'üëë', color: '#ffd700', x: 10, y: 10, zone: 'command', status: 'active', activity: 'strategic_planning', animation: 'idle', intensity: 'low' },
                { id: 'nexus', name: 'Nexus', role: 'Orchestrator', emoji: 'ü§ñ', color: '#00d4ff', x: 8, y: 8, zone: 'nexus', status: 'active', activity: 'monitoring', animation: 'idle', intensity: 'medium' },
                { id: 'codemaster', name: 'CodeMaster', role: 'Backend Lead', emoji: 'üíª', color: '#22c55e', x: 6, y: 6, zone: 'backend', status: 'active', activity: 'coding', animation: 'typing', intensity: 'high' },
                { id: 'code1', name: 'Code-1', role: 'Backend Dev', emoji: '‚ö°', color: '#22c55e', x: 5, y: 7, zone: 'backend', status: 'active', activity: 'api_fix', animation: 'typing', intensity: 'high' },
                { id: 'code2', name: 'Code-2', role: 'Backend Dev', emoji: 'üîß', color: '#22c55e', x: 7, y: 5, zone: 'backend', status: 'active', activity: 'debugging', animation: 'typing', intensity: 'high' },
                { id: 'code3', name: 'Code-3', role: 'Backend Dev', emoji: 'üîå', color: '#22c55e', x: 6, y: 8, zone: 'backend', status: 'active', activity: 'database', animation: 'typing', intensity: 'medium' },
                { id: 'forge', name: 'Forge', role: 'UI/Frontend Lead', emoji: 'üî®', color: '#f97316', x: 12, y: 6, zone: 'frontend', status: 'active', activity: 'design', animation: 'working', intensity: 'medium' },
                { id: 'forge2', name: 'Forge-2', role: 'UI Developer', emoji: 'üé®', color: '#f97316', x: 13, y: 5, zone: 'frontend', status: 'active', activity: 'component_design', animation: 'working', intensity: 'medium' },
                { id: 'forge3', name: 'Forge-3', role: 'UI Developer', emoji: '‚ú®', color: '#f97316', x: 11, y: 7, zone: 'frontend', status: 'active', activity: 'theme_integration', animation: 'working', intensity: 'medium' },
                { id: 'pixel', name: 'Pixel', role: 'Designer', emoji: 'üé®', color: '#a855f7', x: 14, y: 6, zone: 'design', status: 'active', activity: 'creating_assets', animation: 'working', intensity: 'medium' },
                { id: 'glasses', name: 'Glasses', role: 'Researcher', emoji: 'üîç', color: '#3b82f6', x: 4, y: 10, zone: 'research', status: 'active', activity: 'market_analysis', animation: 'idle', intensity: 'medium' },
                { id: 'quill', name: 'Quill', role: 'Writer', emoji: '‚úçÔ∏è', color: '#ec4899', x: 3, y: 12, zone: 'content', status: 'idle', activity: 'waiting', animation: 'idle', intensity: 'low' },
                { id: 'gary', name: 'Gary', role: 'Marketing', emoji: 'üì¢', color: '#f59e0b', x: 16, y: 8, zone: 'marketing', status: 'active', activity: 'campaign_planning', animation: 'idle', intensity: 'low' },
                { id: 'larry', name: 'Larry', role: 'Social Media', emoji: 'üì±', color: '#06b6d4', x: 17, y: 9, zone: 'marketing', status: 'active', activity: 'scheduling', animation: 'idle', intensity: 'low' },
                { id: 'buzz', name: 'Buzz', role: 'Social Media', emoji: 'üêù', color: '#fbbf24', x: 15, y: 10, zone: 'marketing', status: 'active', activity: 'content_creation', animation: 'working', intensity: 'medium' },
                { id: 'sentry', name: 'Sentry', role: 'DevOps', emoji: 'üõ°Ô∏è', color: '#ef4444', x: 9, y: 12, zone: 'devops', status: 'active', activity: 'monitoring', animation: 'idle', intensity: 'low' },
                { id: 'audit', name: 'Audit', role: 'QA Lead', emoji: 'üîç', color: '#8b5cf6', x: 8, y: 14, zone: 'qa', status: 'active', activity: 'quality_review', animation: 'idle', intensity: 'medium' },
                { id: 'cipher', name: 'Cipher', role: 'Security', emoji: 'üîê', color: '#6366f1', x: 10, y: 14, zone: 'security', status: 'active', activity: 'security_audit', animation: 'idle', intensity: 'medium' },
                { id: 'dealflow', name: 'DealFlow', role: 'Lead Gen', emoji: 'ü§ù', color: '#10b981', x: 15, y: 12, zone: 'sales', status: 'active', activity: 'lead_research', animation: 'working', intensity: 'high' },
                { id: 'coldcall', name: 'ColdCall', role: 'Outreach', emoji: 'üìû', color: '#f97316', x: 16, y: 13, zone: 'sales', status: 'idle', activity: 'waiting', animation: 'idle', intensity: 'low' },
                { id: 'scout', name: 'Scout', role: 'Intel', emoji: 'üî≠', color: '#3b82f6', x: 5, y: 14, zone: 'intel', status: 'active', activity: 'competitor_intel', animation: 'idle', intensity: 'medium' },
                { id: 'pie', name: 'PIE', role: 'Predictive AI', emoji: 'üß†', color: '#8b5cf6', x: 10, y: 4, zone: 'ai', status: 'active', activity: 'data_analysis', animation: 'working', intensity: 'high' }
            ];
            
            office.agents = fallbackAgents.map(data => ({
                ...data,
                pixelX: data.x * TILE_WIDTH,
                pixelY: data.y * TILE_HEIGHT,
                targetX: data.x * TILE_WIDTH,
                targetY: data.y * TILE_HEIGHT,
                direction: Math.floor(Math.random() * 4),
                isMoving: false,
                walkCycle: 0,
                speechBubble: null,
                speechTimer: 0,
                activityTimer: Math.random() * 100,
                tokens: Math.floor(Math.random() * 50000) + 5000,
                tokensToday: Math.floor(Math.random() * 5000) + 500,
                tasks: Math.floor(Math.random() * 10) + 1,
                tasksCompleted: Math.floor(Math.random() * 50) + 10,
                efficiency: Math.floor(Math.random() * 30) + 70,
                currentTask: null
            }));
        }
        
        // ============================================
        // INITIALIZATION
        // ============================================
        
        function initOffice() {
            // Generate floor tiles
            for (let y = 0; y < GRID_SIZE; y++) {
                for (let x = 0; x < GRID_SIZE; x++) {
                    office.tiles.push({
                        x, y,
                        type: (x + y) % 2 === 0 ? 'floor1' : 'floor2'
                    });
                }
            }
            
            // Furniture with zone associations
            office.furniture = [
                { x: 5, y: 5, type: 'desk', zone: 'backend' }, 
                { x: 6, y: 5, type: 'desk', zone: 'backend' },
                { x: 5, y: 6, type: 'desk', zone: 'backend' }, 
                { x: 6, y: 6, type: 'desk', zone: 'backend' },
                { x: 12, y: 5, type: 'desk', zone: 'frontend' }, 
                { x: 13, y: 5, type: 'desk', zone: 'frontend' },
                { x: 12, y: 6, type: 'desk', zone: 'frontend' }, 
                { x: 13, y: 6, type: 'desk', zone: 'frontend' },
                { x: 8, y: 10, type: 'server', zone: 'devops' },
                { x: 10, y: 2, type: 'conference', zone: 'command' },
                { x: 10, y: 10, type: 'commander_desk', zone: 'command' },
                { x: 8, y: 8, type: 'nexus_pod', zone: 'nexus' }
            ];
            
            // Standup seats
            office.standupSeats = [
                { x: 8, y: 3 }, { x: 9, y: 3 }, { x: 10, y: 3 }, { x: 11, y: 3 },
                { x: 8, y: 4 }, { x: 11, y: 4 },
                { x: 8, y: 5 }, { x: 9, y: 5 }, { x: 10, y: 5 }, { x: 11, y: 5 }
            ];
        }
        
        // ============================================
        // ISOMETRIC RENDERING
        // ============================================
        
        function toIso(x, y) {
            return {
                x: (x - y) * (TILE_WIDTH / 2),
                y: (x + y) * (TILE_HEIGHT / 2)
            };
        }
        
        function fromIso(isoX, isoY) {
            return {
                x: (isoX / (TILE_WIDTH / 2) + isoY / (TILE_HEIGHT / 2)) / 2,
                y: (isoY / (TILE_HEIGHT / 2) - isoX / (TILE_WIDTH / 2)) / 2
            };
        }
        
        // ============================================
        // SPRITE RENDERING WITH LIVE ANIMATIONS
        // ============================================
        
        function drawAgentSprite(agent, screenX, screenY, scale) {
            const size = 20 * scale;
            
            // Animation offsets based on activity
            let bounce = 0;
            let typingOffset = 0;
            
            if (agent.animation === 'typing' && agent.intensity === 'high') {
                // Fast typing animation
                bounce = Math.sin(Date.now() / 50) * 1.5 * scale;
                typingOffset = Math.sin(Date.now() / 30) * 2 * scale;
            } else if (agent.animation === 'typing') {
                // Normal typing
                bounce = Math.sin(Date.now() / 100) * 1 * scale;
                typingOffset = Math.sin(Date.now() / 60) * 1 * scale;
            } else if (agent.isMoving) {
                // Walking animation
                bounce = Math.sin(agent.walkCycle * 0.5) * 3 * scale;
            } else if (agent.animation === 'idle') {
                // Idle breathing
                bounce = Math.sin(Date.now() / 500) * 0.5 * scale;
            } else if (agent.animation === 'meeting') {
                // Meeting/talking animation
                bounce = Math.sin(Date.now() / 200) * 1 * scale;
            }
            
            const x = screenX + typingOffset;
            const y = screenY - size - bounce;
            
            // Shadow
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.beginPath();
            ctx.ellipse(screenX, screenY, size * 0.6, size * 0.2, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Status glow for active agents
            if (agent.status === 'active') {
                const glowIntensity = agent.intensity === 'high' ? 0.4 : 0.2;
                ctx.shadowColor = agent.color;
                ctx.shadowBlur = 10 * glowIntensity;
            }
            
            // Body color
            const bodyColor = agent.color;
            const darkColor = adjustColor(bodyColor, -30);
            
            // Body
            ctx.fillStyle = bodyColor;
            ctx.fillRect(x - size/2, y, size, size * 0.9);
            
            // Reset shadow
            ctx.shadowBlur = 0;
            
            // Head
            const headSize = size * 0.7;
            const headY = y - headSize + 3;
            ctx.fillStyle = '#ffdbac';
            ctx.fillRect(x - headSize/2, headY, headSize, headSize);
            
            // Face - animated based on activity
            ctx.fillStyle = '#333';
            if (agent.animation === 'typing') {
                // Focused expression - looking down
                ctx.fillRect(x - 3, headY + 10, 2, 2);
                ctx.fillRect(x + 1, headY + 10, 2, 2);
            } else if (agent.animation === 'meeting') {
                // Talking - mouth open
                ctx.fillRect(x - 3, headY + 8, 2, 2);
                ctx.fillRect(x + 1, headY + 8, 2, 2);
                ctx.fillStyle = '#c44';
                ctx.fillRect(x - 1, headY + 12, 2, 1);
            } else {
                // Normal
                ctx.fillRect(x - 3, headY + 8, 2, 2);
                ctx.fillRect(x + 1, headY + 8, 2, 2);
            }
            
            // Hair/Hat
            ctx.fillStyle = darkColor;
            ctx.fillRect(x - headSize/2 - 1, headY - 2, headSize + 2, 4);
            
            // Arms - animated for typing
            if (agent.animation === 'typing') {
                ctx.fillStyle = bodyColor;
                // Arms raised for typing
                const armOffset = Math.sin(Date.now() / 40) * 2;
                ctx.fillRect(x - size/2 - 3, y + 3 + armOffset, 3, size * 0.4);
                ctx.fillRect(x + size/2, y + 3 - armOffset, 3, size * 0.4);
            } else if (agent.isMoving) {
                const walkOffset = Math.sin(agent.walkCycle) * 3 * scale;
                ctx.fillStyle = bodyColor;
                ctx.fillRect(x - size/2 - 3, y + 3 + walkOffset, 3, size * 0.4);
                ctx.fillRect(x + size/2, y + 3 - walkOffset, 3, size * 0.4);
            } else {
                ctx.fillStyle = bodyColor;
                ctx.fillRect(x - size/2 - 3, y + 3, 3, size * 0.4);
                ctx.fillRect(x + size/2, y + 3, 3, size * 0.4);
            }
            
            // Legs
            if (agent.isMoving) {
                const legOffset = Math.sin(agent.walkCycle) * 4 * scale;
                ctx.fillStyle = '#333';
                ctx.fillRect(x - size/3, y + size * 0.7, size/3 - 1, size * 0.3 + legOffset);
                ctx.fillRect(x + 1, y + size * 0.7, size/3 - 1, size * 0.3 - legOffset);
            } else {
                ctx.fillStyle = '#333';
                ctx.fillRect(x - size/3, y + size * 0.7, size/3 - 1, size * 0.3);
                ctx.fillRect(x + 1, y + size * 0.7, size/3 - 1, size * 0.3);
            }
            
            // Commander crown
            if (agent.id === 'ericf') {
                ctx.fillStyle = '#ffd700';
                ctx.fillRect(x - 6, headY - 6, 12, 4);
                ctx.fillRect(x - 4, headY - 10, 3, 4);
                ctx.fillRect(x + 1, headY - 10, 3, 4);
                
                // Glow effect
                ctx.shadowColor = '#ffd700';
                ctx.shadowBlur = 15;
                ctx.strokeStyle = '#ffd700';
                ctx.strokeRect(x - size/2 - 1, y - 1, size + 2, size + headSize);
                ctx.shadowBlur = 0;
            }
            
            // Nexus AI pod glow
            if (agent.id === 'nexus') {
                ctx.shadowColor = '#00d4ff';
                ctx.shadowBlur = 20;
                ctx.fillStyle = 'rgba(0, 212, 255, 0.3)';
                ctx.beginPath();
                ctx.arc(x, y + size/2, size, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;
            }
        }
        
        function drawFurniture(fur, x, y, scale) {
            const size = TILE_WIDTH * scale;
            const zoneColor = ZONE_COLORS[fur.zone] || '#888';
            
            // Check if any agent in this zone is active
            const zoneAgents = office.agents.filter(a => a.zone === fur.zone);
            const hasActiveAgent = zoneAgents.some(a => a.status === 'active');
            const activeIntensity = zoneAgents.reduce((sum, a) => 
                sum + (a.status === 'active' ? (a.intensity === 'high' ? 3 : 1) : 0), 0);
            
            switch(fur.type) {
                case 'desk':
                    // Desk glows when agent is active
                    if (hasActiveAgent) {
                        ctx.shadowColor = zoneColor;
                        ctx.shadowBlur = 5 + activeIntensity * 2;
                    }
                    ctx.fillStyle = '#8b7355';
                    ctx.fillRect(x - size/2, y - size/4, size, size/2);
                    
                    // Computer screen
                    const screenColor = hasActiveAgent ? zoneColor : '#333';
                    ctx.fillStyle = screenColor;
                    ctx.fillRect(x - 8, y - size/3 - 12, 16, 10);
                    
                    // Screen glow for active agents
                    if (hasActiveAgent) {
                        ctx.shadowColor = zoneColor;
                        ctx.shadowBlur = 10;
                        ctx.fillStyle = zoneColor;
                        ctx.globalAlpha = 0.3 + (Math.sin(Date.now() / 200) * 0.2);
                        ctx.fillRect(x - 8, y - size/3 - 12, 16, 10);
                        ctx.globalAlpha = 1;
                        ctx.shadowBlur = 0;
                    }
                    break;
                    
                case 'server':
                    ctx.fillStyle = '#2d3748';
                    ctx.fillRect(x - size/3, y - size/2, size/1.5, size);
                    const blink = Math.sin(Date.now() / 150) > 0;
                    ctx.fillStyle = blink ? '#22c55e' : '#166534';
                    ctx.fillRect(x - size/3 + 3, y - size/2 + 3, 4, 4);
                    break;
                    
                case 'conference':
                    ctx.fillStyle = '#654321';
                    ctx.fillRect(x - size, y - size/3, size * 2, size/1.5);
                    break;
                    
                case 'commander_desk':
                    // Special commander desk
                    ctx.fillStyle = '#4a3728';
                    ctx.fillRect(x - size, y - size/3, size * 2, size/1.5);
                    // Commander glow
                    ctx.shadowColor = '#ffd700';
                    ctx.shadowBlur = 15;
                    ctx.fillStyle = '#ffd700';
                    ctx.globalAlpha = 0.2 + (Math.sin(Date.now() / 500) * 0.1);
                    ctx.fillRect(x - size + 2, y - size/3 + 2, size * 2 - 4, size/1.5 - 4);
                    ctx.globalAlpha = 1;
                    ctx.shadowBlur = 0;
                    break;
                    
                case 'nexus_pod':
                    // Nexus AI pod with pulsing effect
                    const pulse = 0.5 + (Math.sin(Date.now() / 300) * 0.3);
                    ctx.shadowColor = '#00d4ff';
                    ctx.shadowBlur = 20 * pulse;
                    ctx.fillStyle = `rgba(0, 212, 255, ${0.3 + pulse * 0.3})`;
                    ctx.beginPath();
                    ctx.arc(x, y, size/2, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.shadowBlur = 0;
                    break;
            }
            
            ctx.shadowBlur = 0;
        }
        
        function drawTile(tile, x, y, scale) {
            const w = TILE_WIDTH * scale;
            const h = TILE_HEIGHT * scale;
            
            // Zone highlighting based on system load
            let baseColor = tile.type === 'floor1' ? '#1a1a2e' : '#252540';
            
            if (state.systemLoad.level === 'critical') {
                // Red tint for critical load
                baseColor = tile.type === 'floor1' ? '#2a1a1e' : '#352530';
            } else if (state.systemLoad.level === 'high') {
                // Orange tint for high load
                baseColor = tile.type === 'floor1' ? '#2a201e' : '#352a25';
            }
            
            ctx.fillStyle = baseColor;
            ctx.beginPath();
            ctx.moveTo(x, y - h/2);
            ctx.lineTo(x + w/2, y);
            ctx.lineTo(x, y + h/2);
            ctx.lineTo(x - w/2, y);
            ctx.closePath();
            ctx.fill();
            
            ctx.strokeStyle = '#0f0f1a';
            ctx.lineWidth = 1;
            ctx.stroke();
        }
        
        // ============================================
        // ACTIVITY BAR & SPEECH BUBBLES
        // ============================================
        
        function drawActivityBar(agent, x, y, scale) {
            const w = 40 * scale;
            const h = 4 * scale;
            const bx = x - w/2;
            const by = y - 50 * scale;
            
            // Background
            ctx.fillStyle = 'rgba(0,0,0,0.8)';
            ctx.fillRect(bx - 2, by - 14, w + 4, 22);
            
            // Name with emoji based on activity
            ctx.fillStyle = '#fff';
            ctx.font = `${Math.floor(7 * scale)}px 'Press Start 2P'`;
            ctx.textAlign = 'center';
            
            const activityEmoji = {
                typing: '‚å®Ô∏è',
                working: 'üíª',
                meeting: 'üìû',
                idle: '‚òï',
                walking: 'üö∂',
                watching: 'üëÅÔ∏è'
            }[agent.animation] || 'üíª';
            
            ctx.fillText(activityEmoji + ' ' + agent.name, x, by - 2);
            
            // Progress bar showing task completion
            ctx.fillStyle = '#333';
            ctx.fillRect(bx, by + 2, w, h);
            
            const colors = {
                typing: '#00d4ff',
                working: '#22c55e',
                meeting: '#a855f7',
                idle: '#fbbf24',
                walking: '#f97316'
            };
            
            ctx.fillStyle = colors[agent.animation] || '#00d4ff';
            
            // Animate progress based on activity
            let progress = (agent.activityTimer % 100) / 100;
            if (agent.currentTask) {
                progress = agent.currentTask.progress / 100;
            }
            
            ctx.fillRect(bx, by + 2, w * progress, h);
            
            // Intensity indicator
            if (agent.intensity === 'high') {
                ctx.fillStyle = '#ff2a6d';
                ctx.fillRect(bx + w + 2, by + 2, 3, h);
            }
        }
        
        function drawSpeechBubble(agent, x, y, scale) {
            if (!agent.speechBubble) return;
            
            ctx.font = `${Math.floor(8 * scale)}px 'VT323'`;
            const text = agent.speechBubble;
            const width = ctx.measureText(text).width + 12;
            const height = 18 * scale;
            const bx = x - width/2;
            const by = y - 60 * scale - height;
            
            // Bubble background
            ctx.fillStyle = 'rgba(255,255,255,0.95)';
            ctx.fillRect(bx, by, width, height);
            
            // Border
            ctx.strokeStyle = agent.color || '#333';
            ctx.lineWidth = 2;
            ctx.strokeRect(bx, by, width, height);
            
            // Text
            ctx.fillStyle = '#333';
            ctx.textAlign = 'left';
            ctx.fillText(text, bx + 6, by + 12 * scale);
            
            // Pointer
            ctx.fillStyle = agent.color || '#333';
            ctx.beginPath();
            ctx.moveTo(x - 4, by + height);
            ctx.lineTo(x + 4, by + height);
            ctx.lineTo(x, by + height + 6);
            ctx.closePath();
            ctx.fill();
        }
        
        // ============================================
        // PARTICLES
        // ============================================
        
        function createParticle(x, y, type, color) {
            const colors = {
                work: [color, '#22c55e'],
                meeting: ['#a855f7', '#ec4899'],
                completed: ['#22c55e', '#fbbf24'],
                typing: ['#00d4ff', '#22c55e']
            };
            const colorSet = colors[type] || colors.work;
            
            return {
                x, y,
                vx: (Math.random() - 0.5) * 1.5,
                vy: -Math.random() * 1.5 - 0.5,
                life: 1,
                decay: 0.02,
                color: colorSet[Math.floor(Math.random() * colorSet.length)],
                size: 2
            };
        }
        
        function updateParticles() {
            office.particles = office.particles.filter(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.life -= p.decay;
                return p.life > 0;
            });
        }
        
        function drawParticles() {
            office.particles.forEach(p => {
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, p.size, p.size);
            });
            ctx.globalAlpha = 1;
        }
        
        // ============================================
        // RENDER LOOP
        // ============================================
        
        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const cx = canvas.width / 2 + state.panX;
            const cy = canvas.height / 2 + state.panY;
            const scale = state.zoom;
            
            const renderList = [];
            
            // Collect tiles
            office.tiles.forEach(tile => {
                const iso = toIso(tile.x, tile.y);
                renderList.push({
                    type: 'tile',
                    obj: tile,
                    y: tile.y,
                    screenX: cx + iso.x * scale,
                    screenY: cy + iso.y * scale
                });
            });
            
            // Collect furniture
            office.furniture.forEach(fur => {
                const iso = toIso(fur.x, fur.y);
                renderList.push({
                    type: 'furniture',
                    obj: fur,
                    y: fur.y,
                    screenX: cx + iso.x * scale,
                    screenY: cy + iso.y * scale
                });
            });
            
            // Collect agents
            office.agents.forEach(agent => {
                const iso = toIso(agent.pixelX / TILE_WIDTH, agent.pixelY / TILE_HEIGHT);
                renderList.push({
                    type: 'agent',
                    obj: agent,
                    y: agent.pixelY / TILE_HEIGHT,
                    screenX: cx + iso.x * scale,
                    screenY: cy + iso.y * scale
                });
            });
            
            // Sort by depth
            renderList.sort((a, b) => a.y - b.y);
            
            // Render
            renderList.forEach(item => {
                switch(item.type) {
                    case 'tile':
                        drawTile(item.obj, item.screenX, item.screenY, scale);
                        break;
                    case 'furniture':
                        drawFurniture(item.obj, item.screenX, item.screenY, scale);
                        break;
                    case 'agent':
                        drawAgentSprite(item.obj, item.screenX, item.screenY, scale);
                        drawActivityBar(item.obj, item.screenX, item.screenY, scale);
                        drawSpeechBubble(item.obj, item.screenX, item.screenY, scale);
                        
                        // Particles for active agents
                        if (state.particlesEnabled && item.obj.status === 'active' && Math.random() < 0.02) {
                            office.particles.push(createParticle(
                                item.screenX, item.screenY - 25 * scale, 
                                item.obj.animation, item.obj.color
                            ));
                        }
                        break;
                }
            });
            
            if (state.particlesEnabled) drawParticles();
            
            // Standup highlight
            if (state.standupMode) {
                office.standupSeats.forEach(seat => {
                    const iso = toIso(seat.x, seat.y);
                    const x = cx + iso.x * scale;
                    const y = cy + iso.y * scale;
                    ctx.fillStyle = 'rgba(251, 191, 36, 0.2)';
                    ctx.beginPath();
                    ctx.moveTo(x, y - TILE_HEIGHT * scale / 2);
                    ctx.lineTo(x + TILE_WIDTH * scale / 2, y);
                    ctx.lineTo(x, y + TILE_HEIGHT * scale / 2);
                    ctx.lineTo(x - TILE_WIDTH * scale / 2, y);
                    ctx.closePath();
                    ctx.fill();
                });
            }
        }
        
        // ============================================
        // GAME LOGIC - LIVE ACTIVITY
        // ============================================
        
        function updateAgents(deltaTime) {
            office.agents.forEach(agent => {
                agent.walkCycle += deltaTime * 0.01;
                agent.activityTimer += deltaTime * 0.01;
                
                // Decrease speech timer
                if (agent.speechTimer > 0) {
                    agent.speechTimer -= deltaTime;
                    if (agent.speechTimer <= 0) {
                        agent.speechBubble = null;
                    }
                }
                
                // Random speech bubbles for active agents
                if (!agent.speechBubble && agent.status === 'active' && Math.random() < 0.0005) {
                    const messages = {
                        typing: ['Typing...', 'Coding...', 'On it!', 'Almost done!'],
                        working: ['Working...', 'In progress', 'Designing...'],
                        meeting: ['In meeting', 'Discussing...', 'On call'],
                        idle: ['Waiting...', 'Taking a break', 'Ready!']
                    };
                    const msgs = messages[agent.animation] || ['Working...'];
                    agent.speechBubble = msgs[Math.floor(Math.random() * msgs.length)];
                    agent.speechTimer = 3000;
                }
                
                // Movement logic
                if (!agent.isMoving && Math.random() < 0.001) {
                    const tx = agent.targetX + (Math.random() - 0.5) * TILE_WIDTH * 3;
                    const ty = agent.targetY + (Math.random() - 0.5) * TILE_HEIGHT * 3;
                    
                    if (tx > 0 && tx < GRID_SIZE * TILE_WIDTH &&
                        ty > 0 && ty < GRID_SIZE * TILE_HEIGHT) {
                        agent.targetX = tx;
                        agent.targetY = ty;
                        agent.isMoving = true;
                        
                        const dx = tx - agent.pixelX;
                        const dy = ty - agent.pixelY;
                        agent.direction = Math.abs(dx) > Math.abs(dy) 
                            ? (dx > 0 ? 2 : 1) 
                            : (dy > 0 ? 0 : 3);
                    }
                }
                
                // Move agent
                if (agent.isMoving) {
                    const dx = agent.targetX - agent.pixelX;
                    const dy = agent.targetY - agent.pixelY;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    
                    if (dist < 1) {
                        agent.isMoving = false;
                        agent.pixelX = agent.targetX;
                        agent.pixelY = agent.targetY;
                    } else {
                        const speed = agent.intensity === 'high' ? 0.8 : 0.5;
                        agent.pixelX += (dx / dist) * speed;
                        agent.pixelY += (dy / dist) * speed;
                    }
                }
            });
        }
        
        function gameLoop(currentTime) {
            const deltaTime = currentTime - state.lastTime;
            state.lastTime = currentTime;
            
            updateAgents(deltaTime);
            updateParticles();
            render();
            
            requestAnimationFrame(gameLoop);
        }
        
        // ============================================
        // INPUT HANDLING
        // ============================================
        
        function getMousePos(evt) {
            const rect = canvas.getBoundingClientRect();
            return { x: evt.clientX - rect.left, y: evt.clientY - rect.top };
        }
        
        function screenToWorld(sx, sy) {
            const cx = canvas.width / 2 + state.panX;
            const cy = canvas.height / 2 + state.panY;
            return fromIso((sx - cx) / state.zoom, (sy - cy) / state.zoom);
        }
        
        canvas.addEventListener('mousedown', e => {
            state.isDragging = true;
            state.lastMouseX = e.clientX;
            state.lastMouseY = e.clientY;
            
            const pos = getMousePos(e);
            const world = screenToWorld(pos.x, pos.y);
            
            office.agents.forEach(agent => {
                const ax = agent.pixelX / TILE_WIDTH;
                const ay = agent.pixelY / TILE_HEIGHT;
                if (Math.hypot(world.x - ax, world.y - ay) < 0.7) {
                    selectAgent(agent);
                }
            });
        });
        
        canvas.addEventListener('mousemove', e => {
            const pos = getMousePos(e);
            
            if (state.isDragging) {
                state.panX += e.clientX - state.lastMouseX;
                state.panY += e.clientY - state.lastMouseY;
                state.lastMouseX = e.clientX;
                state.lastMouseY = e.clientY;
            }
            
            const world = screenToWorld(pos.x, pos.y);
            let hovered = null;
            
            office.agents.forEach(agent => {
                const ax = agent.pixelX / TILE_WIDTH;
                const ay = agent.pixelY / TILE_HEIGHT;
                if (Math.hypot(world.x - ax, world.y - ay) < 0.7) {
                    hovered = agent;
                }
            });
            
            state.hoveredAgent = hovered;
            updateTooltip(hovered, e.clientX, e.clientY);
        });
        
        canvas.addEventListener('mouseup', () => state.isDragging = false);
        canvas.addEventListener('mouseleave', () => {
            state.isDragging = false;
            state.hoveredAgent = null;
            document.getElementById('tooltip').style.display = 'none';
        });
        
        canvas.addEventListener('wheel', e => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            state.zoom = Math.max(0.5, Math.min(3, state.zoom * delta));
        });
        
        // Touch support
        canvas.addEventListener('touchstart', e => {
            e.preventDefault();
            const t = e.touches[0];
            state.isDragging = true;
            state.lastMouseX = t.clientX;
            state.lastMouseY = t.clientY;
        });
        
        canvas.addEventListener('touchmove', e => {
            e.preventDefault();
            if (state.isDragging) {
                const t = e.touches[0];
                state.panX += t.clientX - state.lastMouseX;
                state.panY += t.clientY - state.lastMouseY;
                state.lastMouseX = t.clientX;
                state.lastMouseY = t.clientY;
            }
        });
        
        canvas.addEventListener('touchend', () => state.isDragging = false);
        
        // ============================================
        // UI FUNCTIONS
        // ============================================
        
        function zoomIn() { state.zoom = Math.min(3, state.zoom * 1.2); }
        function zoomOut() { state.zoom = Math.max(0.5, state.zoom / 1.2); }
        function resetView() { state.zoom = 1; state.panX = 0; state.panY = 0; }
        
        function toggleStandup() {
            state.standupMode = !state.standupMode;
            
            office.agents.forEach((agent, i) => {
                if (state.standupMode && i < office.standupSeats.length) {
                    const seat = office.standupSeats[i];
                    agent.targetX = seat.x * TILE_WIDTH;
                    agent.targetY = seat.y * TILE_HEIGHT;
                    agent.isMoving = true;
                    agent.animation = 'meeting';
                } else if (!state.standupMode) {
                    const pos = agent.position || { x: 10, y: 10 };
                    agent.targetX = pos.x * TILE_WIDTH;
                    agent.targetY = pos.y * TILE_HEIGHT;
                    agent.isMoving = true;
                    agent.animation = agent.activityType || 'idle';
                }
            });
        }
        
        function togglePanel() {
            document.getElementById('sidePanel').classList.toggle('open');
        }
        
        function toggleParticles() {
            state.particlesEnabled = !state.particlesEnabled;
        }
        
        function selectAgent(agent) {
            state.selectedAgent = agent;
            agent.speechBubble = 'Yes, Commander?';
            agent.speechTimer = 2000;
            
            // Update popup
            showAgentPopup(agent);
            
            // Update list selection
            document.querySelectorAll('.agent-list-item').forEach(el => {
                el.classList.toggle('active', el.dataset.id === agent.id);
            });
        }
        
        function showAgentPopup(agent) {
            const popup = document.getElementById('agentPopup');
            const overlay = document.getElementById('popupOverlay');
            
            document.getElementById('popupAvatar').textContent = agent.emoji;
            document.getElementById('popupAvatar').style.background = agent.color + '20';
            document.getElementById('popupAvatar').style.borderColor = agent.color;
            
            document.getElementById('popupName').textContent = agent.name;
            document.getElementById('popupRole').textContent = agent.role;
            
            document.getElementById('popupTokens').textContent = (agent.tokensToday || 0).toLocaleString();
            document.getElementById('popupTasks').textContent = agent.tasksCompleted || 0;
            document.getElementById('popupEfficiency').textContent = (agent.efficiency || 0) + '%';
            
            const statusEl = document.getElementById('popupStatus');
            statusEl.textContent = agent.status === 'active' ? '‚óè' : '‚óã';
            statusEl.style.color = agent.status === 'active' ? '#22c55e' : '#888';
            
            if (agent.currentTask) {
                document.getElementById('popupTask').textContent = agent.currentTask.title;
                document.getElementById('popupPriority').textContent = agent.currentTask.priority;
                document.getElementById('popupPriority').className = 'popup-task-priority priority-' + agent.currentTask.priority;
                document.getElementById('popupProgressText').textContent = agent.currentTask.progress + '%';
                document.getElementById('popupProgressBar').style.width = agent.currentTask.progress + '%';
            } else {
                document.getElementById('popupTask').textContent = 'No active task';
                document.getElementById('popupPriority').textContent = '';
                document.getElementById('popupProgressText').textContent = '0%';
                document.getElementById('popupProgressBar').style.width = '0%';
            }
            
            popup.classList.add('active');
            overlay.classList.add('active');
        }
        
        function closePopup() {
            document.getElementById('agentPopup').classList.remove('active');
            document.getElementById('popupOverlay').classList.remove('active');
        }
        
        function viewAgentWork() {
            if (state.selectedAgent) {
                window.open(`mission-control/dashboard/agent-data.html?agent=${state.selectedAgent.id}`, '_blank');
            }
        }
        
        function updateTooltip(agent, x, y) {
            const tt = document.getElementById('tooltip');
            if (agent) {
                document.getElementById('tooltipTitle').textContent = agent.name;
                document.getElementById('tooltipRole').textContent = agent.role;
                
                const taskText = agent.currentTask ? agent.currentTask.title : agent.activity;
                document.getElementById('tooltipTask').textContent = taskText;
                
                const priorityEl = document.getElementById('tooltipPriority');
                if (agent.currentTask) {
                    priorityEl.textContent = agent.currentTask.priority;
                    priorityEl.className = 'tooltip-priority priority-' + agent.currentTask.priority;
                    priorityEl.style.display = 'inline-block';
                } else {
                    priorityEl.style.display = 'none';
                }
                
                tt.style.display = 'block';
                tt.style.left = (x + 10) + 'px';
                tt.style.top = (y + 10) + 'px';
            } else {
                tt.style.display = 'none';
            }
        }
        
        function renderAgentList() {
            const list = document.getElementById('agentList');
            list.innerHTML = '';
            
            office.agents.forEach(agent => {
                const item = document.createElement('div');
                item.className = 'agent-list-item';
                item.dataset.id = agent.id;
                
                const activityClass = agent.animation || 'idle';
                
                item.innerHTML = `
                    <div class="agent-list-avatar" style="background: ${agent.color}20; border-color: ${agent.color};">
                        ${agent.emoji}
                        <div class="activity-indicator ${activityClass}"></div>
                    </div>
                    <div class="agent-list-info">
                        <div class="agent-list-name">${agent.name}</div>
                        <div class="agent-list-role">${agent.role}</div>
                    </div>
                    <div class="agent-list-status ${agent.status}"></div>
                `;
                
                item.onclick = () => {
                    selectAgent(agent);
                    const iso = toIso(agent.pixelX / TILE_WIDTH, agent.pixelY / TILE_HEIGHT);
                    state.panX = -iso.x * state.zoom;
                    state.panY = -iso.y * state.zoom;
                };
                
                list.appendChild(item);
            });
            
            document.getElementById('agentCount').textContent = office.agents.length;
        }
        
        function addActivity(type, agent, msg) {
            const feed = document.getElementById('activityFeed');
            const item = document.createElement('div');
            item.className = 'activity-item';
            
            const icons = { 
                working: 'üíª', 
                meeting: 'üìû', 
                completed: '‚úÖ', 
                system: '‚ö°',
                typing: '‚å®Ô∏è',
                idle: '‚òï'
            };
            
            const time = new Date().toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit', 
                hour12: false 
            });
            
            item.innerHTML = `
                <span>${icons[type] || 'üíª'}</span>
                <div style="flex: 1;"><span class="activity-agent">${agent}</span> ${msg}</div>
                <span class="activity-time">${time}</span>
            `;
            
            feed.insertBefore(item, feed.firstChild);
            while (feed.children.length > 15) feed.removeChild(feed.lastChild);
        }
        
        function callStandup() {
            toggleStandup();
            addActivity('meeting', 'System', 'Daily standup ' + (state.standupMode ? 'started' : 'ended'));
        }
        
        function findAgent() {
            if (office.agents.length === 0) return;
            const agent = office.agents[Math.floor(Math.random() * office.agents.length)];
            selectAgent(agent);
            const iso = toIso(agent.pixelX / TILE_WIDTH, agent.pixelY / TILE_HEIGHT);
            state.panX = -iso.x * state.zoom;
            state.panY = -iso.y * state.zoom;
        }
        
        // ============================================
        // UTILITIES
        // ============================================
        
        function adjustColor(color, amount) {
            const num = parseInt(color.replace('#', ''), 16);
            const r = Math.min(255, Math.max(0, (num >> 16) + amount));
            const g = Math.min(255, Math.max(0, ((num >> 8) & 0x00FF) + amount));
            const b = Math.min(255, Math.max(0, (num & 0x0000FF) + amount));
            return `#${((r << 16) | (g << 8) | b).toString(16).padStart(6, '0')}`;
        }
        
        function resizeCanvas() {
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }
        
        function updateLoadingStatus(text) {
            document.getElementById('loadingStatus').textContent = text;
        }
        
        // ============================================
        // INIT
        // ============================================
        
        async function init() {
            // Loading animation
            const progress = document.getElementById('loadingProgress');
            let pct = 0;
            const interval = setInterval(() => {
                pct += 20;
                progress.style.width = pct + '%';
                if (pct >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        document.getElementById('loadingScreen').classList.add('hidden');
                    }, 200);
                }
            }, 40);
            
            initOffice();
            resizeCanvas();
            
            // Try to connect to API
            updateLoadingStatus('Connecting to live data...');
            await syncWithAPI();
            
            // Start loop
            requestAnimationFrame(gameLoop);
            
            // Auto-refresh every 30 seconds
            setInterval(() => {
                syncWithAPI();
            }, API_CONFIG.refreshInterval);
            
            // Periodic activity updates
            setInterval(() => {
                if (state.apiConnected && state.liveData) {
                    const agents = state.liveData.agents.filter(a => a.status === 'active');
                    if (agents.length > 0) {
                        const agent = agents[Math.floor(Math.random() * agents.length)];
                        const activities = ['updated task', 'committed code', 'reviewed PR', 'deployed feature'];
                        addActivity('working', agent.name, activities[Math.floor(Math.random() * activities.length)]);
                    }
                }
            }, 10000);
            
            window.addEventListener('resize', resizeCanvas);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', e => {
                if (e.key === '+' || e.key === '=') zoomIn();
                if (e.key === '-') zoomOut();
                if (e.key === '0') resetView();
                if (e.key === 'm' || e.key === 'M') toggleStandup();
                if (e.key === 'r' || e.key === 'R') forceRefresh();
                if (e.key === 'Escape') closePopup();
            });
        }
        
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
