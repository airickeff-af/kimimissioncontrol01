<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="Isometric Pixel Office - Mission Control">
    <meta name="theme-color" content="#2d1b4e">
    <title>üéÆ Pixel Office | Mission Control</title>
    
    <!-- Kairosoft Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-primary: #f5e6c8;
            --bg-secondary: #e8d4a8;
            --bg-card: #fff8e7;
            --panel-bg: #f4e4c1;
            --panel-border: #8b7355;
            --panel-shadow: #5c4a3a;
            --text-dark: #2c1810;
            --text-light: #f4e4c1;
            --text-secondary: #6b5a45;
            --accent-cyan: #00d4ff;
            --accent-pink: #ff6b6b;
            --accent-green: #51cf66;
            --accent-blue: #339af0;
            --accent-yellow: #fcc419;
            --accent-purple: #da77f2;
            --accent-orange: #ff8787;
            --floor-color: #d4c4a8;
            --wall-color: #c4b498;
            --desk-color: #8b7355;
            --plant-green: #51cf66;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; image-rendering: pixelated; }
        
        body {
            font-family: 'VT323', monospace;
            background: var(--bg-primary);
            color: var(--text-dark);
            min-height: 100vh;
            line-height: 1.4;
            overflow-x: hidden;
        }
        
        /* Pixel Grid Background */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                linear-gradient(rgba(0, 212, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 212, 255, 0.03) 1px, transparent 1px);
            background-size: 60px 60px;
            pointer-events: none;
            z-index: 0;
        }
        
        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 4px solid var(--panel-border);
            box-shadow: 0 4px 0 var(--panel-shadow);
            padding: 0 1rem;
            min-height: 70px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .logo {
            width: 40px;
            height: 40px;
            background: var(--panel-border);
            border: 3px solid var(--text-dark);
            box-shadow: 3px 3px 0 var(--text-dark);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        
        .brand-text h1 {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.65rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            line-height: 1.4;
        }
        
        .brand-text span {
            font-size: 0.65rem;
            color: var(--text-secondary);
        }
        
        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .nav-tab {
            padding: 6px 10px;
            background: var(--bg-card);
            border: 3px solid var(--panel-border);
            border-radius: 6px;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.45rem;
            color: var(--text-dark);
            text-decoration: none;
            text-align: center;
            line-height: 1.3;
            box-shadow: 0 3px 0 var(--panel-shadow);
            transition: all 0.1s;
        }
        
        .nav-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 0 var(--panel-shadow);
        }
        
        .nav-tab.active {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: white;
        }
        
        /* Main Container */
        .container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px;
        }
        
        /* Office Canvas Container */
        .office-container {
            background: var(--bg-card);
            border: 4px solid var(--panel-border);
            box-shadow: 4px 4px 0 var(--panel-shadow);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .office-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--panel-border);
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .office-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.6rem;
            color: var(--panel-border);
        }
        
        .action-btns {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 8px 14px;
            background: var(--bg-secondary);
            border: 3px solid var(--panel-border);
            border-radius: 6px;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.5rem;
            color: var(--text-dark);
            cursor: pointer;
            box-shadow: 0 3px 0 var(--panel-shadow);
            transition: all 0.1s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 0 var(--panel-shadow);
        }
        
        .btn-primary {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: white;
        }
        
        .btn-secondary {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        #officeCanvas {
            width: 100%;
            height: 600px;
            background: linear-gradient(135deg, #e8ddd0 0%, #d4c4a8 100%);
            border: 3px solid var(--panel-border);
            border-radius: 4px;
            cursor: grab;
        }
        
        #officeCanvas:active {
            cursor: grabbing;
        }
        
        .canvas-overlay {
            position: absolute;
            top: 60px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.5rem;
            pointer-events: none;
            z-index: 10;
        }
        
        .fps-counter {
            color: var(--accent-green);
        }
        
        /* Info Panel */
        .info-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .panel {
            background: var(--bg-card);
            border: 4px solid var(--panel-border);
            box-shadow: 4px 4px 0 var(--panel-shadow);
            border-radius: 8px;
            padding: 15px;
        }
        
        .panel-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.6rem;
            color: var(--panel-border);
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--panel-border);
        }
        
        .agent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 8px;
        }
        
        .agent-mini {
            background: var(--bg-secondary);
            border: 2px solid var(--panel-border);
            border-radius: 6px;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .agent-mini:hover {
            transform: scale(1.1);
            border-color: var(--accent-cyan);
        }
        
        .agent-mini.selected {
            border-color: var(--accent-green);
            background: rgba(81, 207, 102, 0.2);
        }
        
        .agent-mini-emoji {
            font-size: 1.5rem;
        }
        
        .agent-mini-name {
            font-size: 0.7rem;
            margin-top: 4px;
        }
        
        /* Hierarchy Table Styles */
        .hierarchy-table-container {
            max-height: 400px;
            overflow-y: auto;
            background: var(--bg-secondary);
            border: 3px solid var(--panel-border);
            border-radius: 4px;
        }
        
        .hierarchy-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        
        .hierarchy-table th {
            background: var(--panel-border);
            color: var(--text-light);
            padding: 12px 10px;
            text-align: left;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.5rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .hierarchy-table td {
            padding: 10px;
            border-bottom: 1px solid var(--panel-border);
        }
        
        .hierarchy-table tr:hover {
            background: rgba(0, 212, 255, 0.1);
        }
        
        .hierarchy-table tr.commander {
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.2), transparent);
        }
        
        .hierarchy-table tr.ai-lead {
            background: linear-gradient(90deg, rgba(0, 212, 255, 0.15), transparent);
        }
        
        .hierarchy-table tr.team-lead {
            background: linear-gradient(90deg, rgba(81, 207, 102, 0.1), transparent);
        }
        
        .hierarchy-agent {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .hierarchy-emoji {
            font-size: 1.25rem;
        }
        
        .hierarchy-name {
            font-weight: 600;
        }
        
        .level-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.45rem;
            border: 2px solid;
        }
        
        .level-commander {
            background: rgba(255, 215, 0, 0.2);
            color: #b8860b;
            border-color: #ffd700;
        }
        
        .level-ai-lead {
            background: rgba(0, 212, 255, 0.2);
            color: #0066cc;
            border-color: #00d4ff;
        }
        
        .level-team-lead {
            background: rgba(81, 207, 102, 0.2);
            color: #2b8a3e;
            border-color: #51cf66;
        }
        
        .level-specialist {
            background: rgba(139, 115, 85, 0.2);
            color: var(--panel-border);
            border-color: var(--panel-border);
        }
        
        .status-dot-table {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .status-active { background: var(--accent-green); }
        .status-busy { background: var(--accent-yellow); }
        .status-idle { background: var(--accent-pink); }
        
        .btn-locate {
            padding: 6px 10px;
            background: var(--accent-cyan);
            border: 2px solid var(--text-dark);
            border-radius: 4px;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.45rem;
            color: white;
            cursor: pointer;
            box-shadow: 2px 2px 0 var(--text-dark);
            transition: all 0.1s;
        }
        
        .btn-locate:hover {
            transform: translateY(-2px);
            box-shadow: 2px 4px 0 var(--text-dark);
        }
        
        .btn-locate:active {
            transform: translateY(0);
            box-shadow: 0 0 0 var(--text-dark);
        }
        
        /* Activity Log */
        .activity-list {
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.9rem;
        }
        
        .activity-item {
            padding: 8px;
            margin-bottom: 5px;
            background: var(--bg-secondary);
            border-left: 3px solid var(--accent-cyan);
            border-radius: 0 4px 4px 0;
        }
        
        .activity-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        /* Selected Agent Panel */
        .selected-agent-panel {
            position: fixed;
            right: 20px;
            top: 100px;
            width: 280px;
            background: var(--bg-card);
            border: 4px solid var(--panel-border);
            box-shadow: 4px 4px 0 var(--panel-shadow);
            border-radius: 8px;
            padding: 15px;
            z-index: 50;
            display: none;
        }
        
        .selected-agent-panel.active {
            display: block;
        }
        
        .selected-agent-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--panel-border);
        }
        
        .selected-agent-emoji {
            font-size: 2rem;
        }
        
        .selected-agent-info h3 {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.6rem;
            margin-bottom: 4px;
        }
        
        .selected-agent-info span {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--panel-border);
        }
        
        .stat-row:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .stat-value {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.5rem;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: var(--bg-card);
            border: 4px solid var(--panel-border);
            box-shadow: 8px 8px 0 var(--panel-shadow);
            border-radius: 8px;
            padding: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid var(--panel-border);
        }
        
        .modal-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.7rem;
            color: var(--panel-border);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-dark);
        }
        
        .insight-box {
            background: var(--bg-secondary);
            border: 3px solid var(--accent-yellow);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .insight-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.6rem;
            color: var(--accent-yellow);
            margin-bottom: 10px;
        }
        
        /* Loading state */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20;
            border-radius: 4px;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--panel-border);
            border-top-color: var(--accent-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header { padding: 10px; }
            .nav-tabs { display: none; }
            .office-header { flex-direction: column; align-items: flex-start; }
            #officeCanvas { height: 400px; }
            .info-panel { grid-template-columns: 1fr; }
            .selected-agent-panel {
                position: fixed;
                right: 10px;
                left: 10px;
                top: auto;
                bottom: 10px;
                width: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="brand">
            <div class="logo">üéÆ</div>
            <div class="brand-text">
                <h1>Pixel Office</h1>
                <span id="agentCount">22 Agents ‚Ä¢ Isometric View</span>
            </div>
        </div>
        
        <nav class="nav-tabs">
            <a href="index.html" class="nav-tab">üè† HQ</a>
            <a href="office.html" class="nav-tab">üè¢ Office</a>
            <a href="pixel-office.html" class="nav-tab active">üéÆ Pixel</a>
            <a href="agents.html" class="nav-tab">üë• Agents</a>
            <a href="dealflow-view.html" class="nav-tab">üíº Deals</a>
            <a href="token-tracker.html" class="nav-tab">ü™ô Tokens</a>
            <a href="task-board.html" class="nav-tab">üìã Tasks</a>
            <a href="data-viewer.html" class="nav-tab">üìÅ Data</a>
        </nav>
    </header>
    
    <!-- Main Container -->
    <div class="container">
        <!-- Office Canvas -->
        <div class="office-container" style="position: relative;">
            <div class="office-header">
                <span class="office-title">üè¢ ISOMETRIC OFFICE - <span id="liveAgentCount">22</span> AGENTS</span>
                <div class="action-btns">
                    <button class="btn btn-primary" onclick="startStandup()">üì¢ STANDUP</button>
                    <button class="btn btn-secondary" onclick="toggleView()">üëÅÔ∏è FOLLOW</button>
                    <button class="btn" onclick="resetView()">üîÑ RESET</button>
                    <button class="btn" onclick="togglePause()" id="pauseBtn">‚è∏Ô∏è PAUSE</button>
                </div>
            </div>
            <canvas id="officeCanvas"></canvas>
            <div class="canvas-overlay">
                <div class="fps-counter">FPS: <span id="fpsCounter">60</span></div>
                <div>Selected: <span id="selectedAgentName">None</span></div>
            </div>
        </div>
        
        <!-- Hierarchy Table Panel -->
        <div class="office-container">
            <div class="office-header">
                <span class="office-title">üëë AGENT HIERARCHY</span>
                <div class="action-btns">
                    <button class="btn" onclick="refreshData()">üîÑ REFRESH</button>
                </div>
            </div>
            <div class="hierarchy-table-container">
                <table class="hierarchy-table" id="hierarchyTable">
                    <thead>
                        <tr>
                            <th>Level</th>
                            <th>Agent</th>
                            <th>Role</th>
                            <th>Team</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="hierarchyBody">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Info Panels -->
        <div class="info-panel">
            <!-- Agent Mini Grid -->
            <div class="panel">
                <div class="panel-title">üë• AGENT ROSTER (<span id="rosterCount">22</span>)</div>
                <div class="agent-grid" id="agentGrid"></div>
            </div>
            
            <!-- Activity Log -->
            <div class="panel">
                <div class="panel-title">üì° ACTIVITY LOG</div>
                <div class="activity-list" id="activityLog"></div>
            </div>
        </div>
    </div>
    
    <!-- Selected Agent Panel -->
    <div class="selected-agent-panel" id="selectedAgentPanel">
        <div class="selected-agent-header">
            <span class="selected-agent-emoji" id="panelEmoji">ü§ñ</span>
            <div class="selected-agent-info">
                <h3 id="panelName">Agent Name</h3>
                <span id="panelRole">Role</span>
            </div>
        </div>
        <div class="stat-row">
            <span class="stat-label">Status</span>
            <span class="stat-value" id="panelStatus">Active</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Tasks</span>
            <span class="stat-value" id="panelTasks">0</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Tokens</span>
            <span class="stat-value" id="panelTokens">0</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Success Rate</span>
            <span class="stat-value" id="panelSuccess">0%</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Last Active</span>
            <span class="stat-value" id="panelLastActive">-</span>
        </div>
        <button class="btn btn-secondary" style="width: 100%; margin-top: 10px;" onclick="closeSelectedPanel()">Close</button>
    </div>
    
    <!-- Standup Modal -->
    <div class="modal" id="standupModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">üì¢ DAILY STANDUP - REAL DATA</span>
                <button class="modal-close" onclick="closeStandupModal()">&times;</button>
            </div>
            <div id="standupContent">
                <div id="standupStats"></div>
                <div id="standupInsights"></div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // PIXEL OFFICE - TASK-092 IMPLEMENTATION
        // Features: 60fps animations, real API, canvas selection
        // ============================================
        
        // ============================================
        // CONFIGURATION
        // ============================================
        const CONFIG = {
            FPS: 60,
            SPRITE_SIZE: 32,
            WALK_SPEED: 0.8,
            ANIMATION_SPEED: 0.15,
            API_BASE: '', // Relative to current domain
            REFRESH_INTERVAL: 30000, // 30 seconds
        };
        
        // ============================================
        // AGENT DATA - Will be populated from API
        // ============================================
        let AGENTS_DATA = [];
        let TASKS_DATA = [];
        let ACTIVITY_LOGS = [];
        
        // ============================================
        // CANVAS SETUP
        // ============================================
        const canvas = document.getElementById('officeCanvas');
        const ctx = canvas.getContext('2d');
        
        let scale = 1;
        let offsetX = 0;
        let offsetY = 0;
        let isDragging = false;
        let dragStartX, dragStartY;
        let followAgent = null;
        let selectedAgent = null;
        let isPaused = false;
        
        // Animation state
        let lastTime = 0;
        let frameCount = 0;
        let fps = 60;
        let lastFpsTime = 0;
        
        // Speech bubbles
        let speechBubbles = [];
        
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth - 30;
            canvas.height = window.innerWidth < 768 ? 400 : 600;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // ============================================
        // PIXEL SPRITE GENERATOR (Minecraft-style)
        // ============================================
        
        const SPRITE_CACHE = new Map();
        
        function generatePixelSprite(agent, frame = 0, direction = 'down', state = 'idle') {
            const cacheKey = `${agent.id}_${frame}_${direction}_${state}`;
            if (SPRITE_CACHE.has(cacheKey)) {
                return SPRITE_CACHE.get(cacheKey);
            }
            
            const size = CONFIG.SPRITE_SIZE;
            const spriteCanvas = document.createElement('canvas');
            spriteCanvas.width = size;
            spriteCanvas.height = size;
            const sCtx = spriteCanvas.getContext('2d');
            
            // Disable smoothing for pixel art look
            sCtx.imageSmoothingEnabled = false;
            
            // Base color
            const baseColor = agent.color || '#888888';
            const darkColor = shadeColor(baseColor, -30);
            const lightColor = shadeColor(baseColor, 30);
            
            // Animation offsets
            const walkOffset = state === 'walking' ? Math.sin(frame * 0.5) * 2 : 0;
            const bounceOffset = state === 'idle' ? Math.sin(frame * 0.2) * 1 : 0;
            
            // Draw pixel body (16x16 scaled to 32x32)
            const pixelSize = 2;
            const startX = 8;
            const startY = 8 + bounceOffset;
            
            // Body shadow
            sCtx.fillStyle = 'rgba(0,0,0,0.3)';
            sCtx.fillRect(startX + 2, startY + 14, 12, 4);
            
            // Body (computer/character shape)
            sCtx.fillStyle = baseColor;
            // Main body block
            sCtx.fillRect(startX, startY + 4, 16, 12);
            // Head/screen area
            sCtx.fillRect(startX + 2, startY, 12, 6);
            
            // Screen glow
            sCtx.fillStyle = lightColor;
            sCtx.fillRect(startX + 3, startY + 1, 10, 4);
            
            // Eyes/face on screen
            sCtx.fillStyle = '#000';
            if (direction === 'right') {
                sCtx.fillRect(startX + 8, startY + 2, 3, 2);
            } else if (direction === 'left') {
                sCtx.fillRect(startX + 5, startY + 2, 3, 2);
            } else {
                sCtx.fillRect(startX + 5, startY + 2, 2, 2);
                sCtx.fillRect(startX + 9, startY + 2, 2, 2);
            }
            
            // Legs (animated when walking)
            sCtx.fillStyle = darkColor;
            if (state === 'walking') {
                const legOffset = Math.abs(Math.sin(frame * 0.5)) * 3;
                sCtx.fillRect(startX + 2, startY + 14 + legOffset, 4, 4);
                sCtx.fillRect(startX + 10, startY + 14 - legOffset, 4, 4);
            } else {
                sCtx.fillRect(startX + 2, startY + 14, 4, 4);
                sCtx.fillRect(startX + 10, startY + 14, 4, 4);
            }
            
            // Status indicator dot
            const statusColors = {
                active: '#51cf66',
                busy: '#fcc419',
                idle: '#ff6b6b'
            };
            sCtx.fillStyle = statusColors[agent.status] || '#888';
            sCtx.fillRect(startX + 12, startY - 2, 4, 4);
            
            // Activity bar above agent (if has tasks)
            if (agent.tasksCompleted > 0) {
                const barWidth = 16;
                const barHeight = 2;
                const progress = Math.min(agent.tasksCompleted / 50, 1);
                
                sCtx.fillStyle = 'rgba(0,0,0,0.5)';
                sCtx.fillRect(startX, startY - 6, barWidth, barHeight);
                sCtx.fillStyle = progress > 0.7 ? '#51cf66' : progress > 0.4 ? '#fcc419' : '#ff6b6b';
                sCtx.fillRect(startX, startY - 6, barWidth * progress, barHeight);
            }
            
            SPRITE_CACHE.set(cacheKey, spriteCanvas);
            return spriteCanvas;
        }
        
        function shadeColor(color, percent) {
            const num = parseInt(color.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = Math.max(0, Math.min(255, (num >> 16) + amt));
            const G = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amt));
            const B = Math.max(0, Math.min(255, (num & 0x0000FF) + amt));
            return '#' + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
        }
        
        // ============================================
        // AGENT CLASS WITH ANIMATION
        // ============================================
        
        class Agent {
            constructor(data) {
                this.id = data.id;
                this.name = data.name;
                this.role = data.role;
                this.emoji = data.emoji;
                this.color = data.color || '#888888';
                this.status = data.status || 'idle';
                this.tasksCompleted = data.tasksCompleted || 0;
                this.tokensUsed = data.tokensUsed || 0;
                this.successRate = data.successRate || 0;
                this.lastActive = data.lastActive;
                this.team = data.team || 'General';
                this.level = data.level || 'specialist';
                
                // Position
                this.x = data.x || 0;
                this.y = data.y || 0;
                this.z = 0;
                
                // Animation state
                this.targetX = this.x;
                this.targetY = this.y;
                this.direction = 'down';
                this.state = 'idle';
                this.animationFrame = 0;
                this.walkCycle = 0;
                
                // Desk position (home base)
                this.deskX = this.x;
                this.deskY = this.y;
                
                // Speech bubble
                this.speechBubble = null;
                this.speechTimer = 0;
            }
            
            update(deltaTime) {
                // Update animation frame
                this.animationFrame += CONFIG.ANIMATION_SPEED;
                
                // Handle movement
                if (this.state === 'walking') {
                    const dx = this.targetX - this.x;
                    const dy = this.targetY - this.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < 0.5) {
                        this.x = this.targetX;
                        this.y = this.targetY;
                        this.state = 'idle';
                    } else {
                        const speed = CONFIG.WALK_SPEED * deltaTime * 0.06;
                        this.x += (dx / distance) * speed;
                        this.y += (dy / distance) * speed;
                        
                        // Update direction
                        if (Math.abs(dx) > Math.abs(dy)) {
                            this.direction = dx > 0 ? 'right' : 'left';
                        } else {
                            this.direction = dy > 0 ? 'down' : 'up';
                        }
                    }
                }
                
                // Update speech bubble timer
                if (this.speechTimer > 0) {
                    this.speechTimer -= deltaTime;
                    if (this.speechTimer <= 0) {
                        this.speechBubble = null;
                    }
                }
            }
            
            moveTo(x, y) {
                this.targetX = x;
                this.targetY = y;
                this.state = 'walking';
            }
            
            returnToDesk() {
                this.moveTo(this.deskX, this.deskY);
            }
            
            say(message, duration = 3000) {
                this.speechBubble = message;
                this.speechTimer = duration;
            }
            
            draw(ctx, isoX, isoY) {
                const sprite = generatePixelSprite(this, this.animationFrame, this.direction, this.state);
                
                // Draw sprite
                const size = CONFIG.SPRITE_SIZE;
                ctx.drawImage(sprite, isoX - size/2, isoY - size);
                
                // Draw name label
                ctx.font = '10px "Press Start 2P"';
                ctx.fillStyle = '#2c1810';
                ctx.textAlign = 'center';
                ctx.fillText(this.name, isoX, isoY + 15);
                
                // Draw selection highlight
                if (selectedAgent === this.id) {
                    ctx.strokeStyle = '#00d4ff';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(isoX - size/2 - 2, isoY - size - 2, size + 4, size + 4);
                }
                
                // Draw speech bubble
                if (this.speechBubble) {
                    drawSpeechBubble(ctx, isoX, isoY - size - 10, this.speechBubble);
                }
            }
        }
        
        // ============================================
        // ISOMETRIC UTILITIES
        // ============================================
        
        function toIso(x, y, z = 0) {
            const isoX = (x - y) * 0.866 * scale + canvas.width / 2 + offsetX;
            const isoY = (x + y) * 0.5 * scale - z * 0.866 * scale + canvas.height / 2 + offsetY;
            return { x: isoX, y: isoY };
        }
        
        function fromIso(isoX, isoY) {
            const centerX = canvas.width / 2 + offsetX;
            const centerY = canvas.height / 2 + offsetY;
            const x = ((isoX - centerX) / 0.866 + (isoY - centerY)) / (2 * scale);
            const y = ((isoY - centerY) - (isoX - centerX) / 0.866) / (2 * scale);
            return { x, y };
        }
        
        function drawSpeechBubble(ctx, x, y, text) {
            ctx.font = '8px "Press Start 2P"';
            const metrics = ctx.measureText(text);
            const padding = 8;
            const width = metrics.width + padding * 2;
            const height = 20;
            
            // Bubble background
            ctx.fillStyle = 'white';
            ctx.strokeStyle = '#2c1810';
            ctx.lineWidth = 2;
            
            ctx.beginPath();
            ctx.roundRect(x - width/2, y - height, width, height, 4);
            ctx.fill();
            ctx.stroke();
            
            // Triangle pointer
            ctx.beginPath();
            ctx.moveTo(x - 5, y);
            ctx.lineTo(x + 5, y);
            ctx.lineTo(x, y + 5);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // Text
            ctx.fillStyle = '#2c1810';
            ctx.textAlign = 'center';
            ctx.fillText(text, x, y - height/2 + 3);
        }
        
        // ============================================
        // OFFICE LAYOUT
        // ============================================
        
        const agents = new Map();
        
        const OFFICE_LAYOUT = {
            // Commander
            ericf: { x: -8, y: -6, team: 'Executive', level: 'commander' },
            // AI Lead
            nexus: { x: 4, y: -6, team: 'Executive', level: 'ai-lead' },
            // Dev team
            codemaster: { x: -7, y: 2, team: 'Engineering', level: 'team-lead' },
            'code-1': { x: -4, y: 2, team: 'Engineering', level: 'specialist' },
            'code-2': { x: -7, y: 4.5, team: 'Engineering', level: 'specialist' },
            'code-3': { x: -4, y: 4.5, team: 'Engineering', level: 'specialist' },
            // Design team
            forge: { x: 3, y: -3, team: 'Design', level: 'team-lead' },
            pixel: { x: 6, y: -3, team: 'Design', level: 'team-lead' },
            'forge-2': { x: 3, y: -0.5, team: 'Design', level: 'specialist' },
            'forge-3': { x: 6, y: -0.5, team: 'Design', level: 'specialist' },
            // Research
            glasses: { x: -3, y: -2, team: 'Research', level: 'team-lead' },
            // Content
            quill: { x: -2, y: 3, team: 'Content', level: 'specialist' },
            // Marketing
            gary: { x: 2, y: 3, team: 'Marketing', level: 'specialist' },
            larry: { x: 4, y: 4, team: 'Marketing', level: 'specialist' },
            buzz: { x: 6, y: 4, team: 'Marketing', level: 'specialist' },
            // Operations
            sentry: { x: -4, y: -1, team: 'Operations', level: 'team-lead' },
            cipher: { x: -3, y: 2, team: 'Security', level: 'specialist' },
            // QA
            audit: { x: 3, y: -2, team: 'Quality', level: 'team-lead' },
            // Sales
            dealflow: { x: 4, y: -3, team: 'Sales', level: 'team-lead' },
            coldcall: { x: 7, y: -2, team: 'Sales', level: 'specialist' },
            // Intel
            scout: { x: 2, y: -4, team: 'Intelligence', level: 'team-lead' },
            pie: { x: 5, y: -5, team: 'Intelligence', level: 'specialist' }
        };
        
        // ============================================
        // DRAWING FUNCTIONS
        // ============================================
        
        function drawFloor() {
            for (let x = -12; x <= 12; x += 2) {
                for (let y = -12; y <= 12; y += 2) {
                    const p1 = toIso(x, y, 0);
                    const p2 = toIso(x + 2, y, 0);
                    const p3 = toIso(x + 2, y + 2, 0);
                    const p4 = toIso(x, y + 2, 0);
                    
                    ctx.fillStyle = ((x + y) / 2) % 2 === 0 ? '#d4c4a8' : '#c4b498';
                    ctx.beginPath();
                    ctx.moveTo(p1.x, p1.y);
                    ctx.lineTo(p2.x, p2.y);
                    ctx.lineTo(p3.x, p3.y);
                    ctx.lineTo(p4.x, p4.y);
                    ctx.closePath();
                    ctx.fill();
                    
                    ctx.strokeStyle = 'rgba(139, 115, 85, 0.2)';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                }
            }
        }
        
        function drawIsoRect(x, y, z, w, d, h, color) {
            const p1 = toIso(x, y, z);
            const p2 = toIso(x + w, y, z);
            const p3 = toIso(x + w, y + d, z);
            const p4 = toIso(x, y + d, z);
            const p5 = toIso(x, y, z + h);
            const p6 = toIso(x + w, y, z + h);
            const p7 = toIso(x + w, y + d, z + h);
            const p8 = toIso(x, y + d, z + h);
            
            // Top face
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.moveTo(p5.x, p5.y);
            ctx.lineTo(p6.x, p6.y);
            ctx.lineTo(p7.x, p7.y);
            ctx.lineTo(p8.x, p8.y);
            ctx.closePath();
            ctx.fill();
            ctx.strokeStyle = 'rgba(0,0,0,0.2)';
            ctx.lineWidth = 1;
            ctx.stroke();
            
            // Front face
            ctx.fillStyle = shadeColor(color, -20);
            ctx.beginPath();
            ctx.moveTo(p1.x, p1.y);
            ctx.lineTo(p2.x, p2.y);
            ctx.lineTo(p6.x, p6.y);
            ctx.lineTo(p5.x, p5.y);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // Side face
            ctx.fillStyle = shadeColor(color, -40);
            ctx.beginPath();
            ctx.moveTo(p2.x, p2.y);
            ctx.lineTo(p3.x, p3.y);
            ctx.lineTo(p7.x, p7.y);
            ctx.lineTo(p6.x, p6.y);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
        }
        
        function drawCommanderDesk(x, y) {
            drawIsoRect(x, y, 0, 4, 3, 1.5, '#8b6914');
            drawIsoRect(x + 0.2, y + 0.2, 1.5, 3.6, 2.6, 0.2, '#ffd700');
            drawIsoRect(x + 1, y + 0.5, 1.7, 0.8, 0.3, 0.6, '#2d3436');
            drawIsoRect(x + 1.1, y + 0.6, 2.3, 0.6, 0.1, 0.4, '#00d4ff');
            
            const pos = toIso(x + 2, y + 1.5, 2.5);
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('üëë', pos.x, pos.y);
        }
        
        function drawNexusDesk(x, y) {
            drawIsoRect(x, y, 0, 4, 3, 1.5, '#4a5568');
            drawIsoRect(x + 0.2, y + 0.2, 1.5, 3.6, 2.6, 0.2, '#00d4ff');
            drawIsoRect(x + 0.5, y + 0.3, 1.7, 1, 0.2, 0.8, '#2d3436');
            drawIsoRect(x + 1.8, y + 0.3, 1.7, 1, 0.2, 0.8, '#2d3436');
            drawIsoRect(x + 0.5, y + 1.5, 1.7, 1, 0.2, 0.8, '#2d3436');
            
            const pos = toIso(x + 2, y + 1.5, 2.5);
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('ü§ñ', pos.x, pos.y);
        }
        
        function drawAgentDesk(x, y, color) {
            drawIsoRect(x, y, 0, 2.5, 2, 1, '#8b7355');
            drawIsoRect(x + 0.1, y + 0.1, 1, 2.3, 1.8, 0.15, color);
            drawIsoRect(x + 0.3, y + 0.3, 1.15, 0.6, 0.15, 0.4, '#2d3436');
            drawIsoRect(x + 0.35, y + 0.35, 1.55, 0.5, 0.05, 0.3, '#74b9ff');
        }
        
        function drawMeetingTable(x, y) {
            drawIsoRect(x, y, 0, 5, 3, 0.8, '#5c4a3a');
            drawIsoRect(x + 0.2, y + 0.2, 0.8, 4.6, 2.6, 0.1, '#8b7355');
            
            const chairPositions = [
                [x - 1, y + 1], [x + 5, y + 1],
                [x + 1, y - 1], [x + 3, y - 1],
                [x + 1, y + 3], [x + 3, y + 3]
            ];
            
            chairPositions.forEach(pos => {
                drawIsoRect(pos[0], pos[1], 0, 0.8, 0.8, 0.6, '#6b5a45');
            });
            
            const centerPos = toIso(x + 2.5, y + 1.5, 1);
            ctx.font = 'bold 10px "Press Start 2P"';
            ctx.fillStyle = '#fff';
            ctx.textAlign = 'center';
            ctx.fillText('üì¢ MEETING', centerPos.x, centerPos.y);
        }
        
        function drawPingPongTable(x, y) {
            drawIsoRect(x, y, 0, 4, 2.5, 0.8, '#2d3436');
            drawIsoRect(x + 0.1, y + 0.1, 0.8, 3.8, 2.3, 0.1, '#00b894');
            drawIsoRect(x + 1.9, y, 0.9, 0.2, 2.5, 0.4, '#fff');
            
            const labelPos = toIso(x + 2, y - 0.5, 0.5);
            ctx.font = '8px "Press Start 2P"';
            ctx.fillStyle = '#fff';
            ctx.fillText('PING PONG', labelPos.x, labelPos.y);
        }
        
        function drawPlant(x, y, size = 1) {
            drawIsoRect(x, y, 0, 0.8 * size, 0.8 * size, 0.6 * size, '#8b4513');
            const plantPos = toIso(x + 0.4, y + 0.4, 0.6 * size);
            ctx.font = `${20 * size}px Arial`;
            ctx.textAlign = 'center';
            ctx.fillText('ü™¥', plantPos.x, plantPos.y);
        }
        
        // ============================================
        // MAIN DRAW LOOP
        // ============================================
        
        function drawOffice() {
            // Clear canvas
            ctx.fillStyle = '#2d3436';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            drawFloor();
            
            // Plants
            drawPlant(-9, -9, 1.2);
            drawPlant(8, -9, 1);
            drawPlant(-9, 8, 1);
            drawPlant(8, 8, 1.2);
            drawPlant(-5, -9, 0.8);
            drawPlant(4, 8, 0.8);
            
            // Commander desk
            drawCommanderDesk(-8, -6);
            
            // Nexus desk
            drawNexusDesk(4, -6);
            
            // Meeting table
            drawMeetingTable(-2.5, -1.5);
            
            // Ping pong table
            drawPingPongTable(3, 4);
            
            // Agent desks by team
            const teamColors = {
                'Engineering': '#22c55e',
                'Design': '#f97316',
                'Research': '#3b82f6',
                'Content': '#ec4899',
                'Marketing': '#f59e0b',
                'Operations': '#22c55e',
                'Quality': '#8b5cf6',
                'Sales': '#10b981',
                'Intelligence': '#00d4ff',
                'Security': '#6366f1'
            };
            
            // Draw team desks
            Object.entries(OFFICE_LAYOUT).forEach(([id, layout]) => {
                if (id !== 'ericf' && id !== 'nexus') {
                    const color = teamColors[layout.team] || '#8b7355';
                    drawAgentDesk(layout.x, layout.y, color);
                }
            });
            
            // Draw agents (sorted by Y for proper depth)
            const sortedAgents = Array.from(agents.values()).sort((a, b) => a.y - b.y);
            sortedAgents.forEach(agent => {
                const pos = toIso(agent.x, agent.y, 0);
                agent.draw(ctx, pos.x, pos.y);
            });
        }
        
        // ============================================
        // ANIMATION LOOP (60fps)
        // ============================================
        
        function animate(currentTime) {
            const deltaTime = currentTime - lastTime;
            lastTime = currentTime;
            
            // Calculate FPS
            frameCount++;
            if (currentTime - lastFpsTime >= 1000) {
                fps = frameCount;
                frameCount = 0;
                lastFpsTime = currentTime;
                document.getElementById('fpsCounter').textContent = fps;
            }
            
            if (!isPaused) {
                // Update agents
                agents.forEach(agent => agent.update(deltaTime));
                
                // Handle follow camera
                if (followAgent && agents.has(followAgent)) {
                    const agent = agents.get(followAgent);
                    const targetPos = toIso(agent.x, agent.y, 0);
                    const centerX = canvas.width / 2;
                    const centerY = canvas.height / 2;
                    offsetX += (centerX - targetPos.x) * 0.05;
                    offsetY += (centerY - targetPos.y) * 0.05;
                }
            }
            
            drawOffice();
            requestAnimationFrame(animate);
        }
        
        // ============================================
        // API INTEGRATION
        // ============================================
        
        async function fetchAgents() {
            try {
                const response = await fetch('/api/agents');
                const data = await response.json();
                
                if (data.success && data.agents) {
                    AGENTS_DATA = data.agents.map(agent => ({
                        ...agent,
                        color: getAgentColor(agent.id),
                        emoji: getAgentEmoji(agent.id),
                        team: getAgentTeam(agent.id),
                        level: getAgentLevel(agent.id),
                        ...OFFICE_LAYOUT[agent.id]
                    }));
                    
                    // Update or create agent instances
                    AGENTS_DATA.forEach(data => {
                        if (agents.has(data.id)) {
                            const agent = agents.get(data.id);
                            agent.status = data.status;
                            agent.tasksCompleted = data.tasksCompleted;
                            agent.tokensUsed = data.tokensUsed;
                            agent.successRate = data.successRate;
                            agent.lastActive = data.lastActive;
                        } else {
                            agents.set(data.id, new Agent(data));
                        }
                    });
                    
                    updateUI();
                    addActivity('üîÑ', 'System', `loaded ${AGENTS_DATA.length} agents from API`, 'system');
                }
            } catch (error) {
                console.error('Failed to fetch agents:', error);
                addActivity('‚ùå', 'System', 'failed to load agents from API', 'error');
                
                // Use fallback data
                initializeFallbackAgents();
            }
        }
        
        async function fetchTasks() {
            try {
                const response = await fetch('/api/tasks?limit=100');
                const data = await response.json();
                
                if (data.success && data.tasks) {
                    TASKS_DATA = data.tasks;
                    addActivity('üìã', 'System', `loaded ${TASKS_DATA.length} tasks`, 'system');
                }
            } catch (error) {
                console.error('Failed to fetch tasks:', error);
            }
        }
        
        async function fetchActivityLogs() {
            try {
                const response = await fetch('/api/logs/activity?limit=20');
                const data = await response.json();
                
                if (data.success && data.logs) {
                    ACTIVITY_LOGS = data.logs;
                    
                    // Add recent logs to activity panel
                    data.logs.slice(0, 5).forEach(log => {
                        const emoji = getActivityEmoji(log.type);
                        addActivity(emoji, log.agent, log.message, log.type);
                    });
                }
            } catch (error) {
                console.error('Failed to fetch activity logs:', error);
            }
        }
        
        function getAgentColor(id) {
            const colors = {
                ericf: '#ffd700', nexus: '#00d4ff', codemaster: '#22c55e',
                'code-1': '#22c55e', 'code-2': '#22c55e', 'code-3': '#22c55e',
                forge: '#f97316', 'forge-2': '#f97316', 'forge-3': '#f97316',
                pixel: '#a855f7', glasses: '#3b82f6', quill: '#ec4899',
                gary: '#f59e0b', larry: '#06b6d4', buzz: '#fbbf24',
                sentry: '#22c55e', audit: '#8b5cf6', cipher: '#6366f1',
                dealflow: '#10b981', coldcall: '#f97316', scout: '#00d4ff',
                pie: '#8b5cf6'
            };
            return colors[id] || '#888888';
        }
        
        function getAgentEmoji(id) {
            const emojis = {
                ericf: 'üëë', nexus: 'ü§ñ', codemaster: 'üíª',
                'code-1': '‚ö°', 'code-2': 'üîß', 'code-3': 'üîå',
                forge: 'üî®', 'forge-2': 'üé®', 'forge-3': '‚ú®',
                pixel: 'üé®', glasses: 'üîç', quill: '‚úçÔ∏è',
                gary: 'üì¢', larry: 'üì±', buzz: 'üêù',
                sentry: 'üõ°Ô∏è', audit: 'üîç', cipher: 'üîê',
                dealflow: 'ü§ù', coldcall: 'üìû', scout: 'üî≠',
                pie: 'üß†'
            };
            return emojis[id] || 'ü§ñ';
        }
        
        function getAgentTeam(id) {
            return OFFICE_LAYOUT[id]?.team || 'General';
        }
        
        function getAgentLevel(id) {
            return OFFICE_LAYOUT[id]?.level || 'specialist';
        }
        
        function getActivityEmoji(type) {
            const emojis = {
                task_start: 'üöÄ', task_complete: '‚úÖ', research: 'üîç',
                write: '‚úçÔ∏è', design: 'üé®', code: 'üíª', deploy: 'üöÄ',
                audit: 'üîç', security_scan: 'üîí', system: '‚öôÔ∏è'
            };
            return emojis[type] || 'üìã';
        }
        
        function initializeFallbackAgents() {
            const fallbackData = [
                { id: 'ericf', name: 'EricF', role: 'Commander', status: 'active', tasksCompleted: 0, tokensUsed: 0, successRate: 100 },
                { id: 'nexus', name: 'Nexus', role: 'Orchestrator', status: 'active', tasksCompleted: 45, tokensUsed: 8400000, successRate: 94 },
                { id: 'codemaster', name: 'CodeMaster', role: 'Backend Lead', status: 'busy', tasksCompleted: 35, tokensUsed: 1200000, successRate: 93 },
                { id: 'forge', name: 'Forge', role: 'UI Lead', status: 'active', tasksCompleted: 38, tokensUsed: 1350000, successRate: 93 },
                { id: 'pixel', name: 'Pixel', role: 'Design Lead', status: 'active', tasksCompleted: 31, tokensUsed: 2500000, successRate: 92 },
                { id: 'glasses', name: 'Glasses', role: 'Research Lead', status: 'active', tasksCompleted: 31, tokensUsed: 2000000, successRate: 94 },
                { id: 'quill', name: 'Quill', role: 'Writer', status: 'idle', tasksCompleted: 27, tokensUsed: 380000, successRate: 89 },
                { id: 'gary', name: 'Gary', role: 'Marketing', status: 'idle', tasksCompleted: 19, tokensUsed: 340000, successRate: 86 },
                { id: 'sentry', name: 'Sentry', role: 'DevOps Lead', status: 'active', tasksCompleted: 42, tokensUsed: 560000, successRate: 96 },
                { id: 'audit', name: 'Audit', role: 'QA Lead', status: 'active', tasksCompleted: 28, tokensUsed: 770000, successRate: 96 },
                { id: 'dealflow', name: 'DealFlow', role: 'Sales Lead', status: 'busy', tasksCompleted: 52, tokensUsed: 7510000, successRate: 95 },
                { id: 'scout', name: 'Scout', role: 'Intel Lead', status: 'active', tasksCompleted: 15, tokensUsed: 80000, successRate: 87 }
            ];
            
            fallbackData.forEach(data => {
                const fullData = {
                    ...data,
                    color: getAgentColor(data.id),
                    emoji: getAgentEmoji(data.id),
                    team: getAgentTeam(data.id),
                    level: getAgentLevel(data.id),
                    ...OFFICE_LAYOUT[data.id]
                };
                agents.set(data.id, new Agent(fullData));
            });
            
            updateUI();
        }
        
        // ============================================
        // UI UPDATES
        // ============================================
        
        function updateUI() {
            document.getElementById('agentCount').textContent = `${agents.size} Agents ‚Ä¢ Isometric View`;
            document.getElementById('liveAgentCount').textContent = agents.size;
            document.getElementById('rosterCount').textContent = agents.size;
            
            renderAgentGrid();
            renderHierarchyTable();
        }
        
        function renderAgentGrid() {
            const grid = document.getElementById('agentGrid');
            grid.innerHTML = '';
            
            agents.forEach(agent => {
                const div = document.createElement('div');
                div.className = 'agent-mini' + (selectedAgent === agent.id ? ' selected' : '');
                div.innerHTML = `
                    <div class="agent-mini-emoji">${agent.emoji}</div>
                    <div class="agent-mini-name">${agent.name}</div>
                `;
                div.onclick = () => selectAgent(agent.id);
                grid.appendChild(div);
            });
        }
        
        function renderHierarchyTable() {
            const tbody = document.getElementById('hierarchyBody');
            if (!tbody) return;
            
            const levelOrder = { 'commander': 0, 'ai-lead': 1, 'team-lead': 2, 'specialist': 3 };
            const sortedAgents = Array.from(agents.values()).sort((a, b) => levelOrder[a.level] - levelOrder[b.level]);
            
            const levels = [
                { key: 'commander', label: 'Commander', class: 'level-commander' },
                { key: 'ai-lead', label: 'AI Lead', class: 'level-ai-lead' },
                { key: 'team-lead', label: 'Team Lead', class: 'level-team-lead' },
                { key: 'specialist', label: 'Specialist', class: 'level-specialist' }
            ];
            
            let html = '';
            levels.forEach(level => {
                const levelAgents = sortedAgents.filter(a => a.level === level.key);
                levelAgents.forEach(agent => {
                    const statusClass = agent.status === 'active' ? 'status-active' : 
                                      agent.status === 'busy' ? 'status-busy' : 'status-idle';
                    
                    html += `
                        <tr class="${agent.level}">
                            <td><span class="level-badge ${level.class}">${level.label}</span></td>
                            <td>
                                <div class="hierarchy-agent">
                                    <span class="hierarchy-emoji">${agent.emoji}</span>
                                    <span class="hierarchy-name">${agent.name}</span>
                                </div>
                            </td>
                            <td>${agent.role}</td>
                            <td>${agent.team}</td>
                            <td><span class="status-dot-table ${statusClass}"></span> ${agent.status}</td>
                            <td>
                                <button class="btn-locate" onclick="locateAgent('${agent.id}')">
                                    üéØ Locate
                                </button>
                            </td>
                        </tr>
                    `;
                });
            });
            
            tbody.innerHTML = html;
        }
        
        // ============================================
        // INTERACTION
        // ============================================
        
        function selectAgent(agentId) {
            selectedAgent = agentId;
            const agent = agents.get(agentId);
            
            if (agent) {
                document.getElementById('selectedAgentName').textContent = agent.name;
                document.getElementById('panelEmoji').textContent = agent.emoji;
                document.getElementById('panelName').textContent = agent.name;
                document.getElementById('panelRole').textContent = agent.role;
                document.getElementById('panelStatus').textContent = agent.status;
                document.getElementById('panelTasks').textContent = agent.tasksCompleted;
                document.getElementById('panelTokens').textContent = formatNumber(agent.tokensUsed);
                document.getElementById('panelSuccess').textContent = agent.successRate + '%';
                document.getElementById('panelLastActive').textContent = formatTime(agent.lastActive);
                document.getElementById('selectedAgentPanel').classList.add('active');
                
                renderAgentGrid();
                
                // Agent says hello
                agent.say('Hello!');
            }
        }
        
        function closeSelectedPanel() {
            document.getElementById('selectedAgentPanel').classList.remove('active');
            selectedAgent = null;
            document.getElementById('selectedAgentName').textContent = 'None';
            renderAgentGrid();
        }
        
        function locateAgent(agentId) {
            const agent = agents.get(agentId);
            if (!agent) return;
            
            selectAgent(agentId);
            
            // Animate camera to agent
            const targetIso = toIso(agent.x, agent.y, 0);
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const targetOffsetX = centerX - targetIso.x + offsetX;
            const targetOffsetY = centerY - targetIso.y + offsetY;
            
            animateCamera(targetOffsetX, targetOffsetY);
            addActivity('üéØ', 'System', `centered camera on ${agent.name}`, 'system');
        }
        
        function animateCamera(targetX, targetY) {
            const startX = offsetX;
            const startY = offsetY;
            const duration = 500;
            const startTime = performance.now();
            
            function animate(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const ease = 1 - Math.pow(1 - progress, 3);
                
                offsetX = startX + (targetX - startX) * ease;
                offsetY = startY + (targetY - startY) * ease;
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                }
            }
            
            requestAnimationFrame(animate);
        }
        
        // Canvas interactions
        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Check if clicked on an agent
            let clickedAgent = null;
            agents.forEach(agent => {
                const pos = toIso(agent.x, agent.y, 0);
                const dist = Math.sqrt((x - pos.x) ** 2 + (y - pos.y) ** 2);
                if (dist < 20) {
                    clickedAgent = agent.id;
                }
            });
            
            if (clickedAgent) {
                selectAgent(clickedAgent);
            } else {
                isDragging = true;
                dragStartX = e.clientX - offsetX;
                dragStartY = e.clientY - offsetY;
            }
        });
        
        canvas.addEventListener('mousemove', (e) => {
            if (isDragging) {
                offsetX = e.clientX - dragStartX;
                offsetY = e.clientY - dragStartY;
            }
        });
        
        canvas.addEventListener('mouseup', () => {
            isDragging = false;
        });
        
        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            scale += e.deltaY * -0.001;
            scale = Math.max(0.5, Math.min(2, scale));
        });
        
        // ============================================
        // CONTROLS
        // ============================================
        
        function toggleView() {
            followAgent = followAgent ? null : 'nexus';
            addActivity('üëÅÔ∏è', 'System', followAgent ? 'following Nexus' : 'free camera mode', 'system');
        }
        
        function resetView() {
            offsetX = 0;
            offsetY = 0;
            scale = 1;
            followAgent = null;
            addActivity('üîÑ', 'System', 'camera reset', 'system');
        }
        
        function togglePause() {
            isPaused = !isPaused;
            document.getElementById('pauseBtn').textContent = isPaused ? '‚ñ∂Ô∏è RESUME' : '‚è∏Ô∏è PAUSE';
            addActivity(isPaused ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è', 'System', isPaused ? 'animations paused' : 'animations resumed', 'system');
        }
        
        function refreshData() {
            fetchAgents();
            fetchTasks();
            fetchActivityLogs();
        }
        
        // ============================================
        // STANDUP FUNCTION
        // ============================================
        
        async function startStandup() {
            const modal = document.getElementById('standupModal');
            const content = document.getElementById('standupContent');
            
            // Fetch real data
            await fetchActivityLogs();
            
            const activeCount = Array.from(agents.values()).filter(a => a.status === 'active').length;
            const busyCount = Array.from(agents.values()).filter(a => a.status === 'busy').length;
            const idleCount = Array.from(agents.values()).filter(a => a.status === 'idle').length;
            
            const insights = generateInsights();
            
            let html = `
                <div style="margin-bottom: 20px;">
                    <h3 style="font-family: 'Press Start 2P'; font-size: 0.7rem; margin-bottom: 10px;">
                        üìä AGENT STATUS OVERVIEW
                    </h3>
                    <div style="background: var(--bg-secondary); padding: 10px; border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; color: var(--accent-green);">${activeCount}</div>
                                <div style="font-size: 0.7rem;">Active</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; color: var(--accent-yellow);">${busyCount}</div>
                                <div style="font-size: 0.7rem;">Busy</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; color: var(--accent-pink);">${idleCount}</div>
                                <div style="font-size: 0.7rem;">Idle</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3 style="font-family: 'Press Start 2P'; font-size: 0.7rem; margin-bottom: 10px;">
                        üí° AI-GENERATED INSIGHTS
                    </h3>
                    ${insights.map(insight => `
                        <div class="insight-box" style="border-color: ${insight.type === 'urgent' ? 'var(--accent-pink)' : insight.type === 'blocker' ? 'var(--accent-yellow)' : 'var(--accent-green)'};">
                            <div class="insight-title" style="color: ${insight.type === 'urgent' ? 'var(--accent-pink)' : insight.type === 'blocker' ? 'var(--accent-yellow)' : 'var(--accent-green)'};">
                                ${insight.title}
                            </div>
                            <p style="margin: 10px 0; font-size: 0.9rem;">${insight.text}</p>
                        </div>
                    `).join('')}
                </div>
            `;
            
            content.innerHTML = html;
            modal.classList.add('active');
            
            // Animate agents gathering at meeting table
            animateStandup();
        }
        
        function generateInsights() {
            const insights = [];
            const idleAgents = Array.from(agents.values()).filter(a => a.status === 'idle');
            const highTokenAgents = Array.from(agents.values()).filter(a => a.tokensUsed > 1000000);
            
            if (idleAgents.length > 3) {
                insights.push({
                    type: 'blocker',
                    title: '‚ö†Ô∏è Idle Agents Detected',
                    text: `${idleAgents.length} agents are idle: ${idleAgents.map(a => a.name).join(', ')}`
                });
            }
            
            if (highTokenAgents.length > 0) {
                insights.push({
                    type: 'efficiency',
                    title: 'üí∞ High Token Usage',
                    text: `${highTokenAgents.length} agents used >1M tokens. Consider optimization.`
                });
            }
            
            insights.push({
                type: 'info',
                title: '‚úÖ System Status',
                text: `All systems operational. ${agents.size} agents connected.`
            });
            
            return insights;
        }
        
        function animateStandup() {
            // Move agents to meeting table
            const meetingX = -2.5;
            const meetingY = -1.5;
            
            agents.forEach((agent, index) => {
                setTimeout(() => {
                    const angle = (index / agents.size) * Math.PI * 2;
                    const radius = 3;
                    agent.moveTo(meetingX + Math.cos(angle) * radius, meetingY + Math.sin(angle) * radius);
                    agent.say('Heading to standup!');
                }, index * 100);
            });
            
            // Return to desks after 10 seconds
            setTimeout(() => {
                agents.forEach(agent => agent.returnToDesk());
            }, 10000);
            
            addActivity('üì¢', 'Nexus', 'started daily standup', 'system');
        }
        
        function closeStandupModal() {
            document.getElementById('standupModal').classList.remove('active');
        }
        
        // ============================================
        // ACTIVITY LOG
        // ============================================
        
        function addActivity(emoji, agent, action, type = 'agent') {
            const log = document.getElementById('activityLog');
            const time = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
            
            const item = document.createElement('div');
            item.className = 'activity-item';
            item.innerHTML = `<span class="activity-time">${time}</span> ${emoji} <strong>${agent}</strong> ${action}`;
            
            log.insertBefore(item, log.firstChild);
            while (log.children.length > 20) log.removeChild(log.lastChild);
        }
        
        // ============================================
        // UTILITIES
        // ============================================
        
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }
        
        function formatTime(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            const now = new Date();
            const diff = Math.floor((now - date) / 60000);
            
            if (diff < 1) return 'Just now';
            if (diff < 60) return `${diff}m ago`;
            if (diff < 1440) return `${Math.floor(diff / 60)}h ago`;
            return `${Math.floor(diff / 1440)}d ago`;
        }
        
        // ============================================
        // INITIALIZATION
        // ============================================
        
        window.onload = function() {
            // Initialize with fallback data first
            initializeFallbackAgents();
            
            // Then try to fetch real data
            fetchAgents();
            fetchTasks();
            fetchActivityLogs();
            
            // Start animation loop
            requestAnimationFrame(animate);
            
            // Initial activities
            setTimeout(() => addActivity('ü§ñ', 'Nexus', 'initialized isometric office', 'system'), 500);
            setTimeout(() => addActivity('üëë', 'EricF', 'watching from commander desk', 'agent'), 1000);
            
            // Auto-refresh every 30 seconds
            setInterval(refreshData, CONFIG.REFRESH_INTERVAL);
        };
    </script>
</body>
</html>
