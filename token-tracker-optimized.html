<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Token Tracker - Mission Control">
    <meta name="theme-color" content="#0a0a0f">
    
    <!-- Preconnect to external domains -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <title>Token Tracker | Mission Control</title>
    
    <!-- Critical inline CSS -->
    <style>
        :root{--bg-primary:#0a0a0f;--bg-secondary:#111118;--bg-card:#15151d;--bg-elevated:#1e1e2a;--accent-cyan:#00d4ff;--accent-pink:#ff2a6d;--accent-purple:#a855f7;--accent-green:#22c55e;--accent-yellow:#fbbf24;--text-primary:#fafafa;--text-secondary:#a1a1aa;--text-muted:#71717a;--border:#27272a}
        *{margin:0;padding:0;box-sizing:border-box}
        html{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg-primary);color:var(--text-primary)}
        body{min-height:100vh}
        .header{background:rgba(17,17,24,.95);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:0 1.5rem;height:70px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100}
        .brand{display:flex;align-items:center;gap:1rem}
        .logo{width:42px;height:42px;background:linear-gradient(135deg,var(--accent-cyan),var(--accent-purple));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:800}
        .brand-text h1{font-size:1.25rem;font-weight:700}
        .brand-text span{font-size:.75rem;color:var(--text-muted)}
        .nav-tabs{display:flex;gap:.5rem;background:rgba(255,255,255,.05);padding:.5rem;border-radius:12px}
        .nav-tab{padding:.75rem 1.25rem;border:none;background:transparent;color:var(--text-secondary);font-size:.875rem;font-weight:500;cursor:pointer;border-radius:8px;transition:all .2s;text-decoration:none;display:flex;align-items:center;gap:.5rem}
        .nav-tab:hover{color:var(--text-primary);background:rgba(255,255,255,.05)}
        .nav-tab.active{color:var(--text-primary);background:linear-gradient(135deg,var(--accent-cyan),var(--accent-purple));box-shadow:0 4px 15px rgba(0,212,255,.3)}
        .main-content{padding:1.5rem;max-width:1400px;margin:0 auto}
        .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:1.5rem}
        .stat-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:1.25rem}
        .stat-label{font-size:.875rem;color:var(--text-muted);margin-bottom:.5rem}
        .stat-value{font-size:1.75rem;font-weight:700}
        .charts-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1.5rem;margin-bottom:1.5rem}
        .chart-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:1.5rem}
        .chart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
        .chart-title{font-size:1rem;font-weight:600}
        .chart-container{position:relative;height:250px}
        .chart-placeholder{background:var(--bg-elevated);border-radius:8px;height:250px;display:flex;align-items:center;justify-content:center;color:var(--text-muted)}
        .agent-comparison{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:1.5rem;margin-bottom:1.5rem}
        .comparison-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}
        .comparison-title{font-size:1.1rem;font-weight:600}
        .agent-bar{display:flex;align-items:center;gap:1rem;margin-bottom:1rem}
        .agent-info{display:flex;align-items:center;gap:.75rem;min-width:150px}
        .agent-emoji{font-size:1.5rem;width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:8px}
        .agent-name{font-weight:500;font-size:.9rem}
        .agent-role{font-size:.75rem;color:var(--text-muted)}
        .bar-container{flex:1;height:32px;background:rgba(255,255,255,.05);border-radius:8px;overflow:hidden;position:relative}
        .bar-fill{height:100%;border-radius:8px;display:flex;align-items:center;justify-content:flex-end;padding-right:10px;font-size:.75rem;font-weight:600;transition:width .5s ease}
        .bar-value{min-width:80px;text-align:right;font-size:.875rem;color:var(--text-secondary)}
        .timeline-section{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:1.5rem}
        .timeline-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}
        .timeline-item{display:flex;align-items:center;gap:1rem;padding:1rem;background:var(--bg-elevated);border-radius:12px;margin-bottom:.75rem;border-left:3px solid var(--accent-cyan)}
        .timeline-agent{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.25rem}
        .timeline-info{flex:1}
        .timeline-task{font-weight:500;font-size:.9rem}
        .timeline-meta{font-size:.75rem;color:var(--text-muted);margin-top:2px}
        .timeline-stats{text-align:right}
        .timeline-tokens{color:var(--accent-cyan);font-weight:600}
        .timeline-cost{color:var(--accent-green);font-size:.875rem}
        .total-banner{background:linear-gradient(135deg,rgba(0,212,255,.1),rgba(168,85,247,.1));border:1px solid var(--accent-cyan);border-radius:12px;padding:2rem;margin-top:1.5rem;text-align:center}
        .total-label{font-size:1rem;color:var(--text-muted);margin-bottom:.5rem}
        .total-value{font-size:3rem;font-weight:800;background:linear-gradient(135deg,var(--accent-cyan),var(--accent-purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .btn{background:var(--bg-elevated);border:1px solid var(--border);border-radius:8px;color:var(--text-secondary);padding:.5rem 1rem;cursor:pointer;font-size:.875rem;transition:all .2s}
        .btn:hover{border-color:var(--accent-cyan);color:var(--accent-cyan)}
        .btn-primary{background:var(--accent-cyan);color:#000;border-color:var(--accent-cyan)}
        .btn-primary:hover{background:var(--accent-cyan);filter:brightness(1.1)}
        .loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:var(--bg-primary);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000;transition:opacity .3s}
        .loading-overlay.hidden{opacity:0;pointer-events:none}
        .loading-spinner{width:50px;height:50px;border:3px solid var(--border);border-top-color:var(--accent-cyan);border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .error-message{background:rgba(255,42,109,.1);border:1px solid var(--accent-pink);border-radius:12px;padding:1rem;margin:1rem 0;color:var(--accent-pink);text-align:center}
        @media(max-width:1024px){.stats-grid,.charts-grid{grid-template-columns:repeat(2,1fr)}}
        @media(max-width:768px){.stats-grid,.charts-grid{grid-template-columns:1fr}.charts-grid{grid-template-columns:1fr}}
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div style="margin-top:1rem;color:var(--text-secondary)">Loading token data...</div>
    </div>

    <header class="header">
        <div class="brand">
            <div class="logo">ğŸ’°</div>
            <div class="brand-text">
                <h1>Token Tracker</h1>
                <span>Mission Control HQ</span>
            </div>
        </div>
        
        <nav class="nav-tabs">
            <a href="index.html" class="nav-tab"><span>ğŸ“Š</span> Overview</a>
            <a href="hq.html" class="nav-tab"><span>ğŸ¢</span> HQ</a>
            <a href="token-tracker.html" class="nav-tab active"><span>ğŸ’°</span> Tokens</a>
            <a href="task-board.html" class="nav-tab"><span>ğŸ“‹</span> Tasks</a>
            <a href="data-viewer.html" class="nav-tab"><span>ğŸ“</span> Data</a>
            <a href="logs-view.html" class="nav-tab"><span>ğŸ“</span> Logs</a>
        </nav>
        
        <div style="display:flex;align-items:center;gap:1rem">
            <span id="agentCount" style="font-size:.875rem;color:var(--text-muted)">ğŸŸ¢ Loading...</span>
            <button class="btn btn-primary" onclick="loadTokenData(true)">ğŸ”„ Refresh</button>
        </div>
    </header>

    <main class="main-content">
        <div id="errorContainer"></div>
        
        <!-- Stats Overview -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">ğŸ¤– Active Agents</div>
                <div class="stat-value" id="statAgents" style="color:var(--accent-cyan)">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸ“ Total Tokens</div>
                <div class="stat-value" id="statTokens" style="color:var(--accent-purple)">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸ’° Total Cost</div>
                <div class="stat-value" id="statCost" style="color:var(--accent-green)">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸ“Š Sessions</div>
                <div class="stat-value" id="statSessions" style="color:var(--accent-pink)">-</div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">ğŸ“ˆ Token Usage Trend</div>
                        <div style="font-size:.75rem;color:var(--text-muted)">Last 7 days</div>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-placeholder" id="usageChartPlaceholder">
                        Loading chart...
                    </div>
                    <canvas id="usageChart" style="display:none"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">ğŸ¥§ Cost Breakdown by Agent</div>
                        <div style="font-size:.75rem;color:var(--text-muted)">Percentage of total cost</div>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-placeholder" id="costChartPlaceholder">
                        Loading chart...
                    </div>
                    <canvas id="costChart" style="display:none"></canvas>
                </div>
            </div>
        </div>

        <!-- Agent Comparison -->
        <div class="agent-comparison">
            <div class="comparison-header">
                <div class="comparison-title">ğŸ¤– Agent Token Usage Comparison</div>
                <div style="font-size:.875rem;color:var(--text-muted)">Top consumers</div>
            </div>
            <div id="agentBars"></div>
        </div>

        <!-- Session Timeline -->
        <div class="timeline-section">
            <div class="timeline-header">
                <div class="comparison-title">ğŸ“ Recent Sessions</div>
                <div style="font-size:.875rem;color:var(--text-muted)">Last activity</div>
            </div>
            <div id="timelineItems"></div>
        </div>

        <!-- Total Banner -->
        <div class="total-banner">
            <div class="total-label">ğŸ’° Total Mission Control Cost</div>
            <div class="total-value" id="totalCost">-</div>
            <div style="font-size:.875rem;color:var(--text-muted);margin-top:.5rem" id="totalSubtitle">Loading live data...</div>
        </div>
    </main>

    <script>
        // ============================================
        // LAZY LOADED CHART.JS IMPLEMENTATION
        // ============================================
        
        let Chart = null;
        let usageChart = null;
        let costChart = null;
        
        // Lazy load Chart.js from CDN
        async function loadChartJS() {
            if (Chart) return Chart;
            
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js';
                script.async = true;
                script.onload = () => {
                    Chart = window.Chart;
                    // Optimize Chart.js defaults for performance
                    Chart.defaults.responsive = true;
                    Chart.defaults.maintainAspectRatio = false;
                    Chart.defaults.animation = false; // Disable animations
                    resolve(Chart);
                };
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        // ============================================
        // DATA LOADING
        // ============================================
        
        const API_BASE = 'http://localhost:3001';
        
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }
        
        function formatCurrency(num) {
            return '$' + num.toFixed(4);
        }
        
        function getAgentEmoji(name) {
            const emojis = {
                'Nexus': 'ğŸ¤–', 'Code': 'ğŸ’»', 'Scout': 'ğŸ”­', 'Pixel': 'ğŸ¨',
                'Forge': 'ğŸ”¨', 'DealFlow': 'ğŸ¤', 'Audit': 'ğŸ”', 'Cipher': 'ğŸ”’',
                'Glasses': 'ğŸ¥½', 'Sentry': 'ğŸ›¡ï¸', 'Quill': 'âœï¸', 'Gary': 'ğŸ“ˆ',
                'Larry': 'ğŸ“±', 'ColdCall': 'ğŸ“', 'Spark': 'ğŸ’¡'
            };
            return emojis[name] || 'ğŸ¤–';
        }
        
        function getAgentColor(name) {
            const colors = {
                'Nexus': '#ff2a6d', 'Code': '#22c55e', 'Scout': '#00d4ff',
                'Pixel': '#a855f7', 'Forge': '#f97316', 'DealFlow': '#f97316',
                'Audit': '#ff2a6d', 'Cipher': '#a855f7', 'Glasses': '#00d4ff',
                'Sentry': '#fbbf24', 'Quill': '#fbbf24', 'Gary': '#f97316',
                'Larry': '#00d4ff', 'ColdCall': '#22c55e', 'Spark': '#fbbf24'
            };
            return colors[name] || '#00d4ff';
        }
        
        function showError(message) {
            const container = document.getElementById('errorContainer');
            container.innerHTML = `
                <div class="error-message">
                    âš ï¸ ${message}
                    <br><small>Make sure the API server is running on port 3001</small>
                </div>
            `;
        }
        
        async function loadTokenData(forceRefresh = false) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (!forceRefresh) {
                loadingOverlay.classList.remove('hidden');
            }
            
            try {
                const url = `${API_BASE}/api/tokens${forceRefresh ? '?refresh=true' : ''}`;
                const response = await fetch(url);
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                updateDashboard(data);
                
                // Cache data
                try {
                    localStorage.setItem('tokenData', JSON.stringify(data));
                    localStorage.setItem('tokenDataTime', Date.now().toString());
                } catch (e) {}
                
                document.getElementById('errorContainer').innerHTML = '';
            } catch (error) {
                console.error('Failed to load token data:', error);
                showError('Failed to load token data. Using cached data if available.');
                
                // Try cache
                try {
                    const cached = localStorage.getItem('tokenData');
                    if (cached) {
                        updateDashboard(JSON.parse(cached));
                    }
                } catch (e) {}
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }
        
        function updateDashboard(data) {
            // Update stats
            document.getElementById('statAgents').textContent = data.agents?.length || 0;
            document.getElementById('statTokens').textContent = formatNumber(data.totalTokens || 0);
            document.getElementById('statCost').textContent = formatCurrency(data.totalCost || 0);
            document.getElementById('statSessions').textContent = data.meta?.sessionCount || 0;
            document.getElementById('agentCount').textContent = `ğŸŸ¢ ${data.agents?.length || 0} Agents Active`;
            
            // Update total banner
            document.getElementById('totalCost').textContent = formatCurrency(data.totalCost || 0);
            const lastUpdated = data.lastUpdated ? new Date(data.lastUpdated).toLocaleString() : 'Unknown';
            document.getElementById('totalSubtitle').textContent = 
                `${formatNumber(data.totalTokens || 0)} tokens across ${data.agents?.length || 0} agents â€¢ Last updated: ${lastUpdated}`;
            
            // Render agent bars
            renderAgentBars(data.agents || []);
            
            // Render timeline
            renderTimeline(data.recentSessions || []);
            
            // Lazy load charts only when visible
            if (isElementInViewport(document.getElementById('usageChart'))) {
                renderCharts(data);
            } else {
                // Set up intersection observer for charts
                setupChartObserver(data);
            }
        }
        
        function isElementInViewport(el) {
            const rect = el.getBoundingClientRect();
            return (
                rect.top >= 0 &&
                rect.left >= 0 &&
                rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
                rect.right <= (window.innerWidth || document.documentElement.clientWidth)
            );
        }
        
        function setupChartObserver(data) {
            if (!('IntersectionObserver' in window)) {
                renderCharts(data);
                return;
            }
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        renderCharts(data);
                        observer.disconnect();
                    }
                });
            }, { rootMargin: '100px' });
            
            observer.observe(document.getElementById('usageChart'));
        }
        
        function renderAgentBars(agents) {
            const container = document.getElementById('agentBars');
            if (!agents.length) {
                container.innerHTML = '<p style="text-align:center;color:var(--text-muted)">No agent data available</p>';
                return;
            }
            
            const maxTokens = Math.max(...agents.map(a => a.tokens || a.totalTokens || 0));
            
            container.innerHTML = agents.slice(0, 10).map(agent => {
                const tokens = agent.tokens || agent.totalTokens || 0;
                const percentage = maxTokens > 0 ? (tokens / maxTokens) * 100 : 0;
                const color = getAgentColor(agent.name);
                const emoji = getAgentEmoji(agent.name);
                
                return `
                    <div class="agent-bar">
                        <div class="agent-info">
                            <div class="agent-emoji" style="background:${color}20">${emoji}</div>
                            <div>
                                <div class="agent-name" style="color:${color}">${agent.name}</div>
                                <div class="agent-role">${agent.sessions || 0} sessions</div>
                            </div>
                        </div>
                        <div class="bar-container">
                            <div class="bar-fill" style="width:${percentage}%;background:linear-gradient(90deg,${color}80,${color});color:#fff">
                                ${percentage > 20 ? formatNumber(tokens) : ''}
                            </div>
                        </div>
                        <div class="bar-value">${formatNumber(tokens)}</div>
                    </div>
                `;
            }).join('');
        }
        
        function renderTimeline(sessions) {
            const container = document.getElementById('timelineItems');
            if (!sessions.length) {
                container.innerHTML = '<p style="text-align:center;color:var(--text-muted)">No recent sessions</p>';
                return;
            }
            
            container.innerHTML = sessions.slice(0, 6).map(session => {
                const color = getAgentColor(session.agent);
                const emoji = getAgentEmoji(session.agent);
                const time = session.timestamp ? new Date(session.timestamp).toLocaleTimeString() : 'Unknown';
                
                return `
                    <div class="timeline-item">
                        <div class="timeline-agent" style="background:${color}20;border:2px solid ${color}40">${emoji}</div>
                        <div class="timeline-info">
                            <div class="timeline-task">Session ${session.sessionId?.slice(0, 8) || 'Unknown'}</div>
                            <div class="timeline-meta">${time} â€¢ ${session.agent} â€¢ ${session.messages || 0} messages</div>
                        </div>
                        <div class="timeline-stats">
                            <div class="timeline-tokens">${formatNumber(session.tokens || 0)}</div>
                            <div class="timeline-cost">${formatCurrency(session.cost || 0)}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function renderCharts(data) {
            // Load Chart.js only when needed
            await loadChartJS();
            
            // Hide placeholders, show canvases
            document.getElementById('usageChartPlaceholder').style.display = 'none';
            document.getElementById('costChartPlaceholder').style.display = 'none';
            document.getElementById('usageChart').style.display = 'block';
            document.getElementById('costChart').style.display = 'block';
            
            renderUsageChart(data.dailyUsage || []);
            renderCostChart(data.agents || []);
        }
        
        function renderUsageChart(dailyUsage) {
            const ctx = document.getElementById('usageChart')?.getContext('2d');
            if (!ctx || !Chart) return;
            
            if (usageChart) usageChart.destroy();
            
            const labels = dailyUsage.map(d => {
                const date = new Date(d.date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            
            const tokens = dailyUsage.map(d => d.tokens);
            const costs = dailyUsage.map(d => d.cost);
            
            usageChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.length ? labels : ['No data'],
                    datasets: [{
                        label: 'Daily Tokens',
                        data: tokens.length ? tokens : [0],
                        borderColor: '#00d4ff',
                        backgroundColor: 'rgba(0, 212, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0 // Hide points for cleaner look
                    }, {
                        label: 'Cost ($)',
                        data: costs.length ? costs : [0],
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y1',
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: {
                        legend: { labels: { color: '#a1a1aa', boxWidth: 12 } }
                    },
                    scales: {
                        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#71717a' } },
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#71717a' } },
                        y1: { position: 'right', grid: { display: false }, ticks: { color: '#22c55e' } }
                    }
                }
            });
        }
        
        function renderCostChart(agents) {
            const ctx = document.getElementById('costChart')?.getContext('2d');
            if (!ctx || !Chart) return;
            
            if (costChart) costChart.destroy();
            
            const topAgents = agents.slice(0, 6);
            const colors = topAgents.map(a => getAgentColor(a.name));
            
            costChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: topAgents.map(a => a.name),
                    datasets: [{
                        data: topAgents.map(a => a.cost || 0),
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#a1a1aa', boxWidth: 12, padding: 15 }
                        }
                    },
                    cutout: '60%'
                }
            });
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadTokenData();
        });
    </script>
</body>
</html>