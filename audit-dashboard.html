<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Audit Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #252542;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --accent-primary: #00d4ff;
            --accent-success: #00ff88;
            --accent-warning: #ffaa00;
            --accent-danger: #ff4444;
            --accent-info: #4488ff;
            --border-color: #333355;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header h1::before {
            content: 'â—†';
            color: var(--accent-primary);
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-success);
            animation: pulse 2s infinite;
        }

        .status-dot.disconnected {
            background: var(--accent-danger);
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Container */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            transition: transform 0.2s, border-color 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent-primary);
        }

        .stat-card h3 {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-card.active .stat-value { color: var(--accent-info); }
        .stat-card.completed .stat-value { color: var(--accent-success); }
        .stat-card.blocked .stat-value { color: var(--accent-danger); }
        .stat-card.pending .stat-value { color: var(--accent-warning); }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Panel */
        .panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .panel-header {
            background: var(--bg-tertiary);
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header h2 {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .panel-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: var(--bg-primary);
        }

        .btn-small {
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
        }

        /* Task Table */
        .task-table {
            width: 100%;
            border-collapse: collapse;
        }

        .task-table th,
        .task-table td {
            padding: 1rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .task-table th {
            background: var(--bg-tertiary);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .task-table tr:hover td {
            background: rgba(0, 212, 255, 0.05);
        }

        .task-table tr:last-child td {
            border-bottom: none;
        }

        /* Status Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .badge-started {
            background: rgba(0, 212, 255, 0.15);
            color: var(--accent-primary);
        }
        .badge-started::before { background: var(--accent-primary); }

        .badge-in_progress {
            background: rgba(68, 136, 255, 0.15);
            color: var(--accent-info);
        }
        .badge-in_progress::before { background: var(--accent-info); }

        .badge-blocked {
            background: rgba(255, 68, 68, 0.15);
            color: var(--accent-danger);
        }
        .badge-blocked::before { background: var(--accent-danger); }

        .badge-completed {
            background: rgba(0, 255, 136, 0.15);
            color: var(--accent-success);
        }
        .badge-completed::before { background: var(--accent-success); }

        .badge-failed {
            background: rgba(255, 68, 68, 0.15);
            color: var(--accent-danger);
        }
        .badge-failed::before { background: var(--accent-danger); }

        /* Progress Bar */
        .progress-cell {
            width: 150px;
        }

        .progress-bar {
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-success));
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        /* Agent List */
        .agent-list {
            list-style: none;
        }

        .agent-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .agent-item:last-child {
            border-bottom: none;
        }

        .agent-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--accent-primary);
            border: 2px solid var(--border-color);
        }

        .agent-avatar.online {
            border-color: var(--accent-success);
        }

        .agent-avatar.busy {
            border-color: var(--accent-warning);
        }

        .agent-avatar.offline {
            border-color: var(--text-secondary);
        }

        .agent-info {
            flex: 1;
        }

        .agent-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .agent-task {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .agent-status {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Activity Log */
        .activity-log {
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
        }

        .activity-item {
            display: flex;
            gap: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: background 0.2s;
        }

        .activity-item:hover {
            background: var(--bg-tertiary);
        }

        .activity-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
            min-width: 60px;
            font-family: monospace;
        }

        .activity-content {
            flex: 1;
        }

        .activity-agent {
            font-weight: 600;
            color: var(--accent-primary);
        }

        .activity-text {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .activity-task {
            font-family: monospace;
            font-size: 0.75rem;
            background: var(--bg-tertiary);
            padding: 0.125rem 0.5rem;
            border-radius: 4px;
            margin-left: 0.5rem;
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 0.5rem;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
        }

        .filter-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.375rem 0.875rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: var(--bg-primary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-in {
            animation: slideIn 0.3s ease forwards;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>Agent Audit Dashboard</h1>
        <div class="connection-status">
            <span class="status-dot" id="connectionDot"></span>
            <span id="connectionText">Connected</span>
        </div>
    </header>

    <main class="container">
        <!-- Stats Overview -->
        <div class="stats-grid">
            <div class="stat-card active">
                <h3>Active Tasks</h3>
                <div class="stat-value" id="statActive">0</div>
            </div>
            <div class="stat-card completed">
                <h3>Completed Today</h3>
                <div class="stat-value" id="statCompleted">0</div>
            </div>
            <div class="stat-card blocked">
                <h3>Blocked</h3>
                <div class="stat-value" id="statBlocked">0</div>
            </div>
            <div class="stat-card pending">
                <h3>Pending</h3>
                <div class="stat-value" id="statPending">0</div>
            </div>
        </div>

        <div class="dashboard-grid">
            <!-- Tasks Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h2>ðŸ“‹ Active Tasks</h2>
                    <div class="panel-actions">
                        <button class="btn btn-small" onclick="refreshData()">Refresh</button>
                        <button class="btn btn-small" onclick="exportData()">Export</button>
                    </div>
                </div>
                <div class="filters">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="started">Started</button>
                    <button class="filter-btn" data-filter="in_progress">In Progress</button>
                    <button class="filter-btn" data-filter="blocked">Blocked</button>
                    <button class="filter-btn" data-filter="completed">Completed</button>
                </div>
                <div class="table-container">
                    <table class="task-table">
                        <thead>
                            <tr>
                                <th>Task</th>
                                <th>Agent</th>
                                <th>Status</th>
                                <th class="progress-cell">Progress</th>
                                <th>Last Update</th>
                            </tr>
                        </thead>
                        <tbody id="taskTableBody">
                            <!-- Tasks will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Side Panel -->
            <div class="side-panels">
                <!-- Agents Panel -->
                <div class="panel" style="margin-bottom: 1.5rem;">
                    <div class="panel-header">
                        <h2>ðŸ¤– Active Agents</h2>
                    </div>
                    <ul class="agent-list" id="agentList">
                        <!-- Agents will be populated here -->
                    </ul>
                </div>

                <!-- Activity Log Panel -->
                <div class="panel">
                    <div class="panel-header">
                        <h2>ðŸ“œ Recent Activity</h2>
                    </div>
                    <div class="activity-log" id="activityLog">
                        <!-- Activity will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Configuration
        const API_BASE_URL = 'https://dashboard-ten-sand-20.vercel.app/api';
        const REFRESH_INTERVAL = 5000; // 5 seconds

        // State
        let tasks = [];
        let agents = [];
        let activities = [];
        let currentFilter = 'all';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            setInterval(loadData, REFRESH_INTERVAL);
            setupFilters();
        });

        // Setup filter buttons
        function setupFilters() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.filter;
                    renderTasks();
                });
            });
        }

        // Load data from API
        async function loadData() {
            try {
                setConnectionStatus(true);
                
                // Fetch tasks
                const tasksResponse = await fetch(`${API_BASE_URL}/tasks`);
                if (tasksResponse.ok) {
                    tasks = await tasksResponse.json();
                }

                // Fetch agents
                const agentsResponse = await fetch(`${API_BASE_URL}/agents`);
                if (agentsResponse.ok) {
                    agents = await agentsResponse.json();
                }

                // Fetch recent activity
                const activityResponse = await fetch(`${API_BASE_URL}/audit/recent`);
                if (activityResponse.ok) {
                    activities = await activityResponse.json();
                }

                updateStats();
                renderTasks();
                renderAgents();
                renderActivity();
            } catch (error) {
                console.error('Failed to load data:', error);
                setConnectionStatus(false);
                showDemoData();
            }
        }

        // Show demo data if API is unavailable
        function showDemoData() {
            tasks = [
                { id: 'TASK-001', agent: 'Builder-1', status: 'in_progress', progress: 65, details: 'Implementing user auth', updated_at: new Date().toISOString() },
                { id: 'TASK-002', agent: 'Researcher-1', status: 'started', progress: 10, details: 'Analyzing market data', updated_at: new Date().toISOString() },
                { id: 'TASK-003', agent: 'Builder-2', status: 'blocked', progress: 40, details: 'Waiting for API keys', updated_at: new Date().toISOString() },
                { id: 'TASK-004', agent: 'Writer-1', status: 'completed', progress: 100, details: 'Documentation complete', updated_at: new Date().toISOString() }
            ];

            agents = [
                { name: 'Builder-1', status: 'online', current_task: 'TASK-001' },
                { name: 'Researcher-1', status: 'online', current_task: 'TASK-002' },
                { name: 'Builder-2', status: 'busy', current_task: 'TASK-003' },
                { name: 'Writer-1', status: 'online', current_task: null }
            ];

            activities = [
                { agent: 'Builder-1', task: 'TASK-001', status: 'in_progress', progress: 65, details: 'Login form implemented', timestamp: new Date().toISOString() },
                { agent: 'Researcher-1', task: 'TASK-002', status: 'started', progress: 10, details: 'Started research phase', timestamp: new Date(Date.now() - 300000).toISOString() },
                { agent: 'Builder-2', task: 'TASK-003', status: 'blocked', progress: 40, details: 'Blocked: API unavailable', timestamp: new Date(Date.now() - 600000).toISOString() },
                { agent: 'Writer-1', task: 'TASK-004', status: 'completed', progress: 100, details: 'Task completed successfully', timestamp: new Date(Date.now() - 900000).toISOString() }
            ];

            updateStats();
            renderTasks();
            renderAgents();
            renderActivity();
        }

        // Update statistics
        function updateStats() {
            const active = tasks.filter(t => t.status === 'in_progress' || t.status === 'started').length;
            const completed = tasks.filter(t => t.status === 'completed').length;
            const blocked = tasks.filter(t => t.status === 'blocked' || t.status === 'failed').length;
            const pending = tasks.filter(t => t.status === 'started' && t.progress === 0).length;

            document.getElementById('statActive').textContent = active;
            document.getElementById('statCompleted').textContent = completed;
            document.getElementById('statBlocked').textContent = blocked;
            document.getElementById('statPending').textContent = pending;
        }

        // Render tasks table
        function renderTasks() {
            const tbody = document.getElementById('taskTableBody');
            
            let filteredTasks = tasks;
            if (currentFilter !== 'all') {
                filteredTasks = tasks.filter(t => t.status === currentFilter);
            }

            if (filteredTasks.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <div class="empty-state-icon">ðŸ“­</div>
                            <p>No tasks found</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredTasks.map(task => `
                <tr class="animate-in">
                    <td>
                        <strong>${task.id}</strong>
                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">
                            ${task.details || 'No description'}
                        </div>
                    </td>
                    <td>${task.agent}</td>
                    <td><span class="badge badge-${task.status}">${formatStatus(task.status)}</span></td>
                    <td class="progress-cell">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${task.progress}%"></div>
                        </div>
                        <div class="progress-text">${task.progress}%</div>
                    </td>
                    <td>${formatTime(task.updated_at)}</td>
                </tr>
            `).join('');
        }

        // Render agents list
        function renderAgents() {
            const list = document.getElementById('agentList');
            
            if (agents.length === 0) {
                list.innerHTML = '<li class="empty-state">No active agents</li>';
                return;
            }

            list.innerHTML = agents.map(agent => `
                <li class="agent-item">
                    <div class="agent-avatar ${agent.status}">${agent.name.charAt(0)}</div>
                    <div class="agent-info">
                        <div class="agent-name">${agent.name}</div>
                        <div class="agent-task">${agent.current_task || 'Idle'}</div>
                    </div>
                    <div class="agent-status">${formatStatus(agent.status)}</div>
                </li>
            `).join('');
        }

        // Render activity log
        function renderActivity() {
            const log = document.getElementById('activityLog');
            
            if (activities.length === 0) {
                log.innerHTML = '<div class="empty-state">No recent activity</div>';
                return;
            }

            log.innerHTML = activities.slice(0, 20).map(activity => `
                <div class="activity-item">
                    <div class="activity-time">${formatTimeShort(activity.timestamp)}</div>
                    <div class="activity-content">
                        <span class="activity-agent">${activity.agent}</span>
                        <span class="activity-task">${activity.task}</span>
                        <div class="activity-text">${activity.details || formatStatus(activity.status)}</div>
                    </div>
                </div>
            `).join('');
        }

        // Format status for display
        function formatStatus(status) {
            const statusMap = {
                'started': 'Started',
                'in_progress': 'In Progress',
                'blocked': 'Blocked',
                'completed': 'Completed',
                'failed': 'Failed',
                'online': 'Online',
                'offline': 'Offline',
                'busy': 'Busy'
            };
            return statusMap[status] || status;
        }

        // Format timestamp
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);

            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            return date.toLocaleDateString();
        }

        // Format short time
        function formatTimeShort(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Set connection status
        function setConnectionStatus(connected) {
            const dot = document.getElementById('connectionDot');
            const text = document.getElementById('connectionText');
            
            if (connected) {
                dot.classList.remove('disconnected');
                text.textContent = 'Connected';
            } else {
                dot.classList.add('disconnected');
                text.textContent = 'Offline (Demo Mode)';
            }
        }

        // Refresh data manually
        function refreshData() {
            loadData();
        }

        // Export data
        function exportData() {
            const data = {
                tasks,
                agents,
                activities,
                exported_at: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `audit-export-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
