#!/bin/bash
#
# Memory Query Interface
# Search and retrieve from all memory layers
#

WORKSPACE="/root/.openclaw/workspace"
MEMORY_DIR="$WORKSPACE/memory"

function show_help() {
  cat <<EOF
Memory Query Interface - Never Forget Anything

Usage: nexus-memory <command> [options]

Commands:
  search <query>     Search all memory layers for query
  today              Show today's activity
  yesterday          Show yesterday's summary
  date <YYYY-MM-DD>  Show specific date
  topic <name>       Show topic archive (agents, projects, decisions, lessons, preferences)
  stats              Show memory statistics
  recent [n]         Show last n days (default: 7)
  verify             Verify memory integrity
  export <path>      Export all memory to path

Examples:
  nexus-memory search "lead scoring"
  nexus-memory date 2026-02-17
  nexus-memory topic projects
  nexus-memory recent 14

EOF
}

function search_memory() {
  local query="$1"
  echo "=== Searching Memory: '$query' ==="
  echo ""
  
  # Search daily files
  echo "üìÖ Daily Summaries:"
  grep -r -l "$query" "$MEMORY_DIR/daily/" 2>/dev/null | head -5 | while read f; do
    echo "  - $(basename $f .md)"
    grep -h "$query" "$f" 2>/dev/null | head -3 | sed 's/^/    /'
  done
  
  echo ""
  echo "üìÅ Topic Archives:"
  grep -r -l "$query" "$MEMORY_DIR/topics/" 2>/dev/null | head -5 | while read f; do
    echo "  - $(basename $f)"
  done
  
  echo ""
  echo "üìù Raw Streams (last 7 days):"
  find "$MEMORY_DIR/stream" -name "*.jsonl" -mtime -7 -exec grep -l "$query" {} \; 2>/dev/null | head -5 | while read f; do
    echo "  - $(basename $f)"
  done
  
  echo ""
  echo "üíæ MEMORY.md:"
  grep -n "$query" "$MEMORY_DIR/MEMORY.md" 2>/dev/null | head -5 | sed 's/^/  Line /'
}

function show_today() {
  echo "=== Today ($(date +%Y-%m-%d)) ==="
  echo ""
  
  # Count today's entries
  TODAY_FILES=$(find "$MEMORY_DIR/stream" -name "$(date +%Y-%m-%d)-*.jsonl" 2>/dev/null)
  if [ -n "$TODAY_FILES" ]; then
    ENTRIES=$(cat $TODAY_FILES 2>/dev/null | wc -l)
    echo "üìä Activity: $ENTRIES interactions captured"
    echo ""
    echo "Recent entries:"
    cat $TODAY_FILES 2>/dev/null | tail -5 | jq -r '[.timestamp, .type] | @tsv' 2>/dev/null | sed 's/^/  /'
  else
    echo "No activity recorded yet today"
  fi
}

function show_date() {
  local date="$1"
  local daily_file="$MEMORY_DIR/daily/${date}.md"
  
  if [ -f "$daily_file" ]; then
    cat "$daily_file"
  else
    echo "No daily summary found for $date"
    echo ""
    echo "Checking raw streams..."
    STREAM_FILES=$(find "$MEMORY_DIR/stream" -name "${date}-*.jsonl" 2>/dev/null)
    if [ -n "$STREAM_FILES" ]; then
      echo "Found $(echo "$STREAM_FILES" | wc -l) stream files"
      echo "Run daily consolidation to generate summary"
    else
      echo "No data found for $date"
    fi
  fi
}

function show_topic() {
  local topic="$1"
  local topic_file="$MEMORY_DIR/topics/${topic}.md"
  
  if [ -f "$topic_file" ]; then
    cat "$topic_file"
  else
    echo "Topic '$topic' not found"
    echo ""
    echo "Available topics:"
    ls -1 "$MEMORY_DIR/topics/" 2>/dev/null | sed 's/^/  - /' | sed 's/.md$//'
  fi
}

function show_stats() {
  echo "=== Memory Statistics ==="
  echo ""
  
  # Stream files
  STREAM_COUNT=$(find "$MEMORY_DIR/stream" -name "*.jsonl" 2>/dev/null | wc -l)
  STREAM_SIZE=$(du -sh "$MEMORY_DIR/stream" 2>/dev/null | cut -f1)
  echo "üåä Real-Time Streams:"
  echo "   Files: $STREAM_COUNT"
  echo "   Size: $STREAM_SIZE"
  
  # Daily summaries
  DAILY_COUNT=$(ls -1 "$MEMORY_DIR/daily/" 2>/dev/null | wc -l)
  DAILY_SIZE=$(du -sh "$MEMORY_DIR/daily" 2>/dev/null | cut -f1)
  echo ""
  echo "üìÖ Daily Summaries:"
  echo "   Files: $DAILY_COUNT"
  echo "   Size: $DAILY_SIZE"
  
  # Topic archives
  TOPIC_COUNT=$(ls -1 "$MEMORY_DIR/topics/" 2>/dev/null | wc -l)
  echo ""
  echo "üìÅ Topic Archives: $TOPIC_COUNT topics"
  
  # Archives
  ARCHIVE_SIZE=$(du -sh "$MEMORY_DIR/archive" 2>/dev/null | cut -f1)
  echo ""
  echo "üì¶ Compressed Archives: $ARCHIVE_SIZE"
  
  # Total
  TOTAL_SIZE=$(du -sh "$MEMORY_DIR" 2>/dev/null | cut -f1)
  echo ""
  echo "üíæ Total Memory Storage: $TOTAL_SIZE"
  echo ""
  echo "‚úì All data preserved - nothing ever deleted"
}

function show_recent() {
  local days="${1:-7}"
  echo "=== Last $days Days ==="
  echo ""
  
  for i in $(seq 0 $((days-1))); do
    date=$(date -d "$i days ago" +%Y-%m-%d)
    file="$MEMORY_DIR/daily/${date}.md"
    if [ -f "$file" ]; then
      echo "üìÖ $date: ‚úì"
    else
      echo "üìÖ $date: (no summary)"
    fi
  done
}

function verify_integrity() {
  echo "=== Memory Integrity Check ==="
  echo ""
  
  local issues=0
  
  # Check stream directory exists
  if [ ! -d "$MEMORY_DIR/stream" ]; then
    echo "‚ùå Stream directory missing"
    issues=$((issues+1))
  else
    echo "‚úì Stream directory exists"
  fi
  
  # Check daily directory
  if [ ! -d "$MEMORY_DIR/daily" ]; then
    echo "‚ùå Daily directory missing"
    issues=$((issues+1))
  else
    echo "‚úì Daily directory exists"
  fi
  
  # Check for gaps in daily summaries
  echo ""
  echo "Checking for gaps..."
  # (Implementation would check date continuity)
  
  # Check archive accessibility
  if [ -d "$MEMORY_DIR/archive" ]; then
    echo "‚úì Archive directory exists"
    # Test a random archive file
    TEST_ARCHIVE=$(find "$MEMORY_DIR/archive" -name "*.tar.gz" | head -1)
    if [ -n "$TEST_ARCHIVE" ]; then
      if tar -tzf "$TEST_ARCHIVE" > /dev/null 2>&1; then
        echo "‚úì Archive files readable"
      else
        echo "‚ùå Archive file corrupted: $TEST_ARCHIVE"
        issues=$((issues+1))
      fi
    fi
  fi
  
  echo ""
  if [ $issues -eq 0 ]; then
    echo "‚úì All memory systems operational"
  else
    echo "‚ö†Ô∏è Found $issues issue(s) - review above"
  fi
}

# Main command handler
case "$1" in
  search)
    search_memory "$2"
    ;;
  today)
    show_today
    ;;
  yesterday)
    show_date "$(date -d yesterday +%Y-%m-%d)"
    ;;
  date)
    show_date "$2"
    ;;
  topic)
    show_topic "$2"
    ;;
  stats)
    show_stats
    ;;
  recent)
    show_recent "$2"
    ;;
  verify)
    verify_integrity
    ;;
  help|--help|-h)
    show_help
    ;;
  *)
    show_help
    ;;
esac
