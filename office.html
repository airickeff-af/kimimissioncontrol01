<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Office | Mission Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Courier New', monospace;
            background: #2d2d2d;
            overflow: hidden;
            user-select: none;
        }

        /* Standardized Header */
        .mc-header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 0.75rem 1.5rem;
            border-bottom: 2px solid #00d4ff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 60px;
        }
        .mc-logo { 
            font-family: 'Press Start 2P', cursive;
            font-size: 0.7rem; 
            color: #00d4ff; 
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .mc-nav { 
            display: flex; 
            gap: 0.5rem;
            align-items: center;
        }
        .mc-nav a {
            color: #888;
            text-decoration: none;
            padding: 0.4rem 0.75rem;
            border-radius: 6px;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
        }
        .mc-nav a:hover, .mc-nav a.active { 
            color: #00d4ff; 
            background: rgba(0,212,255,0.1); 
        }
        .mc-refresh-btn {
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid #00d4ff;
            color: #00d4ff;
            padding: 0.4rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .mc-refresh-btn:hover { 
            background: rgba(0, 212, 255, 0.3); 
            transform: scale(1.05);
        }
        
        #game-container {
            position: relative;
            width: 100vw;
            height: calc(100vh - 60px);
            display: flex;
            margin-top: 60px;
        }
        
        #canvas-container {
            flex: 1;
            position: relative;
            background: #f5e6c8;
            overflow: hidden;
        }
        
        #office-canvas {
            position: absolute;
            cursor: grab;
        }
        
        #office-canvas:active {
            cursor: grabbing;
        }
        
        #ui-panel {
            width: 320px;
            background: #3d3d3d;
            border-left: 4px solid #8b7355;
            display: flex;
            flex-direction: column;
            color: #f5e6c8;
        }
        
        #ui-header {
            background: #8b7355;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            text-shadow: 2px 2px 0 #5a4a3a;
        }
        
        .ui-section {
            padding: 15px;
            border-bottom: 2px solid #4a4a4a;
        }
        
        .ui-section h3 {
            color: #d4a574;
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
        }
        
        .btn {
            background: #8b7355;
            border: 3px solid #5a4a3a;
            color: #f5e6c8;
            padding: 10px 20px;
            font-family: inherit;
            font-size: 14px;
            cursor: pointer;
            margin: 5px 0;
            width: 100%;
            text-shadow: 1px 1px 0 #5a4a3a;
            transition: all 0.1s;
        }
        
        .btn:hover {
            background: #a08060;
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-primary {
            background: #6b8e6b;
            border-color: #4a6a4a;
        }
        
        .btn-primary:hover {
            background: #7a9e7a;
        }
        
        #activity-feed {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: #2d2d2d;
            font-size: 12px;
            line-height: 1.6;
        }
        
        .activity-item {
            padding: 8px;
            margin-bottom: 5px;
            background: #3d3d3d;
            border-left: 3px solid #8b7355;
            border-radius: 3px;
        }
        
        .activity-time {
            color: #888;
            font-size: 10px;
        }
        
        #agent-details {
            position: absolute;
            background: #3d3d3d;
            border: 3px solid #8b7355;
            padding: 15px;
            border-radius: 8px;
            display: none;
            min-width: 200px;
            z-index: 100;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.3);
        }
        
        #agent-details h4 {
            color: #d4a574;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        #agent-details p {
            font-size: 12px;
            margin: 5px 0;
            color: #ccc;
        }
        
        #agent-details .close-btn {
            position: absolute;
            top: 5px;
            right: 8px;
            cursor: pointer;
            color: #888;
        }
        
        #zoom-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
        }
        
        .zoom-btn {
            width: 40px;
            height: 40px;
            background: #8b7355;
            border: 3px solid #5a4a3a;
            color: #f5e6c8;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
        }
        
        .zoom-btn:hover {
            background: #a08060;
        }
        
        #meeting-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }
        
        #meeting-content {
            background: #3d3d3d;
            border: 4px solid #8b7355;
            padding: 30px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }
        
        #meeting-content h2 {
            color: #d4a574;
            margin-bottom: 20px;
            text-align: center;
        }
        
        #meeting-content h3 {
            color: #8b7355;
            margin: 20px 0 10px;
            font-size: 14px;
        }
        
        #meeting-content pre {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 5px;
            font-size: 12px;
            line-height: 1.6;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .meeting-btn {
            margin-top: 20px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-working { background: #6b8e6b; }
        .status-meeting { background: #d4a574; }
        .status-idle { background: #888; }
        
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #2d2d2d;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #8b7355;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <!-- Standardized Mission Control Header -->
    <header class="mc-header">
        <div class="mc-logo">üéØ Mission Control</div>
        <nav class="mc-nav">
            <a href="/">HQ</a>
            <a href="/office" class="active">Office</a>
            <a href="/agents">Agents</a>
            <a href="/deals">Deals</a>
            <a href="/tokens">Tokens</a>
            <a href="/tasks">Tasks</a>
            <a href="/logs">Logs</a>
            <a href="/data">Data</a>
            <button class="mc-refresh-btn" onclick="location.reload()" title="Refresh">üîÑ</button>
        </nav>
    </header>

    <div id="game-container">
        <div id="canvas-container">
            <canvas id="office-canvas"></canvas>
            <div id="zoom-controls">
                <button class="zoom-btn" onclick="zoomIn()">+</button>
                <button class="zoom-btn" onclick="zoomOut()">-</button>
                <button class="zoom-btn" onclick="resetZoom()">‚åÇ</button>
            </div>
        </div>
        
        <div id="ui-panel">
            <div id="ui-header">üè¢ PIXEL OFFICE</div>
            
            <div class="ui-section">
                <h3>üìã Actions</h3>
                <button class="btn btn-primary" onclick="callStandup()">üì¢ Call Standup</button>
                <button class="btn" onclick="generateMinutes()">üìù Meeting Minutes</button>
                <button class="btn" onclick="showHierarchyTable()">üè¢ View Hierarchy</button>
                <button class="btn" onclick="reviewImprovements()">üí° Nexus Review</button>
            </div>
            
            <div class="ui-section">
                <h3>üë• Agents (<span id="agent-count">0</span>)</h3>
                <div id="agent-list" style="font-size: 12px; line-height: 1.8;"></div>
            </div>
            
            <div class="ui-section" style="flex: 1; display: flex; flex-direction: column; padding: 0;">
                <h3 style="padding: 15px 15px 0;">üì° Activity Feed</h3>
                <div id="activity-feed"></div>
            </div>
        </div>
    </div>
    
    <div id="agent-details">
        <span class="close-btn" onclick="closeAgentDetails()">√ó</span>
        <h4 id="detail-name">Agent Name</h4>
        <p><span class="status-indicator" id="detail-status-dot"></span><span id="detail-status">Status</span></p>
        <p><strong>Role:</strong> <span id="detail-role">Role</span></p>
        <p><strong>Current Task:</strong> <span id="detail-task">Task</span></p>
        <p><strong>Productivity:</strong> <span id="detail-productivity">0%</span></p>
    </div>
    
    <div id="meeting-modal">
        <div id="meeting-content">
            <h2 id="modal-title">Meeting Minutes</h2>
            <div id="modal-body"></div>
            <button class="btn meeting-btn" onclick="closeMeetingModal()">Close</button>
        </div>
    </div>

    <script>
        // ============================================
        // KAIROSOFT PIXEL OFFICE - GAME ENGINE
        // ============================================
        
        const canvas = document.getElementById('office-canvas');
        const ctx = canvas.getContext('2d');
        
        // Game State
        let gameState = {
            zoom: 1,
            offsetX: 0,
            offsetY: 0,
            isDragging: false,
            lastMouseX: 0,
            lastMouseY: 0,
            standupActive: false,
            meetingTablePos: { x: 400, y: 300 },
            lastStandupTime: null,
            meetingMinutes: null
        };
        
        // Color Palette (Kairosoft Style)
        const COLORS = {
            bg: '#f5e6c8',
            floor: '#e8d4a8',
            floorDark: '#d4c090',
            wall: '#c4b090',
            accent: '#8b7355',
            accentDark: '#5a4a3a',
            desk: '#a08060',
            deskDark: '#7a6045',
            chair: '#6b8e6b',
            table: '#8b7355',
            text: '#3d3d3d',
            highlight: '#d4a574'
        };
        
        // Agent Sprites Data (32x32 pixel art patterns)
        const AGENT_TYPES = [
            { name: 'Nexus', role: 'AI Coordinator', color: '#6b8e6b', crown: true },
            { name: 'Scribe', role: 'Documentation', color: '#8b9dc3', crown: false },
            { name: 'Builder', role: 'Development', color: '#d4a574', crown: false },
            { name: 'Tester', role: 'QA Engineer', color: '#c9a0dc', crown: false },
            { name: 'Designer', role: 'UI/UX', color: '#f4a460', crown: false },
            { name: 'Architect', role: 'System Design', color: '#5f9ea0', crown: false },
            { name: 'DevOps', role: 'Infrastructure', color: '#cd853f', crown: false },
            { name: 'Analyst', role: 'Data Analysis', color: '#dda0dd', crown: false },
            { name: 'Security', role: 'Security', color: '#dc143c', crown: false },
            { name: 'Researcher', role: 'R&D', color: '#4682b4', crown: false },
            { name: 'Planner', role: 'Project Manager', color: '#2e8b57', crown: false },
            { name: 'Support', role: 'Customer Support', color: '#ff8c00', crown: false },
            { name: 'Writer', role: 'Content', color: '#9370db', crown: false },
            { name: 'Optimizer', role: 'Performance', color: '#20b2aa', crown: false },
            { name: 'Debugger', role: 'Bug Hunter', color: '#b22222', crown: false },
            { name: 'Integrator', role: 'Integration', color: '#4169e1', crown: false },
            { name: 'Validator', role: 'Validation', color: '#ff6347', crown: false },
            { name: 'Deployer', role: 'Deployment', color: '#32cd32', crown: false },
            { name: 'Monitor', role: 'Monitoring', color: '#87ceeb', crown: false },
            { name: 'Auditor', role: 'Code Review', color: '#fa8072', crown: false },
            { name: 'Strategist', role: 'Strategy', color: '#ffd700', crown: false },
            { name: 'EricF', role: 'Human Lead', color: '#ff6b6b', crown: true, human: true }
        ];
        
        // Initialize Agents
        let agents = [];
        
        // Agent Hierarchy Structure
        const AGENT_HIERARCHY = {
            commander: { id: 'ericf', name: 'EricF', role: 'Commander', emoji: 'üëë', color: '#ff6b6b' },
            aiLead: { id: 'nexus', name: 'Nexus', role: 'AI Lead', emoji: 'ü§ñ', color: '#6b8e6b' },
            teams: [
                {
                    name: 'Dev Team',
                    lead: { id: 'codemaster', name: 'CodeMaster', role: 'Dev Lead', emoji: 'üíª', color: '#339af0' },
                    members: [
                        { id: 'code-1', name: 'Code-1', role: 'Developer', emoji: '‚ö°', color: '#51cf66' },
                        { id: 'code-2', name: 'Code-2', role: 'Developer', emoji: '‚ö°', color: '#51cf66' },
                        { id: 'code-3', name: 'Code-3', role: 'Developer', emoji: '‚ö°', color: '#51cf66' }
                    ]
                },
                {
                    name: 'Design Team',
                    lead: { id: 'forge', name: 'Forge', role: 'Design Lead', emoji: 'üé®', color: '#ff6b6b' },
                    members: [
                        { id: 'forge-2', name: 'Forge-2', role: 'Designer', emoji: '‚ú®', color: '#fcc419' },
                        { id: 'forge-3', name: 'Forge-3', role: 'Designer', emoji: '‚ú®', color: '#fcc419' },
                        { id: 'pixel', name: 'Pixel', role: 'Pixel Artist', emoji: 'üéÆ', color: '#a78bfa' }
                    ]
                },
                {
                    name: 'Research Team',
                    lead: { id: 'glasses', name: 'Glasses', role: 'Research Lead', emoji: 'üîç', color: '#4ecdc4' },
                    members: [
                        { id: 'scout', name: 'Scout', role: 'Researcher', emoji: 'üì°', color: '#74c0fc' }
                    ]
                },
                {
                    name: 'Operations',
                    members: [
                        { id: 'sentry', name: 'Sentry', role: 'DevOps', emoji: 'üõ°Ô∏è', color: '#ff8787' },
                        { id: 'cipher', name: 'Cipher', role: 'Security', emoji: 'üîê', color: '#9775fa' }
                    ]
                },
                {
                    name: 'Content',
                    members: [
                        { id: 'quill', name: 'Quill', role: 'Writer', emoji: '‚úçÔ∏è', color: '#ffa94d' },
                        { id: 'larry', name: 'Larry', role: 'Social Media', emoji: 'üê¶', color: '#69db7c' }
                    ]
                },
                {
                    name: 'Marketing',
                    members: [
                        { id: 'gary', name: 'Gary', role: 'Marketing', emoji: 'üì¢', color: '#ff8787' },
                        { id: 'coldcall', name: 'ColdCall', role: 'Outreach', emoji: 'üìû', color: '#ffd43b' }
                    ]
                },
                {
                    name: 'Audit',
                    members: [
                        { id: 'audit-1', name: 'Audit-1', role: 'QA', emoji: '‚úì', color: '#63e6be' },
                        { id: 'audit-2', name: 'Audit-2', role: 'QA', emoji: '‚úì', color: '#63e6be' }
                    ]
                }
            ]
        };
        
        function initAgents() {
            agents = AGENT_TYPES.map((type, index) => ({
                id: index,
                ...type,
                x: 100 + (index % 7) * 120,
                y: 100 + Math.floor(index / 7) * 100,
                targetX: null,
                targetY: null,
                direction: 'down',
                frame: 0,
                animTimer: 0,
                status: 'working',
                currentTask: getRandomTask(type.role),
                productivity: 70 + Math.random() * 30,
                atMeeting: false,
                deskX: 100 + (index % 7) * 120,
                deskY: 100 + Math.floor(index / 7) * 100
            }));
            updateAgentList();
        }
        
        function getRandomTask(role) {
            const tasks = {
                'AI Coordinator': ['Coordinating agents', 'Reviewing progress', 'Optimizing workflow'],
                'Documentation': ['Writing docs', 'Updating wiki', 'Recording decisions'],
                'Development': ['Coding features', 'Fixing bugs', 'Refactoring code'],
                'QA Engineer': ['Running tests', 'Finding bugs', 'Validating fixes'],
                'UI/UX': ['Designing interfaces', 'Creating mockups', 'Reviewing UX'],
                'System Design': ['Drawing diagrams', 'Planning architecture', 'Reviewing designs'],
                'Infrastructure': ['Managing servers', 'Configuring CI/CD', 'Monitoring systems'],
                'Data Analysis': ['Analyzing metrics', 'Generating reports', 'Finding insights'],
                'Security': ['Auditing code', 'Checking vulnerabilities', 'Updating security'],
                'R&D': ['Researching tech', 'Prototyping ideas', 'Evaluating tools'],
                'Project Manager': ['Planning sprints', 'Tracking progress', 'Managing backlog'],
                'Customer Support': ['Responding to tickets', 'Creating FAQs', 'Gathering feedback'],
                'Content': ['Writing articles', 'Creating tutorials', 'Updating docs'],
                'Performance': ['Profiling code', 'Optimizing queries', 'Improving speed'],
                'Bug Hunter': ['Hunting bugs', 'Reproducing issues', 'Verifying fixes'],
                'Integration': ['Connecting services', 'Testing APIs', 'Syncing data'],
                'Validation': ['Validating data', 'Checking compliance', 'Running checks'],
                'Deployment': ['Deploying updates', 'Managing releases', 'Rolling back'],
                'Monitoring': ['Watching metrics', 'Setting alerts', 'Investigating issues'],
                'Code Review': ['Reviewing PRs', 'Checking quality', 'Enforcing standards'],
                'Strategy': ['Planning roadmap', 'Analyzing market', 'Setting goals'],
                'Human Lead': ['Making decisions', 'Guiding team', 'Setting vision']
            };
            const roleTasks = tasks[role] || ['Working', 'Thinking', 'Planning'];
            return roleTasks[Math.floor(Math.random() * roleTasks.length)];
        }
        
        // ============================================
        // PIXEL ART RENDERING
        // ============================================
        
        function drawPixelRect(x, y, w, h, color) {
            ctx.fillStyle = color;
            ctx.fillRect(Math.floor(x), Math.floor(y), w, h);
        }
        
        function drawPixelCircle(x, y, r, color) {
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(x, y, r, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // Draw a chibi-style agent sprite
        function drawAgentSprite(agent, screenX, screenY, scale = 1) {
            const size = 32 * scale;
            const px = screenX - size / 2;
            const py = screenY - size;
            
            // Shadow
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.beginPath();
            ctx.ellipse(screenX, screenY, size * 0.4, size * 0.15, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Body (chibi style - big head, small body)
            const bounce = agent.status === 'walking' ? Math.sin(agent.animTimer * 0.3) * 3 : 0;
            
            // Body
            drawPixelRect(px + size * 0.3, py + size * 0.5 + bounce, size * 0.4, size * 0.35, agent.color);
            
            // Head (large for chibi style)
            const headY = py + size * 0.15 + bounce * 0.5;
            drawPixelCircle(screenX, headY + size * 0.25, size * 0.3, '#ffdbac'); // Skin
            
            // Hair
            drawPixelRect(px + size * 0.15, headY, size * 0.7, size * 0.25, '#4a3728');
            
            // Eyes
            const eyeOffset = agent.direction === 'left' ? -3 : agent.direction === 'right' ? 3 : 0;
            drawPixelRect(px + size * 0.35 + eyeOffset, headY + size * 0.2, size * 0.1, size * 0.1, '#000');
            drawPixelRect(px + size * 0.55 + eyeOffset, headY + size * 0.2, size * 0.1, size * 0.1, '#000');
            
            // Crown for special agents
            if (agent.crown) {
                const crownY = headY - size * 0.1;
                drawPixelRect(px + size * 0.3, crownY, size * 0.4, size * 0.12, '#ffd700');
                drawPixelRect(px + size * 0.35, crownY - size * 0.08, size * 0.08, size * 0.1, '#ffd700');
                drawPixelRect(px + size * 0.47, crownY - size * 0.1, size * 0.08, size * 0.12, '#ffd700');
                drawPixelRect(px + size * 0.57, crownY - size * 0.08, size * 0.08, size * 0.1, '#ffd700');
            }
            
            // Arms
            const armSwing = agent.status === 'walking' ? Math.sin(agent.animTimer * 0.5) * 5 : 0;
            drawPixelRect(px + size * 0.15, py + size * 0.55 + bounce + armSwing, size * 0.15, size * 0.25, '#ffdbac');
            drawPixelRect(px + size * 0.7, py + size * 0.55 + bounce - armSwing, size * 0.15, size * 0.25, '#ffdbac');
            
            // Status indicator above head
            let statusColor = '#6b8e6b';
            if (agent.status === 'meeting') statusColor = '#d4a574';
            if (agent.status === 'walking') statusColor = '#87ceeb';
            
            ctx.fillStyle = statusColor;
            ctx.beginPath();
            ctx.arc(screenX, py - 5, 4, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // Draw desk
        function drawDesk(x, y, scale = 1) {
            const w = 60 * scale;
            const h = 40 * scale;
            
            // Desk top
            drawPixelRect(x - w/2, y - h/2, w, h, COLORS.desk);
            drawPixelRect(x - w/2 + 4, y - h/2 + 4, w - 8, h - 8, COLORS.deskDark);
            
            // Computer
            drawPixelRect(x - 8, y - h/2 - 10, 16, 12, '#333');
            drawPixelRect(x - 6, y - h/2 - 8, 12, 8, '#87ceeb');
            
            // Chair
            drawPixelRect(x - 12, y + h/2, 24, 20, COLORS.chair);
            drawPixelRect(x - 12, y + h/2, 24, 8, '#5a7a5a');
        }
        
        // Draw meeting table
        function drawMeetingTable(x, y, scale = 1) {
            const w = 120 * scale;
            const h = 80 * scale;
            
            // Table top
            drawPixelRect(x - w/2, y - h/2, w, h, COLORS.table);
            drawPixelRect(x - w/2 + 6, y - h/2 + 6, w - 12, h - 12, COLORS.accentDark);
            
            // Items on table
            drawPixelRect(x - 30, y - 10, 20, 15, '#fff'); // Paper
            drawPixelRect(x + 10, y - 5, 15, 10, '#8b4513'); // Coffee
        }
        
        // Draw ping pong table
        function drawPingPongTable(x, y, scale = 1) {
            const w = 100 * scale;
            const h = 60 * scale;
            
            // Table
            drawPixelRect(x - w/2, y - h/2, w, h, '#2e8b57');
            drawPixelRect(x - 2, y - h/2, 4, h, '#fff');
            
            // Net
            drawPixelRect(x - 2, y - h/2 - 10, 4, 10, '#333');
        }
        
        // Draw floor tile pattern
        function drawFloor() {
            const tileSize = 40;
            const cols = Math.ceil(canvas.width / tileSize) + 2;
            const rows = Math.ceil(canvas.height / tileSize) + 2;
            
            const startCol = Math.floor(-gameState.offsetX / tileSize / gameState.zoom) - 1;
            const startRow = Math.floor(-gameState.offsetY / tileSize / gameState.zoom) - 1;
            
            for (let r = startRow; r < startRow + rows; r++) {
                for (let c = startCol; c < startCol + cols; c++) {
                    const x = c * tileSize * gameState.zoom + gameState.offsetX;
                    const y = r * tileSize * gameState.zoom + gameState.offsetY;
                    const color = (c + r) % 2 === 0 ? COLORS.floor : COLORS.floorDark;
                    drawPixelRect(x, y, tileSize * gameState.zoom, tileSize * gameState.zoom, color);
                }
            }
        }
        
        // ============================================
        // GAME LOOP
        // ============================================
        
        function update() {
            // Update agents
            agents.forEach(agent => {
                agent.animTimer++;
                
                // Movement
                if (agent.targetX !== null && agent.targetY !== null) {
                    const dx = agent.targetX - agent.x;
                    const dy = agent.targetY - agent.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    
                    if (dist > 5) {
                        agent.status = 'walking';
                        const speed = 2;
                        agent.x += (dx / dist) * speed;
                        agent.y += (dy / dist) * speed;
                        
                        // Set direction
                        if (Math.abs(dx) > Math.abs(dy)) {
                            agent.direction = dx > 0 ? 'right' : 'left';
                        } else {
                            agent.direction = dy > 0 ? 'down' : 'up';
                        }
                    } else {
                        agent.x = agent.targetX;
                        agent.y = agent.targetY;
                        agent.status = agent.atMeeting ? 'meeting' : 'working';
                        agent.targetX = null;
                        agent.targetY = null;
                    }
                }
                
                // Random task changes
                if (Math.random() < 0.001 && agent.status === 'working') {
                    agent.currentTask = getRandomTask(agent.role);
                }
            });
        }
        
        function render() {
            // Clear canvas
            canvas.width = document.getElementById('canvas-container').clientWidth;
            canvas.height = document.getElementById('canvas-container').clientHeight;
            
            // Draw floor
            drawFloor();
            
            // Draw furniture
            agents.forEach(agent => {
                const screenX = agent.deskX * gameState.zoom + gameState.offsetX;
                const screenY = agent.deskY * gameState.zoom + gameState.offsetY;
                drawDesk(screenX, screenY, gameState.zoom);
            });
            
            // Draw meeting table
            const meetingX = gameState.meetingTablePos.x * gameState.zoom + gameState.offsetX;
            const meetingY = gameState.meetingTablePos.y * gameState.zoom + gameState.offsetY;
            drawMeetingTable(meetingX, meetingY, gameState.zoom);
            
            // Draw ping pong table
            const pingPongX = 700 * gameState.zoom + gameState.offsetX;
            const pingPongY = 200 * gameState.zoom + gameState.offsetY;
            drawPingPongTable(pingPongX, pingPongY, gameState.zoom);
            
            // Draw agents (sorted by Y for depth)
            const sortedAgents = [...agents].sort((a, b) => a.y - b.y);
            sortedAgents.forEach(agent => {
                const screenX = agent.x * gameState.zoom + gameState.offsetX;
                const screenY = agent.y * gameState.zoom + gameState.offsetY;
                drawAgentSprite(agent, screenX, screenY, gameState.zoom);
            });
        }
        
        function gameLoop() {
            update();
            render();
            requestAnimationFrame(gameLoop);
        }
        
        // ============================================
        // INTERACTION
        // ============================================
        
        // Mouse/Touch handling
        canvas.addEventListener('mousedown', (e) => {
            gameState.isDragging = true;
            gameState.lastMouseX = e.clientX;
            gameState.lastMouseY = e.clientY;
            
            // Check for agent click
            const rect = canvas.getBoundingClientRect();
            const clickX = (e.clientX - rect.left - gameState.offsetX) / gameState.zoom;
            const clickY = (e.clientY - rect.top - gameState.offsetY) / gameState.zoom;
            
            agents.forEach(agent => {
                const dist = Math.sqrt((clickX - agent.x) ** 2 + (clickY - agent.y) ** 2);
                if (dist < 30) {
                    showAgentDetails(agent, e.clientX, e.clientY);
                }
            });
        });
        
        canvas.addEventListener('mousemove', (e) => {
            if (gameState.isDragging) {
                const dx = e.clientX - gameState.lastMouseX;
                const dy = e.clientY - gameState.lastMouseY;
                gameState.offsetX += dx;
                gameState.offsetY += dy;
                gameState.lastMouseX = e.clientX;
                gameState.lastMouseY = e.clientY;
            }
        });
        
        canvas.addEventListener('mouseup', () => {
            gameState.isDragging = false;
        });
        
        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            const zoomSpeed = 0.1;
            const newZoom = gameState.zoom + (e.deltaY < 0 ? zoomSpeed : -zoomSpeed);
            gameState.zoom = Math.max(0.5, Math.min(3, newZoom));
        });
        
        // Zoom functions
        function zoomIn() {
            gameState.zoom = Math.min(3, gameState.zoom + 0.2);
        }
        
        function zoomOut() {
            gameState.zoom = Math.max(0.5, gameState.zoom - 0.2);
        }
        
        function resetZoom() {
            gameState.zoom = 1;
            gameState.offsetX = canvas.width / 2 - 400;
            gameState.offsetY = canvas.height / 2 - 250;
        }
        
        // Agent details popup
        function showAgentDetails(agent, x, y) {
            const details = document.getElementById('agent-details');
            document.getElementById('detail-name').textContent = agent.name;
            document.getElementById('detail-status').textContent = agent.status;
            document.getElementById('detail-role').textContent = agent.role;
            document.getElementById('detail-task').textContent = agent.currentTask;
            document.getElementById('detail-productivity').textContent = Math.round(agent.productivity) + '%';
            
            const statusDot = document.getElementById('detail-status-dot');
            statusDot.className = 'status-indicator status-' + agent.status;
            
            details.style.display = 'block';
            details.style.left = Math.min(x + 20, window.innerWidth - 250) + 'px';
            details.style.top = Math.min(y, window.innerHeight - 200) + 'px';
        }
        
        function closeAgentDetails() {
            document.getElementById('agent-details').style.display = 'none';
        }
        
        // ============================================
        // HIERARCHY TABLE UI
        // ============================================
        
        function showHierarchyTable() {
            const modal = document.getElementById('meeting-modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');
            
            title.textContent = 'üè¢ Agent Hierarchy';
            
            let html = `
                <div class="hierarchy-table" style="max-height: 60vh; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead>
                            <tr style="background: #8b7355; color: #f5e6c8;">
                                <th style="padding: 10px; text-align: left;">Role</th>
                                <th style="padding: 10px; text-align: left;">Agent</th>
                                <th style="padding: 10px; text-align: center;">Status</th>
                                <th style="padding: 10px; text-align: left;">Current Task</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Commander
            const commander = AGENT_HIERARCHY.commander;
            const commanderAgent = agents.find(a => a.id === commander.id) || {};
            html += `
                <tr style="background: rgba(255, 107, 107, 0.2); cursor: pointer;" onclick="centerOnAgent('${commander.id}')">
                    <td style="padding: 8px; border-bottom: 1px solid #4a4a4a;">üëë ${commander.role}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #4a4a4a; font-weight: bold;">${commander.name}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #4a4a4a; text-align: center;">
                        <span class="status-indicator status-${commanderAgent.status || 'active'}"></span>
                    </td>
                    <td style="padding: 8px; border-bottom: 1px solid #4a4a4a;">${commanderAgent.currentTask || 'Commanding'}</td>
                </tr>
            `;
            
            // AI Lead
            const aiLead = AGENT_HIERARCHY.aiLead;
            const aiLeadAgent = agents.find(a => a.id === aiLead.id) || {};
            html += `
                <tr style="background: rgba(107, 142, 107, 0.2); cursor: pointer;" onclick="centerOnAgent('${aiLead.id}')">
                    <td style="padding: 8px; border-bottom: 1px solid #4a4a4a;">ü§ñ ${aiLead.role}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #4a4a4a; font-weight: bold;">${aiLead.name}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #4a4a4a; text-align: center;">
                        <span class="status-indicator status-${aiLeadAgent.status || 'active'}"></span>
                    </td>
                    <td style="padding: 8px; border-bottom: 1px solid #4a4a4a;">${aiLeadAgent.currentTask || 'Coordinating'}</td>
                </tr>
            `;
            
            // Teams
            AGENT_HIERARCHY.teams.forEach((team, teamIndex) => {
                // Team header
                html += `
                    <tr style="background: #3d3d3d;">
                        <td colspan="4" style="padding: 8px; border-bottom: 1px solid #4a4a4a; color: #d4a574; font-weight: bold;">
                            üìÅ ${team.name}
                        </td>
                    </tr>
                `;
                
                // Team lead
                if (team.lead) {
                    const leadAgent = agents.find(a => a.id === team.lead.id) || {};
                    html += `
                        <tr style="background: rgba(212, 165, 116, 0.1); cursor: pointer;" onclick="centerOnAgent('${team.lead.id}')">
                            <td style="padding: 8px; padding-left: 20px; border-bottom: 1px solid #4a4a4a;">${team.lead.emoji} ${team.lead.role}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #4a4a4a;">${team.lead.name}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #4a4a4a; text-align: center;">
                                <span class="status-indicator status-${leadAgent.status || 'idle'}"></span>
                            </td>
                            <td style="padding: 8px; border-bottom: 1px solid #4a4a4a;">${leadAgent.currentTask || 'Leading'}</td>
                        </tr>
                    `;
                }
                
                // Team members
                if (team.members) {
                    team.members.forEach(member => {
                        const memberAgent = agents.find(a => a.id === member.id) || {};
                        html += `
                            <tr style="cursor: pointer;" onclick="centerOnAgent('${member.id}')">
                                <td style="padding: 8px; padding-left: 40px; border-bottom: 1px solid #4a4a4a;">${member.emoji} ${member.role}</td>
                                <td style="padding: 8px; border-bottom: 1px solid #4a4a4a;">${member.name}</td>
                                <td style="padding: 8px; border-bottom: 1px solid #4a4a4a; text-align: center;">
                                    <span class="status-indicator status-${memberAgent.status || 'idle'}"></span>
                                </td>
                                <td style="padding: 8px; border-bottom: 1px solid #4a4a4a;">${memberAgent.currentTask || 'Available'}</td>
                            </tr>
                        `;
                    });
                }
            });
            
            html += `
                        </tbody>
                    </table>
                    <p style="margin-top: 15px; font-size: 12px; opacity: 0.7; text-align: center;">
                        üí° Click on any agent to center the camera on them
                    </p>
                </div>
            `;
            
            body.innerHTML = html;
            modal.style.display = 'flex';
        }
        
        function centerOnAgent(agentId) {
            const agent = agents.find(a => a.id === agentId);
            if (agent) {
                const container = document.getElementById('canvas-container');
                gameState.offsetX = container.clientWidth / 2 - agent.x * gameState.zoom;
                gameState.offsetY = container.clientHeight / 2 - agent.y * gameState.zoom;
                closeMeetingModal();
                addActivity(`üîç Camera centered on ${agent.name}`);
            }
        }
        
        // ============================================
        // STANDUP FUNCTIONALITY
        // ============================================
        
        function callStandup() {
            if (gameState.standupActive) return;
            
            gameState.standupActive = true;
            addActivity('üì¢ Standup meeting called!');
            
            // Position agents around meeting table
            const tableX = gameState.meetingTablePos.x;
            const tableY = gameState.meetingTablePos.y;
            const radius = 100;
            
            agents.forEach((agent, index) => {
                const angle = (index / agents.length) * Math.PI * 2;
                agent.targetX = tableX + Math.cos(angle) * radius;
                agent.targetY = tableY + Math.sin(angle) * radius;
                agent.atMeeting = true;
            });
            
            // Generate meeting minutes after agents arrive
            setTimeout(() => {
                generateMeetingMinutes();
                addActivity('‚úÖ Standup complete! Meeting minutes generated.');
            }, 3000);
        }
        
        function generateMeetingMinutes() {
            const now = new Date();
            gameState.lastStandupTime = now;
            
            let minutes = `# Daily Standup - ${now.toLocaleDateString()} ${now.toLocaleTimeString()}\n\n`;
            minutes += `## Attendees (${agents.length} agents)\n\n`;
            
            agents.forEach(agent => {
                minutes += `### ${agent.name} (${agent.role})\n`;
                minutes += `- **Status:** ${agent.status}\n`;
                minutes += `- **Current Task:** ${agent.currentTask}\n`;
                minutes += `- **Productivity:** ${Math.round(agent.productivity)}%\n`;
                minutes += `- **Blockers:** ${Math.random() > 0.7 ? 'None' : 'Waiting on dependencies'}\n\n`;
            });
            
            minutes += `## Summary\n`;
            minutes += `- Total agents: ${agents.length}\n`;
            minutes += `- Average productivity: ${Math.round(agents.reduce((a, b) => a + b.productivity, 0) / agents.length)}%\n`;
            minutes += `- Meeting duration: ~5 minutes\n`;
            
            gameState.meetingMinutes = minutes;
            
            // Return agents to desks
            setTimeout(() => {
                agents.forEach(agent => {
                    agent.targetX = agent.deskX;
                    agent.targetY = agent.deskY;
                    agent.atMeeting = false;
                });
                gameState.standupActive = false;
            }, 2000);
            
            return minutes;
        }
        
        function generateMinutes() {
            if (!gameState.meetingMinutes) {
                showModal('Meeting Minutes', 'No standup meeting has been held yet. Click "Call Standup" first!');
                return;
            }
            showModal('Meeting Minutes', `<pre>${gameState.meetingMinutes}</pre>`);
        }
        
        // ============================================
        // NEXUS REVIEW & IMPROVEMENTS
        // ============================================
        
        function reviewImprovements() {
            if (!gameState.meetingMinutes) {
                showModal('Nexus Review', 'No meeting minutes available. Please run a standup first!');
                return;
            }
            
            // Generate improvement suggestions based on meeting data
            const improvements = generateImprovements();
            
            let content = `<h3>ü§ñ Nexus Analysis Complete</h3>`;
            content += `<p>Based on the standup meeting, here are the improvement suggestions:</p>`;
            content += `<pre>${improvements}</pre>`;
            content += `<button class="btn btn-primary" onclick="saveImprovementsToTasks()">üíæ Save to PENDING_TASKS.md</button>`;
            
            showModal('Nexus Review - Improvement Suggestions', content);
            
            // Store for saving
            window.currentImprovements = improvements;
        }
        
        function generateImprovements() {
            const suggestions = [];
            
            // Analyze agent productivity
            const lowProductivity = agents.filter(a => a.productivity < 80);
            if (lowProductivity.length > 0) {
                suggestions.push(`- Consider pairing ${lowProductivity.map(a => a.name).join(', ')} with high-performers for mentorship`);
            }
            
            // Check for similar tasks
            const tasks = agents.map(a => a.currentTask);
            const uniqueTasks = [...new Set(tasks)];
            if (uniqueTasks.length < tasks.length / 2) {
                suggestions.push(`- Multiple agents working on similar tasks - consider task consolidation`);
            }
            
            // General improvements
            suggestions.push(`- Schedule code review sessions to improve code quality`);
            suggestions.push(`- Set up automated testing to reduce QA bottleneck`);
            suggestions.push(`- Document architectural decisions in the wiki`);
            
            // Role-specific suggestions
            const hasDocs = agents.some(a => a.role === 'Documentation');
            if (!hasDocs) {
                suggestions.push(`- Consider assigning a documentation specialist`);
            }
            
            return suggestions.join('\n');
        }
        
        function saveImprovementsToTasks() {
            const improvements = window.currentImprovements || '';
            const timestamp = new Date().toISOString();
            
            const taskContent = `
## Improvement Tasks - Generated ${timestamp}

${improvements}

### Action Items
${improvements.split('\n').map(line => {
    const task = line.replace(/^- /, '');
    return `- [ ] ${task}`;
}).join('\n')}

---
`;
            
            // Save to file via API (in a real implementation)
            // For now, we'll create a download
            const blob = new Blob([taskContent], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'PENDING_TASKS.md';
            a.click();
            URL.revokeObjectURL(url);
            
            addActivity('üíæ Improvements saved to PENDING_TASKS.md');
            closeMeetingModal();
        }
        
        // ============================================
        // UI HELPERS
        // ============================================
        
        function addActivity(message) {
            const feed = document.getElementById('activity-feed');
            const time = new Date().toLocaleTimeString();
            const item = document.createElement('div');
            item.className = 'activity-item';
            item.innerHTML = `<span class="activity-time">[${time}]</span> ${message}`;
            feed.insertBefore(item, feed.firstChild);
            
            // Keep only last 50 items
            while (feed.children.length > 50) {
                feed.removeChild(feed.lastChild);
            }
        }
        
        function updateAgentList() {
            document.getElementById('agent-count').textContent = agents.length;
            const list = document.getElementById('agent-list');
            list.innerHTML = agents.map(a => 
                `<div><span class="status-indicator status-${a.status}"></span>${a.name} - ${a.role}</div>`
            ).join('');
        }
        
        function showModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').innerHTML = content;
            document.getElementById('meeting-modal').style.display = 'flex';
        }
        
        function closeMeetingModal() {
            document.getElementById('meeting-modal').style.display = 'none';
        }
        
        // Close modal on outside click
        document.getElementById('meeting-modal').addEventListener('click', (e) => {
            if (e.target.id === 'meeting-modal') {
                closeMeetingModal();
            }
        });
        
        // ============================================
        // INITIALIZATION
        // ============================================
        
        function init() {
            initAgents();
            resetZoom();
            gameLoop();
            
            // Initial activity
            addActivity('üè¢ Pixel Office initialized!');
            addActivity(`üë• ${agents.length} agents ready for work`);
            addActivity('üí° Click "Call Standup" to begin the day');
            
            // Periodic updates
            setInterval(() => {
                updateAgentList();
            }, 1000);
        }
        
        // Start the game
        init();

        // Auto-refresh every 30 minutes
        setInterval(() => {
            location.reload();
        }, 30 * 60 * 1000);
    </script>
</body>
</html>
